[{
  "title": "First Time Seen Remote Named Pipe",
  "id": "52d8b0c6-53d6-439a-9e41-52ad442ad9ad",
  "description": "This detection excludes known namped pipes accessible remotely and notify on newly observed ones, may help to detect lateral movement and remote exec using named pipes",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND ((EventID=5145 AND ShareName LIKE '\\\\\\\\*\\\\IPC$' ESCAPE '\\') AND (NOT (RelativeTargetName='atsvc' OR RelativeTargetName='samr' OR RelativeTargetName='lsarpc' OR RelativeTargetName='lsass' OR RelativeTargetName='winreg' OR RelativeTargetName='netlogon' OR RelativeTargetName='srvsvc' OR RelativeTargetName LIKE 'protected\\_storage' ESCAPE '\\' OR RelativeTargetName='wkssvc' OR RelativeTargetName='browser' OR RelativeTargetName='netdfs' OR RelativeTargetName='svcctl' OR RelativeTargetName='spoolss' OR RelativeTargetName='ntsvcs' OR RelativeTargetName LIKE 'LSM\\_API\\_service' ESCAPE '\\' OR RelativeTargetName='HydraLsPipe' OR RelativeTargetName LIKE 'TermSrv\\_API\\_service' ESCAPE '\\' OR RelativeTargetName='MsFteWds' OR RelativeTargetName LIKE 'sql\\\\query' ESCAPE '\\' OR RelativeTargetName='eventlog')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.lateral-movement",
    "attack.t1021.002"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 3,
      "AccessList": "%%4416\r\n\t\t\t\t%%4417",
      "AccessMask": "0x3",
      "AccessReason": "-",
      "Channel": "Security",
      "Computer": "MSEDGEWIN10",
      "EventID": 5145,
      "EventRecordID": 321447,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "IpAddress": "127.0.0.1",
      "IpPort": "49925",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectType": "File",
      "Opcode": 0,
      "OriginalLogfile": "ImpersonateUser-via local Pass The Hash Sysmon and Security.evtx",
      "ProcessID": 4,
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RelativeTargetName": "samir",
      "ShareName": "\\\\*\\IPC$",
      "SubjectDomainName": "MSEDGEWIN10",
      "SubjectLogonId": "0x770575",
      "SubjectUserName": "user03",
      "SubjectUserSid": "S-1-5-21-3461203602-4096304019-2269080069-1010",
      "SystemTime": "2021-04-20T20:33:00.305351Z",
      "Task": 12811,
      "ThreadID": 5548,
      "Version": 0
    }
  ]
},
{
  "title": "Uncommon Svchost Parent Process",
  "id": "01d2e2a1-5f09-44f7-9fc1-24faa7479b6d",
  "description": "Detects an uncommon svchost parent process",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (Image LIKE '%\\\\svchost.exe' ESCAPE '\\' AND (NOT ((ParentImage LIKE '%\\\\Mrt.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\MsMpEng.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\ngen.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\rpcnet.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\services.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\TiWorker.exe' ESCAPE '\\') OR ParentImage IS NULL OR (ParentImage='-' OR ParentImage='')))))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.defense-evasion",
    "attack.t1036.005"
  ],
  "count": 2,
  "matches": [
    {
      "row_id": 8,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "C:\\Windows\\system32\\svchost.exe -k netsvcs -p -s gpsvc",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Host Process for Windows Services",
      "EventID": 1,
      "EventRecordID": 578503,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=A1385CE20AD79F55DF235EFFD9780C31442AA234,MD5=8A0A29438052FAED8A2532DA50455756,SHA256=7FD065BAC18C5278777AE44908101CDFED72D26FA741367F0AD4D02020787AB6,IMPHASH=247B9220E5D9B720A82B2C8B5069AD69",
      "IMPHASH": "247B9220E5D9B720A82B2C8B5069AD69",
      "Image": "C:\\Windows\\System32\\svchost.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-82AE-607F-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "8A0A29438052FAED8A2532DA50455756",
      "Opcode": 0,
      "OriginalFileName": "svchost.exe",
      "OriginalLogfile": "ImpersonateUser-via local Pass The Hash Sysmon and Security.evtx",
      "ParentCommandLine": "?",
      "ParentImage": "?",
      "ParentProcessGuid": "00000000-0000-0000-0000-000000000000",
      "ParentProcessId": 612,
      "ProcessGuid": "747F3D96-3A89-607F-0000-001028587700",
      "ProcessID": 3392,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "A1385CE20AD79F55DF235EFFD9780C31442AA234",
      "SHA256": "7FD065BAC18C5278777AE44908101CDFED72D26FA741367F0AD4D02020787AB6",
      "SystemTime": "2021-04-20T20:33:13.741579Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 4112,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2021-04-20 20:33:13.680",
      "Version": 5
    },
    {
      "row_id": 9,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "C:\\Windows\\system32\\svchost.exe -k LocalService -p -s fdPHost",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Host Process for Windows Services",
      "EventID": 1,
      "EventRecordID": 578505,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=A1385CE20AD79F55DF235EFFD9780C31442AA234,MD5=8A0A29438052FAED8A2532DA50455756,SHA256=7FD065BAC18C5278777AE44908101CDFED72D26FA741367F0AD4D02020787AB6,IMPHASH=247B9220E5D9B720A82B2C8B5069AD69",
      "IMPHASH": "247B9220E5D9B720A82B2C8B5069AD69",
      "Image": "C:\\Windows\\System32\\svchost.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-82AF-607F-0000-0020E5030000",
      "LogonId": "0x3e5",
      "MD5": "8A0A29438052FAED8A2532DA50455756",
      "Opcode": 0,
      "OriginalFileName": "svchost.exe",
      "OriginalLogfile": "ImpersonateUser-via local Pass The Hash Sysmon and Security.evtx",
      "ParentCommandLine": "?",
      "ParentImage": "?",
      "ParentProcessGuid": "00000000-0000-0000-0000-000000000000",
      "ParentProcessId": 612,
      "ProcessGuid": "747F3D96-3A8A-607F-0000-0010E4717700",
      "ProcessID": 3392,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "A1385CE20AD79F55DF235EFFD9780C31442AA234",
      "SHA256": "7FD065BAC18C5278777AE44908101CDFED72D26FA741367F0AD4D02020787AB6",
      "SystemTime": "2021-04-20T20:33:14.273416Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 4112,
      "User": "NT AUTHORITY\\LOCAL SERVICE",
      "UserID": "S-1-5-18",
      "UtcTime": "2021-04-20 20:33:14.246",
      "Version": 5
    }
  ]
},
{
  "title": "Pass the Hash Activity 2",
  "id": "8eef149c-bd26-49f2-9e5a-9b00e3af499b",
  "description": "Detects the attack technique pass the hash which is used to move laterally inside the network",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND (((EventID=4624 AND SubjectUserSid='S-1-0-0' AND LogonType=3 AND LogonProcessName='NtLmSsp' AND KeyLength=0) OR (EventID=4624 AND LogonType=9 AND LogonProcessName='seclogo')) AND (NOT TargetUserName='ANONYMOUS LOGON'))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.defense-evasion",
    "attack.lateral-movement",
    "attack.t1550.002"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "ActivityID": "4EBA70C4-364F-0000-5771-BA4E4F36D701",
      "AuthenticationPackageName": "NTLM",
      "Channel": "Security",
      "Computer": "MSEDGEWIN10",
      "ElevatedToken": "%%1843",
      "EventID": 4624,
      "EventRecordID": 321446,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "ImpersonationLevel": "%%1833",
      "IpAddress": "127.0.0.1",
      "IpPort": "49925",
      "KeyLength": 0,
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "LmPackageName": "NTLM V2",
      "LogonGuid": "00000000-0000-0000-0000-000000000000",
      "LogonProcessName": "NtLmSsp",
      "LogonType": 3,
      "Opcode": 0,
      "OriginalLogfile": "ImpersonateUser-via local Pass The Hash Sysmon and Security.evtx",
      "ProcessID": 644,
      "ProcessName": "-",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RestrictedAdminMode": "-",
      "SubjectDomainName": "-",
      "SubjectLogonId": "0x0",
      "SubjectUserName": "-",
      "SubjectUserSid": "S-1-0-0",
      "SystemTime": "2021-04-20T20:33:00.296686Z",
      "TargetDomainName": "MSEDGEWIN10",
      "TargetLinkedLogonId": "0x0",
      "TargetLogonId": "0x770575",
      "TargetOutboundDomainName": "-",
      "TargetOutboundUserName": "-",
      "TargetUserName": "user03",
      "TargetUserSid": "S-1-5-21-3461203602-4096304019-2269080069-1010",
      "Task": 12544,
      "ThreadID": 696,
      "TransmittedServices": "-",
      "Version": 2,
      "VirtualAccount": "%%1843",
      "WorkstationName": "MSEDGEWIN10"
    }
  ]
},
{
  "title": "Windows Processes Suspicious Parent Directory",
  "id": "96036718-71cc-4027-a538-d1587e0006a7",
  "description": "Detect suspicious parent processes of well-known Windows processes",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((Image LIKE '%\\\\svchost.exe' ESCAPE '\\' OR Image LIKE '%\\\\taskhost.exe' ESCAPE '\\' OR Image LIKE '%\\\\lsm.exe' ESCAPE '\\' OR Image LIKE '%\\\\lsass.exe' ESCAPE '\\' OR Image LIKE '%\\\\services.exe' ESCAPE '\\' OR Image LIKE '%\\\\lsaiso.exe' ESCAPE '\\' OR Image LIKE '%\\\\csrss.exe' ESCAPE '\\' OR Image LIKE '%\\\\wininit.exe' ESCAPE '\\' OR Image LIKE '%\\\\winlogon.exe' ESCAPE '\\') AND (NOT (((ParentImage LIKE '%\\\\SavService.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\ngen.exe' ESCAPE '\\') OR (ParentImage LIKE '%\\\\System32\\\\%' ESCAPE '\\' OR ParentImage LIKE '%\\\\SysWOW64\\\\%' ESCAPE '\\')) OR ((ParentImage LIKE '%\\\\Windows Defender\\\\%' ESCAPE '\\' OR ParentImage LIKE '%\\\\Microsoft Security Client\\\\%' ESCAPE '\\') AND ParentImage LIKE '%\\\\MsMpEng.exe' ESCAPE '\\') OR (ParentImage IS NULL OR (ParentImage='' OR ParentImage='-'))))))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.defense-evasion",
    "attack.t1036.003",
    "attack.t1036.005"
  ],
  "count": 2,
  "matches": [
    {
      "row_id": 8,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "C:\\Windows\\system32\\svchost.exe -k netsvcs -p -s gpsvc",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Host Process for Windows Services",
      "EventID": 1,
      "EventRecordID": 578503,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=A1385CE20AD79F55DF235EFFD9780C31442AA234,MD5=8A0A29438052FAED8A2532DA50455756,SHA256=7FD065BAC18C5278777AE44908101CDFED72D26FA741367F0AD4D02020787AB6,IMPHASH=247B9220E5D9B720A82B2C8B5069AD69",
      "IMPHASH": "247B9220E5D9B720A82B2C8B5069AD69",
      "Image": "C:\\Windows\\System32\\svchost.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-82AE-607F-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "8A0A29438052FAED8A2532DA50455756",
      "Opcode": 0,
      "OriginalFileName": "svchost.exe",
      "OriginalLogfile": "ImpersonateUser-via local Pass The Hash Sysmon and Security.evtx",
      "ParentCommandLine": "?",
      "ParentImage": "?",
      "ParentProcessGuid": "00000000-0000-0000-0000-000000000000",
      "ParentProcessId": 612,
      "ProcessGuid": "747F3D96-3A89-607F-0000-001028587700",
      "ProcessID": 3392,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "A1385CE20AD79F55DF235EFFD9780C31442AA234",
      "SHA256": "7FD065BAC18C5278777AE44908101CDFED72D26FA741367F0AD4D02020787AB6",
      "SystemTime": "2021-04-20T20:33:13.741579Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 4112,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2021-04-20 20:33:13.680",
      "Version": 5
    },
    {
      "row_id": 9,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "C:\\Windows\\system32\\svchost.exe -k LocalService -p -s fdPHost",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Host Process for Windows Services",
      "EventID": 1,
      "EventRecordID": 578505,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=A1385CE20AD79F55DF235EFFD9780C31442AA234,MD5=8A0A29438052FAED8A2532DA50455756,SHA256=7FD065BAC18C5278777AE44908101CDFED72D26FA741367F0AD4D02020787AB6,IMPHASH=247B9220E5D9B720A82B2C8B5069AD69",
      "IMPHASH": "247B9220E5D9B720A82B2C8B5069AD69",
      "Image": "C:\\Windows\\System32\\svchost.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-82AF-607F-0000-0020E5030000",
      "LogonId": "0x3e5",
      "MD5": "8A0A29438052FAED8A2532DA50455756",
      "Opcode": 0,
      "OriginalFileName": "svchost.exe",
      "OriginalLogfile": "ImpersonateUser-via local Pass The Hash Sysmon and Security.evtx",
      "ParentCommandLine": "?",
      "ParentImage": "?",
      "ParentProcessGuid": "00000000-0000-0000-0000-000000000000",
      "ParentProcessId": 612,
      "ProcessGuid": "747F3D96-3A8A-607F-0000-0010E4717700",
      "ProcessID": 3392,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "A1385CE20AD79F55DF235EFFD9780C31442AA234",
      "SHA256": "7FD065BAC18C5278777AE44908101CDFED72D26FA741367F0AD4D02020787AB6",
      "SystemTime": "2021-04-20T20:33:14.273416Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 4112,
      "User": "NT AUTHORITY\\LOCAL SERVICE",
      "UserID": "S-1-5-18",
      "UtcTime": "2021-04-20 20:33:14.246",
      "Version": 5
    }
  ]
},
{
  "title": "Non Interactive PowerShell Process Spawned",
  "id": "f4bbd493-b796-416e-bbf2-121235348529",
  "description": "Detects non-interactive PowerShell activity by looking at the \"powershell\" process with a non-user GUI process such as \"explorer.exe\" as a parent.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (((Image LIKE '%\\\\powershell.exe' ESCAPE '\\' OR Image LIKE '%\\\\pwsh.exe' ESCAPE '\\') OR (OriginalFileName='PowerShell.EXE' OR OriginalFileName='pwsh.dll')) AND (NOT ((ParentImage LIKE '%:\\\\Windows\\\\explorer.exe' ESCAPE '\\' OR ParentImage LIKE '%:\\\\Windows\\\\System32\\\\CompatTelRunner.exe' ESCAPE '\\' OR ParentImage LIKE '%:\\\\Windows\\\\SysWOW64\\\\explorer.exe' ESCAPE '\\') OR ParentImage LIKE ':\\\\$WINDOWS.~BT\\\\Sources\\\\SetupHost.exe' ESCAPE '\\')) AND (NOT ((ParentImage LIKE '%\\\\AppData\\\\Local\\\\Programs\\\\Microsoft VS Code\\\\Code.exe' ESCAPE '\\' AND ParentCommandLine LIKE '% --ms-enable-electron-run-as-node %' ESCAPE '\\') OR (ParentImage LIKE '%:\\\\Program Files\\\\WindowsApps\\\\Microsoft.WindowsTerminal\\_%' ESCAPE '\\' AND ParentImage LIKE '%\\\\WindowsTerminal.exe' ESCAPE '\\')))))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.execution",
    "attack.t1059.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\" -Version 5.1 -s -NoLogo -NoProfile",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows PowerShell",
      "EventID": 1,
      "EventRecordID": 578497,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=6CBCE4A295C163791B60FC23D285E6D84F28EE4C,MD5=7353F60B1739074EB17C5F4DDDEFE239,SHA256=DE96A6E69944335375DC1AC238336066889D9FFC7D73628EF4FE1B1B160AB32C,IMPHASH=741776AACCFC5B71FF59832DCDCACE0F",
      "IMPHASH": "741776AACCFC5B71FF59832DCDCACE0F",
      "Image": "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
      "IntegrityLevel": "High",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-0433-607F-0000-002073600700",
      "LogonId": "0x76073",
      "MD5": "7353F60B1739074EB17C5F4DDDEFE239",
      "Opcode": 0,
      "OriginalFileName": "PowerShell.EXE",
      "OriginalLogfile": "ImpersonateUser-via local Pass The Hash Sysmon and Security.evtx",
      "ParentCommandLine": "\"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\"",
      "ParentImage": "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
      "ParentProcessGuid": "747F3D96-04C3-607F-0000-0010F13B1E00",
      "ParentProcessId": 2532,
      "ProcessGuid": "747F3D96-3A77-607F-0000-00105DD17600",
      "ProcessID": 3392,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "6CBCE4A295C163791B60FC23D285E6D84F28EE4C",
      "SHA256": "DE96A6E69944335375DC1AC238336066889D9FFC7D73628EF4FE1B1B160AB32C",
      "SystemTime": "2021-04-20T20:32:55.368823Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 4112,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2021-04-20 20:32:55.351",
      "Version": 5
    }
  ]
}]