[{
  "title": "Suspicious Process Parents",
  "id": "cbec226f-63d9-4eca-9f52-dfb6652f24df",
  "description": "Detects suspicious parent processes that should not have any children or should only have a single possible child program",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((ParentImage LIKE '%\\\\minesweeper.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\winver.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\bitsadmin.exe' ESCAPE '\\') OR ((ParentImage LIKE '%\\\\csrss.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\certutil.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\eventvwr.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\calc.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\notepad.exe' ESCAPE '\\') AND (NOT ((Image LIKE '%\\\\WerFault.exe' ESCAPE '\\' OR Image LIKE '%\\\\wermgr.exe' ESCAPE '\\' OR Image LIKE '%\\\\conhost.exe' ESCAPE '\\' OR Image LIKE '%\\\\mmc.exe' ESCAPE '\\' OR Image LIKE '%\\\\win32calc.exe' ESCAPE '\\' OR Image LIKE '%\\\\notepad.exe' ESCAPE '\\') OR Image IS NULL)))))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.t1036"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 11,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "rundll32.exe",
      "Company": "Microsoft Corporation",
      "Computer": "IEWIN7",
      "CurrentDirectory": "C:\\Users\\IEUser\\",
      "Description": "Windows host process (Rundll32)",
      "EventID": 1,
      "EventRecordID": 8352,
      "FileVersion": "6.1.7600.16385 (win7_rtm.090713-1255)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=892503B20247B341CFD20DDA5FDACFA41527A087,MD5=C648901695E275C8F2AD04B687A68CE2,SHA256=3FA4912EB43FC304652D7B01F118589259861E2D628FA7C86193E54D5F987670,IMPHASH=239D911DFA7551A8B735680BC39B2238",
      "IMPHASH": "239D911DFA7551A8B735680BC39B2238",
      "Image": "C:\\Windows\\System32\\rundll32.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "365ABB72-0A6F-5D1D-0000-0020CA350100",
      "LogonId": "0x135ca",
      "MD5": "C648901695E275C8F2AD04B687A68CE2",
      "Opcode": 0,
      "OriginalLogfile": "Sysmon_meterpreter_ReflectivePEInjection_to_notepad_.evtx",
      "ParentCommandLine": "\"C:\\Windows\\system32\\notepad.exe\"",
      "ParentImage": "C:\\Windows\\System32\\notepad.exe",
      "ParentProcessGuid": "365ABB72-1256-5D1D-0000-0010FB1A1B00",
      "ParentProcessId": 1632,
      "ProcessGuid": "365ABB72-1282-5D1D-0000-0010DD401B00",
      "ProcessID": 112,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "892503B20247B341CFD20DDA5FDACFA41527A087",
      "SHA256": "3FA4912EB43FC304652D7B01F118589259861E2D628FA7C86193E54D5F987670",
      "SystemTime": "2019-07-03T20:39:30.254733Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 2084,
      "User": "IEWIN7\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-07-03 20:39:30.254",
      "Version": 5
    }
  ]
},
{
  "title": "Rundll32 Execution Without Parameters",
  "id": "5bb68627-3198-40ca-b458-49f973db8752",
  "description": "Detects rundll32 execution without parameters as observed when running Metasploit windows/smb/psexec exploit module",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (CommandLine='rundll32.exe' OR CommandLine='rundll32'))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.lateral-movement",
    "attack.t1021.002",
    "attack.t1570",
    "attack.execution",
    "attack.t1569.002"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 11,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "rundll32.exe",
      "Company": "Microsoft Corporation",
      "Computer": "IEWIN7",
      "CurrentDirectory": "C:\\Users\\IEUser\\",
      "Description": "Windows host process (Rundll32)",
      "EventID": 1,
      "EventRecordID": 8352,
      "FileVersion": "6.1.7600.16385 (win7_rtm.090713-1255)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=892503B20247B341CFD20DDA5FDACFA41527A087,MD5=C648901695E275C8F2AD04B687A68CE2,SHA256=3FA4912EB43FC304652D7B01F118589259861E2D628FA7C86193E54D5F987670,IMPHASH=239D911DFA7551A8B735680BC39B2238",
      "IMPHASH": "239D911DFA7551A8B735680BC39B2238",
      "Image": "C:\\Windows\\System32\\rundll32.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "365ABB72-0A6F-5D1D-0000-0020CA350100",
      "LogonId": "0x135ca",
      "MD5": "C648901695E275C8F2AD04B687A68CE2",
      "Opcode": 0,
      "OriginalLogfile": "Sysmon_meterpreter_ReflectivePEInjection_to_notepad_.evtx",
      "ParentCommandLine": "\"C:\\Windows\\system32\\notepad.exe\"",
      "ParentImage": "C:\\Windows\\System32\\notepad.exe",
      "ParentProcessGuid": "365ABB72-1256-5D1D-0000-0010FB1A1B00",
      "ParentProcessId": 1632,
      "ProcessGuid": "365ABB72-1282-5D1D-0000-0010DD401B00",
      "ProcessID": 112,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "892503B20247B341CFD20DDA5FDACFA41527A087",
      "SHA256": "3FA4912EB43FC304652D7B01F118589259861E2D628FA7C86193E54D5F987670",
      "SystemTime": "2019-07-03T20:39:30.254733Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 2084,
      "User": "IEWIN7\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-07-03 20:39:30.254",
      "Version": 5
    }
  ]
},
{
  "title": "Bad Opsec Defaults Sacrificial Processes With Improper Arguments",
  "id": "a7c3d773-caef-227e-a7e7-c2f13c622329",
  "description": "Detects attackers using tooling with bad opsec defaults.\nE.g. spawning a sacrificial process to inject a capability into the process without taking into account how the process is normally run.\nOne trivial example of this is using rundll32.exe without arguments as a sacrificial process (default in CS, now highlighted by c2lint), running WerFault without arguments (Kraken - credit am0nsec), and other examples.\n",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (((Image LIKE '%\\\\WerFault.exe' ESCAPE '\\' AND CommandLine LIKE '%WerFault.exe' ESCAPE '\\') OR (Image LIKE '%\\\\rundll32.exe' ESCAPE '\\' AND CommandLine LIKE '%rundll32.exe' ESCAPE '\\') OR (Image LIKE '%\\\\regsvcs.exe' ESCAPE '\\' AND CommandLine LIKE '%regsvcs.exe' ESCAPE '\\') OR (Image LIKE '%\\\\regasm.exe' ESCAPE '\\' AND CommandLine LIKE '%regasm.exe' ESCAPE '\\') OR (Image LIKE '%\\\\regsvr32.exe' ESCAPE '\\' AND CommandLine LIKE '%regsvr32.exe' ESCAPE '\\')) AND (NOT ((ParentImage LIKE '%\\\\AppData\\\\Local\\\\Microsoft\\\\EdgeUpdate\\\\Install\\\\{%' ESCAPE '\\' AND Image LIKE '%\\\\rundll32.exe' ESCAPE '\\' AND CommandLine LIKE '%rundll32.exe' ESCAPE '\\') OR ((ParentImage LIKE '%\\\\AppData\\\\Local\\\\BraveSoftware\\\\Brave-Browser\\\\Application\\\\%' ESCAPE '\\' OR ParentImage LIKE '%\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\%' ESCAPE '\\') AND ParentImage LIKE '%\\\\Installer\\\\setup.exe' ESCAPE '\\' AND ParentCommandLine LIKE '%--uninstall %' ESCAPE '\\' AND Image LIKE '%\\\\rundll32.exe' ESCAPE '\\' AND CommandLine LIKE '%rundll32.exe' ESCAPE '\\')))))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.t1218.011"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 11,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "rundll32.exe",
      "Company": "Microsoft Corporation",
      "Computer": "IEWIN7",
      "CurrentDirectory": "C:\\Users\\IEUser\\",
      "Description": "Windows host process (Rundll32)",
      "EventID": 1,
      "EventRecordID": 8352,
      "FileVersion": "6.1.7600.16385 (win7_rtm.090713-1255)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=892503B20247B341CFD20DDA5FDACFA41527A087,MD5=C648901695E275C8F2AD04B687A68CE2,SHA256=3FA4912EB43FC304652D7B01F118589259861E2D628FA7C86193E54D5F987670,IMPHASH=239D911DFA7551A8B735680BC39B2238",
      "IMPHASH": "239D911DFA7551A8B735680BC39B2238",
      "Image": "C:\\Windows\\System32\\rundll32.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "365ABB72-0A6F-5D1D-0000-0020CA350100",
      "LogonId": "0x135ca",
      "MD5": "C648901695E275C8F2AD04B687A68CE2",
      "Opcode": 0,
      "OriginalLogfile": "Sysmon_meterpreter_ReflectivePEInjection_to_notepad_.evtx",
      "ParentCommandLine": "\"C:\\Windows\\system32\\notepad.exe\"",
      "ParentImage": "C:\\Windows\\System32\\notepad.exe",
      "ParentProcessGuid": "365ABB72-1256-5D1D-0000-0010FB1A1B00",
      "ParentProcessId": 1632,
      "ProcessGuid": "365ABB72-1282-5D1D-0000-0010DD401B00",
      "ProcessID": 112,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "892503B20247B341CFD20DDA5FDACFA41527A087",
      "SHA256": "3FA4912EB43FC304652D7B01F118589259861E2D628FA7C86193E54D5F987670",
      "SystemTime": "2019-07-03T20:39:30.254733Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 2084,
      "User": "IEWIN7\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-07-03 20:39:30.254",
      "Version": 5
    }
  ]
}]