[{
  "title": "Potentially Suspicious AccessMask Requested From LSASS",
  "id": "4a1b6da0-d94f-4fc3-98fc-2d9cb9e5ee76",
  "description": "Detects process handle on LSASS process with certain access mask",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND (((EventID=4656 AND ObjectName LIKE '%\\\\lsass.exe' ESCAPE '\\' AND (AccessMask LIKE '%0x40%' ESCAPE '\\' OR AccessMask LIKE '%0x1400%' ESCAPE '\\' OR AccessMask LIKE '%0x100000%' ESCAPE '\\' OR AccessMask LIKE '%0x1410%' ESCAPE '\\' OR AccessMask LIKE '%0x1010%' ESCAPE '\\' OR AccessMask LIKE '%0x1438%' ESCAPE '\\' OR AccessMask LIKE '%0x143a%' ESCAPE '\\' OR AccessMask LIKE '%0x1418%' ESCAPE '\\' OR AccessMask LIKE '%0x1f0fff%' ESCAPE '\\' OR AccessMask LIKE '%0x1f1fff%' ESCAPE '\\' OR AccessMask LIKE '%0x1f2fff%' ESCAPE '\\' OR AccessMask LIKE '%0x1f3fff%' ESCAPE '\\')) OR (EventID=4663 AND ObjectName LIKE '%\\\\lsass.exe' ESCAPE '\\' AND (AccessList LIKE '%4484%' ESCAPE '\\' OR AccessList LIKE '%4416%' ESCAPE '\\'))) AND (NOT (((ProcessName LIKE '%\\\\csrss.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\GamingServices.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\lsm.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\MicrosoftEdgeUpdate.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\minionhost.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\MRT.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\MsMpEng.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\perfmon.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\procexp.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\procexp64.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\svchost.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\taskmgr.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\thor.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\thor64.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\vmtoolsd.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\VsTskMgr.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\wininit.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\wmiprvse.exe' ESCAPE '\\' OR ProcessName LIKE '%RtkAudUService64' ESCAPE '\\') AND (ProcessName LIKE '%:\\\\Program Files (x86)\\\\%' ESCAPE '\\' OR ProcessName LIKE '%:\\\\Program Files\\\\%' ESCAPE '\\' OR ProcessName LIKE '%:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\%' ESCAPE '\\' OR ProcessName LIKE '%:\\\\Windows\\\\SysNative\\\\%' ESCAPE '\\' OR ProcessName LIKE '%:\\\\Windows\\\\System32\\\\%' ESCAPE '\\' OR ProcessName LIKE '%:\\\\Windows\\\\SysWow64\\\\%' ESCAPE '\\' OR ProcessName LIKE '%:\\\\Windows\\\\Temp\\\\asgard2-agent\\\\%' ESCAPE '\\')) OR ProcessName LIKE '%:\\\\Program Files%' ESCAPE '\\' OR (ProcessName LIKE '%:\\\\Windows\\\\System32\\\\taskhostw.exe' ESCAPE '\\' OR ProcessName LIKE '%:\\\\Windows\\\\System32\\\\msiexec.exe' ESCAPE '\\' OR ProcessName LIKE '%:\\\\Windows\\\\CCM\\\\CcmExec.exe' ESCAPE '\\') OR (ProcessName LIKE '%:\\\\Windows\\\\Sysmon64.exe' ESCAPE '\\' AND AccessList LIKE '%\\%\\%4484%' ESCAPE '\\') OR (ProcessName LIKE '%:\\\\Windows\\\\Temp\\\\asgard2-agent-sc\\\\aurora\\\\%' ESCAPE '\\' AND ProcessName LIKE '%\\\\aurora-agent-64.exe' ESCAPE '\\' AND AccessList LIKE '%\\%\\%4484%' ESCAPE '\\') OR (ProcessName LIKE '%\\\\x64\\\\SCENARIOENGINE.EXE' ESCAPE '\\' AND AccessList LIKE '%\\%\\%4484%' ESCAPE '\\') OR ((ProcessName LIKE '%:\\\\Users\\\\%' ESCAPE '\\' AND ProcessName LIKE '%\\\\AppData\\\\Local\\\\Temp\\\\is-%' ESCAPE '\\') AND ProcessName LIKE '%\\\\avira\\_system\\_speedup.tmp' ESCAPE '\\' AND AccessList LIKE '%\\%\\%4484%' ESCAPE '\\') OR (ProcessName LIKE '%:\\\\Windows\\\\Temp\\\\%' ESCAPE '\\' AND ProcessName LIKE '%\\\\avira\\_speedup\\_setup\\_update.tmp' ESCAPE '\\' AND AccessList LIKE '%\\%\\%4484%' ESCAPE '\\') OR (ProcessName LIKE '%:\\\\Windows\\\\System32\\\\snmp.exe' ESCAPE '\\' AND AccessList LIKE '%\\%\\%4484%' ESCAPE '\\') OR (ProcessName LIKE '%:\\\\Windows\\\\SystemTemp\\\\%' ESCAPE '\\' AND ProcessName LIKE '%\\\\GoogleUpdate.exe' ESCAPE '\\' AND AccessList LIKE '%\\%\\%4484%' ESCAPE '\\'))) AND (NOT ((ProcessName LIKE '%\\\\procmon64.exe' ESCAPE '\\' OR ProcessName LIKE '%\\\\procmon.exe' ESCAPE '\\') AND AccessList LIKE '%\\%\\%4484%' ESCAPE '\\')))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.credential-access",
    "car.2019-04-004",
    "attack.t1003.001"
  ],
  "count": 2,
  "matches": [
    {
      "row_id": 1,
      "AccessList": "%%1537\r\n\t\t\t\t%%1538\r\n\t\t\t\t%%1539\r\n\t\t\t\t%%1540\r\n\t\t\t\t%%1541\r\n\t\t\t\t%%4480\r\n\t\t\t\t%%4481\r\n\t\t\t\t%%4482\r\n\t\t\t\t%%4483\r\n\t\t\t\t%%4484\r\n\t\t\t\t%%4485\r\n\t\t\t\t%%4486\r\n\t\t\t\t%%4487\r\n\t\t\t\t%%4488\r\n\t\t\t\t%%4489\r\n\t\t\t\t%%4490\r\n\t\t\t\t%%4491\r\n\t\t\t\t%%4492\r\n\t\t\t\t%%4493",
      "AccessMask": "0x1f3fff",
      "AccessReason": "-",
      "Channel": "Security",
      "Computer": "MSEDGEWIN10",
      "EventID": 4656,
      "EventRecordID": 314461,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "HandleId": "0x558",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectName": "\\Device\\HarddiskVolume1\\Windows\\System32\\lsass.exe",
      "ObjectServer": "Security",
      "ObjectType": "Process",
      "Opcode": 0,
      "OriginalLogfile": "CA_hashdump_4663_4656_lsass_access.evtx",
      "PrivilegeList": "-",
      "ProcessID": 4,
      "ProcessName": "C:\\Windows\\System32\\cscript.exe",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "ResourceAttributes": "-",
      "RestrictedSidCount": 0,
      "SubjectDomainName": "MSEDGEWIN10",
      "SubjectLogonId": "0x33392",
      "SubjectUserName": "IEUser",
      "SubjectUserSid": "S-1-5-21-3461203602-4096304019-2269080069-1000",
      "SystemTime": "2020-03-08T22:11:34.340479Z",
      "Task": 12802,
      "ThreadID": 160,
      "TransactionId": "00000000-0000-0000-0000-000000000000",
      "Version": 1
    },
    {
      "row_id": 2,
      "AccessList": "%%4484",
      "AccessMask": "0x10",
      "Channel": "Security",
      "Computer": "MSEDGEWIN10",
      "EventID": 4663,
      "EventRecordID": 314462,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "HandleId": "0x558",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectName": "\\Device\\HarddiskVolume1\\Windows\\System32\\lsass.exe",
      "ObjectServer": "Security",
      "ObjectType": "Process",
      "Opcode": 0,
      "OriginalLogfile": "CA_hashdump_4663_4656_lsass_access.evtx",
      "ProcessID": 4,
      "ProcessName": "C:\\Windows\\System32\\cscript.exe",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "ResourceAttributes": "-",
      "SubjectDomainName": "MSEDGEWIN10",
      "SubjectLogonId": "0x33392",
      "SubjectUserName": "IEUser",
      "SubjectUserSid": "S-1-5-21-3461203602-4096304019-2269080069-1000",
      "SystemTime": "2020-03-08T22:11:34.340584Z",
      "Task": 12802,
      "ThreadID": 160,
      "Version": 1
    }
  ]
},
{
  "title": "LSASS Access From Non System Account",
  "id": "962fe167-e48d-4fd6-9974-11e5b9a5d6d1",
  "description": "Detects potential mimikatz-like tools accessing LSASS from non system account",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND (((EventID=4663 OR EventID=4656) AND (AccessMask='0x100000' OR AccessMask='0x1010' OR AccessMask='0x1400' OR AccessMask='0x1410' OR AccessMask='0x1418' OR AccessMask='0x1438' OR AccessMask='0x143a' OR AccessMask='0x1f0fff' OR AccessMask='0x1f1fff' OR AccessMask='0x1f2fff' OR AccessMask='0x1f3fff' OR AccessMask='0x40' OR AccessMask='143a' OR AccessMask='1f0fff' OR AccessMask='1f1fff' OR AccessMask='1f2fff' OR AccessMask='1f3fff') AND ObjectType='Process' AND ObjectName LIKE '%\\\\lsass.exe' ESCAPE '\\') AND (NOT (SubjectUserName LIKE '%$' ESCAPE '\\' OR (ProcessName LIKE '%:\\\\Program Files\\\\%' ESCAPE '\\' OR ProcessName LIKE '%:\\\\Program Files (x86)\\\\%' ESCAPE '\\') OR (ProcessName LIKE 'C:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSE.exe' ESCAPE '\\' AND AccessMask='0x1410'))) AND (NOT ProcessName LIKE '%\\\\SteamLibrary\\\\steamapps\\\\%' ESCAPE '\\'))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.credential-access",
    "attack.t1003.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "AccessList": "%%1537\r\n\t\t\t\t%%1538\r\n\t\t\t\t%%1539\r\n\t\t\t\t%%1540\r\n\t\t\t\t%%1541\r\n\t\t\t\t%%4480\r\n\t\t\t\t%%4481\r\n\t\t\t\t%%4482\r\n\t\t\t\t%%4483\r\n\t\t\t\t%%4484\r\n\t\t\t\t%%4485\r\n\t\t\t\t%%4486\r\n\t\t\t\t%%4487\r\n\t\t\t\t%%4488\r\n\t\t\t\t%%4489\r\n\t\t\t\t%%4490\r\n\t\t\t\t%%4491\r\n\t\t\t\t%%4492\r\n\t\t\t\t%%4493",
      "AccessMask": "0x1f3fff",
      "AccessReason": "-",
      "Channel": "Security",
      "Computer": "MSEDGEWIN10",
      "EventID": 4656,
      "EventRecordID": 314461,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "HandleId": "0x558",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectName": "\\Device\\HarddiskVolume1\\Windows\\System32\\lsass.exe",
      "ObjectServer": "Security",
      "ObjectType": "Process",
      "Opcode": 0,
      "OriginalLogfile": "CA_hashdump_4663_4656_lsass_access.evtx",
      "PrivilegeList": "-",
      "ProcessID": 4,
      "ProcessName": "C:\\Windows\\System32\\cscript.exe",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "ResourceAttributes": "-",
      "RestrictedSidCount": 0,
      "SubjectDomainName": "MSEDGEWIN10",
      "SubjectLogonId": "0x33392",
      "SubjectUserName": "IEUser",
      "SubjectUserSid": "S-1-5-21-3461203602-4096304019-2269080069-1000",
      "SystemTime": "2020-03-08T22:11:34.340479Z",
      "Task": 12802,
      "ThreadID": 160,
      "TransactionId": "00000000-0000-0000-0000-000000000000",
      "Version": 1
    }
  ]
}]