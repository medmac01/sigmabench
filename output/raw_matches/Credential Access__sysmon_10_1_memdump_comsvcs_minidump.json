[{
  "title": "Suspicious WmiPrvSE Child Process",
  "id": "8a582fe2-0882-4b89-a82a-da6b2dc32937",
  "description": "Detects suspicious and uncommon child processes of WmiPrvSE",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (ParentImage LIKE '%\\\\wbem\\\\WmiPrvSE.exe' ESCAPE '\\' AND ((Image LIKE '%\\\\certutil.exe' ESCAPE '\\' OR Image LIKE '%\\\\cscript.exe' ESCAPE '\\' OR Image LIKE '%\\\\mshta.exe' ESCAPE '\\' OR Image LIKE '%\\\\msiexec.exe' ESCAPE '\\' OR Image LIKE '%\\\\regsvr32.exe' ESCAPE '\\' OR Image LIKE '%\\\\rundll32.exe' ESCAPE '\\' OR Image LIKE '%\\\\verclsid.exe' ESCAPE '\\' OR Image LIKE '%\\\\wscript.exe' ESCAPE '\\') OR (Image LIKE '%\\\\cmd.exe' ESCAPE '\\' AND (CommandLine LIKE '%cscript%' ESCAPE '\\' OR CommandLine LIKE '%mshta%' ESCAPE '\\' OR CommandLine LIKE '%powershell%' ESCAPE '\\' OR CommandLine LIKE '%pwsh%' ESCAPE '\\' OR CommandLine LIKE '%regsvr32%' ESCAPE '\\' OR CommandLine LIKE '%rundll32%' ESCAPE '\\' OR CommandLine LIKE '%wscript%' ESCAPE '\\'))) AND (NOT (Image LIKE '%\\\\WerFault.exe' ESCAPE '\\' OR Image LIKE '%\\\\WmiPrvSE.exe' ESCAPE '\\' OR (Image LIKE '%\\\\msiexec.exe' ESCAPE '\\' AND CommandLine LIKE '%/i %' ESCAPE '\\')))))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.execution",
    "attack.defense-evasion",
    "attack.t1047",
    "attack.t1204.002",
    "attack.t1218.010"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 4,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "rundll32 C:\\windows\\system32\\comsvcs.dll, MiniDump 4868 C:\\Windows\\System32\\notepad.bin full",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows host process (Rundll32)",
      "EventID": 1,
      "EventRecordID": 32154,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=F3BA3415DD068A8871F285570BEA2E29874CBFF1,MD5=C73BA51880F5A7FB20C84185A23212EF,SHA256=01B407AF0200B66A34D9B1FA6D9EAAB758EFA36A36BB99B554384F59F8690B1A,IMPHASH=F27A7FC3A53E74F45BE370131953896A",
      "IMPHASH": "F27A7FC3A53E74F45BE370131953896A",
      "Image": "C:\\Windows\\System32\\rundll32.exe",
      "IntegrityLevel": "High",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-1B6A-5D69-0000-0020E5810E00",
      "LogonId": "0xe81e5",
      "MD5": "C73BA51880F5A7FB20C84185A23212EF",
      "Opcode": 0,
      "OriginalLogfile": "sysmon_10_1_memdump_comsvcs_minidump.evtx",
      "ParentCommandLine": "C:\\Windows\\system32\\wbem\\wmiprvse.exe -secured -Embedding",
      "ParentImage": "C:\\Windows\\System32\\wbem\\WmiPrvSE.exe",
      "ParentProcessGuid": "747F3D96-1C70-5D69-0000-0010D4551F00",
      "ParentProcessId": 1144,
      "ProcessGuid": "747F3D96-1C70-5D69-0000-0010C9661F00",
      "ProcessID": 3292,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "F3BA3415DD068A8871F285570BEA2E29874CBFF1",
      "SHA256": "01B407AF0200B66A34D9B1FA6D9EAAB758EFA36A36BB99B554384F59F8690B1A",
      "SystemTime": "2019-08-30T12:54:08.354049Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 928,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-08-30 12:54:08.331",
      "Version": 5
    }
  ]
},
{
  "title": "Potentially Suspicious Rundll32 Activity",
  "id": "e593cf51-88db-4ee1-b920-37e89012a3c9",
  "description": "Detects suspicious execution of rundll32, with specific calls to some DLLs with known LOLBIN functionalities",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (((CommandLine LIKE '%javascript:%' ESCAPE '\\' AND CommandLine LIKE '%.RegisterXLL%' ESCAPE '\\') OR (CommandLine LIKE '%url.dll%' ESCAPE '\\' AND CommandLine LIKE '%OpenURL%' ESCAPE '\\') OR (CommandLine LIKE '%url.dll%' ESCAPE '\\' AND CommandLine LIKE '%OpenURLA%' ESCAPE '\\') OR (CommandLine LIKE '%url.dll%' ESCAPE '\\' AND CommandLine LIKE '%FileProtocolHandler%' ESCAPE '\\') OR (CommandLine LIKE '%zipfldr.dll%' ESCAPE '\\' AND CommandLine LIKE '%RouteTheCall%' ESCAPE '\\') OR (CommandLine LIKE '%shell32.dll%' ESCAPE '\\' AND CommandLine LIKE '%Control\\_RunDLL%' ESCAPE '\\') OR (CommandLine LIKE '%shell32.dll%' ESCAPE '\\' AND CommandLine LIKE '%ShellExec\\_RunDLL%' ESCAPE '\\') OR (CommandLine LIKE '%mshtml.dll%' ESCAPE '\\' AND CommandLine LIKE '%PrintHTML%' ESCAPE '\\') OR (CommandLine LIKE '%advpack.dll%' ESCAPE '\\' AND CommandLine LIKE '%LaunchINFSection%' ESCAPE '\\') OR (CommandLine LIKE '%advpack.dll%' ESCAPE '\\' AND CommandLine LIKE '%RegisterOCX%' ESCAPE '\\') OR (CommandLine LIKE '%ieadvpack.dll%' ESCAPE '\\' AND CommandLine LIKE '%LaunchINFSection%' ESCAPE '\\') OR (CommandLine LIKE '%ieadvpack.dll%' ESCAPE '\\' AND CommandLine LIKE '%RegisterOCX%' ESCAPE '\\') OR (CommandLine LIKE '%ieframe.dll%' ESCAPE '\\' AND CommandLine LIKE '%OpenURL%' ESCAPE '\\') OR (CommandLine LIKE '%shdocvw.dll%' ESCAPE '\\' AND CommandLine LIKE '%OpenURL%' ESCAPE '\\') OR (CommandLine LIKE '%syssetup.dll%' ESCAPE '\\' AND CommandLine LIKE '%SetupInfObjectInstallAction%' ESCAPE '\\') OR (CommandLine LIKE '%setupapi.dll%' ESCAPE '\\' AND CommandLine LIKE '%InstallHinfSection%' ESCAPE '\\') OR (CommandLine LIKE '%pcwutl.dll%' ESCAPE '\\' AND CommandLine LIKE '%LaunchApplication%' ESCAPE '\\') OR (CommandLine LIKE '%dfshim.dll%' ESCAPE '\\' AND CommandLine LIKE '%ShOpenVerbApplication%' ESCAPE '\\') OR (CommandLine LIKE '%dfshim.dll%' ESCAPE '\\' AND CommandLine LIKE '%ShOpenVerbShortcut%' ESCAPE '\\') OR (CommandLine LIKE '%scrobj.dll%' ESCAPE '\\' AND CommandLine LIKE '%GenerateTypeLib%' ESCAPE '\\' AND CommandLine LIKE '%http%' ESCAPE '\\') OR (CommandLine LIKE '%shimgvw.dll%' ESCAPE '\\' AND CommandLine LIKE '%ImageView\\_Fullscreen%' ESCAPE '\\' AND CommandLine LIKE '%http%' ESCAPE '\\') OR (CommandLine LIKE '%comsvcs.dll%' ESCAPE '\\' AND CommandLine LIKE '%MiniDump%' ESCAPE '\\')) AND (NOT (CommandLine LIKE '%shell32.dll,Control\\_RunDLL desk.cpl,screensaver,@screensaver%' ESCAPE '\\' OR (ParentImage LIKE 'C:\\\\Windows\\\\System32\\\\control.exe' ESCAPE '\\' AND ParentCommandLine LIKE '%.cpl%' ESCAPE '\\' AND (CommandLine LIKE '%Shell32.dll%' ESCAPE '\\' AND CommandLine LIKE '%Control\\_RunDLL%' ESCAPE '\\' AND CommandLine LIKE '%.cpl%' ESCAPE '\\')) OR (ParentImage LIKE 'C:\\\\Windows\\\\System32\\\\control.exe' ESCAPE '\\' AND CommandLine LIKE '\"C:\\\\Windows\\\\system32\\\\rundll32.exe\" Shell32.dll,Control\\_RunDLL \"C:\\\\Windows\\\\System32\\\\%' ESCAPE '\\' AND CommandLine LIKE '%.cpl\",' ESCAPE '\\')))))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.defense-evasion",
    "attack.t1218.011"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 4,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "rundll32 C:\\windows\\system32\\comsvcs.dll, MiniDump 4868 C:\\Windows\\System32\\notepad.bin full",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows host process (Rundll32)",
      "EventID": 1,
      "EventRecordID": 32154,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=F3BA3415DD068A8871F285570BEA2E29874CBFF1,MD5=C73BA51880F5A7FB20C84185A23212EF,SHA256=01B407AF0200B66A34D9B1FA6D9EAAB758EFA36A36BB99B554384F59F8690B1A,IMPHASH=F27A7FC3A53E74F45BE370131953896A",
      "IMPHASH": "F27A7FC3A53E74F45BE370131953896A",
      "Image": "C:\\Windows\\System32\\rundll32.exe",
      "IntegrityLevel": "High",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-1B6A-5D69-0000-0020E5810E00",
      "LogonId": "0xe81e5",
      "MD5": "C73BA51880F5A7FB20C84185A23212EF",
      "Opcode": 0,
      "OriginalLogfile": "sysmon_10_1_memdump_comsvcs_minidump.evtx",
      "ParentCommandLine": "C:\\Windows\\system32\\wbem\\wmiprvse.exe -secured -Embedding",
      "ParentImage": "C:\\Windows\\System32\\wbem\\WmiPrvSE.exe",
      "ParentProcessGuid": "747F3D96-1C70-5D69-0000-0010D4551F00",
      "ParentProcessId": 1144,
      "ProcessGuid": "747F3D96-1C70-5D69-0000-0010C9661F00",
      "ProcessID": 3292,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "F3BA3415DD068A8871F285570BEA2E29874CBFF1",
      "SHA256": "01B407AF0200B66A34D9B1FA6D9EAAB758EFA36A36BB99B554384F59F8690B1A",
      "SystemTime": "2019-08-30T12:54:08.354049Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 928,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-08-30 12:54:08.331",
      "Version": 5
    }
  ]
},
{
  "title": "WmiPrvSE Spawned A Process",
  "id": "d21374ff-f574-44a7-9998-4a8c8bf33d7d",
  "description": "Detects WmiPrvSE spawning a process",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (ParentImage LIKE '%\\\\WmiPrvSe.exe' ESCAPE '\\' AND (NOT ((LogonId='0x3e7' OR LogonId='null') OR (User LIKE '%AUTHORI%' ESCAPE '\\' OR User LIKE '%AUTORI%' ESCAPE '\\') OR Image LIKE '%\\\\WmiPrvSE.exe' ESCAPE '\\' OR Image LIKE '%\\\\WerFault.exe' ESCAPE '\\' OR LogonId IS NULL))))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.execution",
    "attack.t1047"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 4,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "rundll32 C:\\windows\\system32\\comsvcs.dll, MiniDump 4868 C:\\Windows\\System32\\notepad.bin full",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows host process (Rundll32)",
      "EventID": 1,
      "EventRecordID": 32154,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=F3BA3415DD068A8871F285570BEA2E29874CBFF1,MD5=C73BA51880F5A7FB20C84185A23212EF,SHA256=01B407AF0200B66A34D9B1FA6D9EAAB758EFA36A36BB99B554384F59F8690B1A,IMPHASH=F27A7FC3A53E74F45BE370131953896A",
      "IMPHASH": "F27A7FC3A53E74F45BE370131953896A",
      "Image": "C:\\Windows\\System32\\rundll32.exe",
      "IntegrityLevel": "High",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-1B6A-5D69-0000-0020E5810E00",
      "LogonId": "0xe81e5",
      "MD5": "C73BA51880F5A7FB20C84185A23212EF",
      "Opcode": 0,
      "OriginalLogfile": "sysmon_10_1_memdump_comsvcs_minidump.evtx",
      "ParentCommandLine": "C:\\Windows\\system32\\wbem\\wmiprvse.exe -secured -Embedding",
      "ParentImage": "C:\\Windows\\System32\\wbem\\WmiPrvSE.exe",
      "ParentProcessGuid": "747F3D96-1C70-5D69-0000-0010D4551F00",
      "ParentProcessId": 1144,
      "ProcessGuid": "747F3D96-1C70-5D69-0000-0010C9661F00",
      "ProcessID": 3292,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "F3BA3415DD068A8871F285570BEA2E29874CBFF1",
      "SHA256": "01B407AF0200B66A34D9B1FA6D9EAAB758EFA36A36BB99B554384F59F8690B1A",
      "SystemTime": "2019-08-30T12:54:08.354049Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 928,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-08-30 12:54:08.331",
      "Version": 5
    }
  ]
},
{
  "title": "Uncommon Process Access Rights For Target Image",
  "id": "a24e5861-c6ca-4fde-a93c-ba9256feddf0",
  "description": "Detects process access request to uncommon target images with a \"PROCESS_ALL_ACCESS\" access mask.\n",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=10 AND ((TargetImage LIKE '%\\\\calc.exe' ESCAPE '\\' OR TargetImage LIKE '%\\\\calculator.exe' ESCAPE '\\' OR TargetImage LIKE '%\\\\mspaint.exe' ESCAPE '\\' OR TargetImage LIKE '%\\\\notepad.exe' ESCAPE '\\' OR TargetImage LIKE '%\\\\ping.exe' ESCAPE '\\' OR TargetImage LIKE '%\\\\wordpad.exe' ESCAPE '\\' OR TargetImage LIKE '%\\\\write.exe' ESCAPE '\\') AND GrantedAccess='0x1FFFFF'))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.defense-evasion",
    "attack.privilege-escalation",
    "attack.t1055.011"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 6,
      "CallTrace": "C:\\Windows\\SYSTEM32\\ntdll.dll+9fc24|C:\\Windows\\SYSTEM32\\ntdll.dll+7a747|C:\\Windows\\System32\\KERNEL32.DLL+1c5b4|C:\\Windows\\System32\\KERNEL32.DLL+237f8|C:\\Windows\\SYSTEM32\\dbgcore.DLL+9247|C:\\Windows\\SYSTEM32\\dbgcore.DLL+15dc5|C:\\Windows\\SYSTEM32\\dbgcore.DLL+fec6|C:\\Windows\\SYSTEM32\\dbgcore.DLL+5f56|C:\\Windows\\SYSTEM32\\dbgcore.DLL+69f7|C:\\windows\\system32\\comsvcs.dll+3c3d4|C:\\Windows\\system32\\rundll32.exe+3bcf|C:\\Windows\\system32\\rundll32.exe+6299|C:\\Windows\\System32\\KERNEL32.DLL+17974|C:\\Windows\\SYSTEM32\\ntdll.dll+6a271",
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "MSEDGEWIN10",
      "EventID": 10,
      "EventRecordID": 32156,
      "GrantedAccess": "0x1fffff",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "sysmon_10_1_memdump_comsvcs_minidump.evtx",
      "ProcessID": 3292,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "CredAccess - Memdump",
      "SourceImage": "C:\\Windows\\system32\\rundll32.exe",
      "SourceProcessGUID": "747F3D96-1C70-5D69-0000-0010C9661F00",
      "SourceProcessId": 2888,
      "SourceThreadId": 2796,
      "SystemTime": "2019-08-30T12:54:08.439957Z",
      "TargetImage": "C:\\Windows\\system32\\notepad.exe",
      "TargetProcessGUID": "747F3D96-1C5C-5D69-0000-0010FEB71E00",
      "TargetProcessId": 4868,
      "Task": 10,
      "ThreadID": 928,
      "UserID": "S-1-5-18",
      "UtcTime": "2019-08-30 12:54:08.424",
      "Version": 3
    }
  ]
}]