[{
  "title": "External Remote SMB Logon from Public IP",
  "id": "78d5cab4-557e-454f-9fb9-a222bd0d5edc",
  "description": "Detects successful logon from public IP address via SMB. This can indicate a publicly-exposed SMB port.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND ((EventID=4624 AND LogonType=3) AND (NOT ((IpAddress='::1/128' OR IpAddress LIKE '10.%' ESCAPE '\\' OR IpAddress LIKE '127.%' ESCAPE '\\' OR IpAddress LIKE '172.16.%' ESCAPE '\\' OR IpAddress LIKE '172.17.%' ESCAPE '\\' OR IpAddress LIKE '172.18.%' ESCAPE '\\' OR IpAddress LIKE '172.19.%' ESCAPE '\\' OR IpAddress LIKE '172.20.%' ESCAPE '\\' OR IpAddress LIKE '172.21.%' ESCAPE '\\' OR IpAddress LIKE '172.22.%' ESCAPE '\\' OR IpAddress LIKE '172.23.%' ESCAPE '\\' OR IpAddress LIKE '172.24.%' ESCAPE '\\' OR IpAddress LIKE '172.25.%' ESCAPE '\\' OR IpAddress LIKE '172.26.%' ESCAPE '\\' OR IpAddress LIKE '172.27.%' ESCAPE '\\' OR IpAddress LIKE '172.28.%' ESCAPE '\\' OR IpAddress LIKE '172.29.%' ESCAPE '\\' OR IpAddress LIKE '172.30.%' ESCAPE '\\' OR IpAddress LIKE '172.31.%' ESCAPE '\\' OR IpAddress LIKE '192.168.%' ESCAPE '\\' OR IpAddress LIKE '169.254.%' ESCAPE '\\' OR IpAddress LIKE 'fc%' ESCAPE '\\' OR IpAddress LIKE 'fd%' ESCAPE '\\' OR IpAddress LIKE 'fe8%' ESCAPE '\\' OR IpAddress LIKE 'fe9%' ESCAPE '\\' OR IpAddress LIKE 'fea%' ESCAPE '\\' OR IpAddress LIKE 'feb%' ESCAPE '\\') OR IpAddress='-')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.persistence",
    "attack.defense-evasion",
    "attack.initial-access",
    "attack.credential-access",
    "attack.t1133",
    "attack.t1078",
    "attack.t1110"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 6,
      "AuthenticationPackageName": "Kerberos",
      "Channel": "Security",
      "Computer": "WIN-77LTAPHIQ1R.example.corp",
      "EventID": 4624,
      "EventRecordID": 563342,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "ImpersonationLevel": "%%1833",
      "IpAddress": "::1",
      "IpPort": "55589",
      "KeyLength": 0,
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "LmPackageName": "-",
      "LogonGuid": "5FDB15EE-2283-F23C-E23B-5E5DDB11BB9C",
      "LogonProcessName": "Kerberos",
      "LogonType": 3,
      "Opcode": 0,
      "OriginalLogfile": "LM_WMI_4624_4688_TargetHost.evtx",
      "ProcessID": 452,
      "ProcessName": "-",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "SubjectDomainName": "-",
      "SubjectLogonId": "0x0",
      "SubjectUserName": "-",
      "SubjectUserSid": "S-1-0-0",
      "SystemTime": "2019-03-18T22:16:19.989944Z",
      "TargetDomainName": "EXAMPLE",
      "TargetLogonId": "0x116c7b",
      "TargetUserName": "WIN-77LTAPHIQ1R$",
      "TargetUserSid": "S-1-5-18",
      "Task": 12544,
      "ThreadID": 696,
      "TransmittedServices": "-",
      "Version": 1
    }
  ]
}]