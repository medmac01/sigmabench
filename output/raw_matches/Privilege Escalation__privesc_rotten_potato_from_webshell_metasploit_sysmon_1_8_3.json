[{
  "title": "Network Connection Initiated Via Notepad.EXE",
  "id": "e81528db-fc02-45e8-8e98-4e84aba1f10b",
  "description": "Detects a network connection that is initiated by the \"notepad.exe\" process.\nThis might be a sign of process injection from a beacon process or something similar.\nNotepad rarely initiates a network communication except when printing documents for example.\n",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=3 AND (Image LIKE '%\\\\notepad.exe' ESCAPE '\\' AND (NOT DestinationPort=9100)))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.command-and-control",
    "attack.execution",
    "attack.defense-evasion",
    "attack.t1055"
  ],
  "count": 7,
  "matches": [
    {
      "row_id": 5,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "IEWIN7",
      "DestinationHostname": "IEWIN7",
      "DestinationIp": "127.0.0.1",
      "DestinationIsIpv6": 0,
      "DestinationPort": 135,
      "DestinationPortName": "epmap",
      "EventID": 3,
      "EventRecordID": 5412,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\System32\\notepad.exe",
      "Initiated": 1,
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "privesc_rotten_potato_from_webshell_metasploit_sysmon_1_8_3.evtx",
      "ProcessGuid": "365ABB72-B52C-5CEA-0000-00107A0D1100",
      "ProcessID": 324,
      "Protocol": "tcp",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SourceHostname": "IEWIN7",
      "SourceIp": "127.0.0.1",
      "SourceIsIpv6": 0,
      "SourcePort": 49166,
      "SystemTime": "2019-05-26T15:47:58.830229Z",
      "Task": 3,
      "ThreadID": 2264,
      "User": "IIS APPPOOL\\DefaultAppPool",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-26 15:47:57.111",
      "Version": 5
    },
    {
      "row_id": 6,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "IEWIN7",
      "DestinationHostname": "IEWIN7",
      "DestinationIp": "127.0.0.1",
      "DestinationIsIpv6": 0,
      "DestinationPort": 49167,
      "EventID": 3,
      "EventRecordID": 5413,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\System32\\notepad.exe",
      "Initiated": 0,
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "privesc_rotten_potato_from_webshell_metasploit_sysmon_1_8_3.evtx",
      "ProcessGuid": "365ABB72-B52C-5CEA-0000-00107A0D1100",
      "ProcessID": 324,
      "Protocol": "tcp",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SourceHostname": "IEWIN7",
      "SourceIp": "127.0.0.1",
      "SourceIsIpv6": 0,
      "SourcePort": 7777,
      "SystemTime": "2019-05-26T15:47:58.830229Z",
      "Task": 3,
      "ThreadID": 2264,
      "User": "IIS APPPOOL\\DefaultAppPool",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-26 15:47:57.119",
      "Version": 5
    },
    {
      "row_id": 7,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "IEWIN7",
      "DestinationHostname": "IEWIN7",
      "DestinationIp": "127.0.0.1",
      "DestinationIsIpv6": 0,
      "DestinationPort": 49168,
      "EventID": 3,
      "EventRecordID": 5414,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\System32\\notepad.exe",
      "Initiated": 0,
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "privesc_rotten_potato_from_webshell_metasploit_sysmon_1_8_3.evtx",
      "ProcessGuid": "365ABB72-B52C-5CEA-0000-00107A0D1100",
      "ProcessID": 324,
      "Protocol": "tcp",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SourceHostname": "IEWIN7",
      "SourceIp": "127.0.0.1",
      "SourceIsIpv6": 0,
      "SourcePort": 7777,
      "SystemTime": "2019-05-26T15:47:59.871726Z",
      "Task": 3,
      "ThreadID": 2264,
      "User": "IIS APPPOOL\\DefaultAppPool",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-26 15:47:58.117",
      "Version": 5
    },
    {
      "row_id": 8,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "IEWIN7",
      "DestinationHostname": "IEWIN7",
      "DestinationIp": "127.0.0.1",
      "DestinationIsIpv6": 0,
      "DestinationPort": 135,
      "DestinationPortName": "epmap",
      "EventID": 3,
      "EventRecordID": 5415,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\System32\\notepad.exe",
      "Initiated": 1,
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "privesc_rotten_potato_from_webshell_metasploit_sysmon_1_8_3.evtx",
      "ProcessGuid": "365ABB72-B52C-5CEA-0000-00107A0D1100",
      "ProcessID": 324,
      "Protocol": "tcp",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SourceHostname": "IEWIN7",
      "SourceIp": "127.0.0.1",
      "SourceIsIpv6": 0,
      "SourcePort": 49169,
      "SystemTime": "2019-05-26T15:47:59.871726Z",
      "Task": 3,
      "ThreadID": 2264,
      "User": "IIS APPPOOL\\DefaultAppPool",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-26 15:47:58.140",
      "Version": 5
    },
    {
      "row_id": 9,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "IEWIN7",
      "DestinationHostname": "IEWIN7",
      "DestinationIp": "127.0.0.1",
      "DestinationIsIpv6": 0,
      "DestinationPort": 49170,
      "EventID": 3,
      "EventRecordID": 5416,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\System32\\notepad.exe",
      "Initiated": 0,
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "privesc_rotten_potato_from_webshell_metasploit_sysmon_1_8_3.evtx",
      "ProcessGuid": "365ABB72-B52C-5CEA-0000-00107A0D1100",
      "ProcessID": 324,
      "Protocol": "tcp",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SourceHostname": "IEWIN7",
      "SourceIp": "127.0.0.1",
      "SourceIsIpv6": 0,
      "SourcePort": 7777,
      "SystemTime": "2019-05-26T15:48:00.732965Z",
      "Task": 3,
      "ThreadID": 2264,
      "User": "IIS APPPOOL\\DefaultAppPool",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-26 15:47:59.147",
      "Version": 5
    },
    {
      "row_id": 10,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "IEWIN7",
      "DestinationHostname": "IEWIN7",
      "DestinationIp": "127.0.0.1",
      "DestinationIsIpv6": 0,
      "DestinationPort": 135,
      "DestinationPortName": "epmap",
      "EventID": 3,
      "EventRecordID": 5417,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\System32\\notepad.exe",
      "Initiated": 1,
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "privesc_rotten_potato_from_webshell_metasploit_sysmon_1_8_3.evtx",
      "ProcessGuid": "365ABB72-B52C-5CEA-0000-00107A0D1100",
      "ProcessID": 324,
      "Protocol": "tcp",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SourceHostname": "IEWIN7",
      "SourceIp": "127.0.0.1",
      "SourceIsIpv6": 0,
      "SourcePort": 49171,
      "SystemTime": "2019-05-26T15:48:00.732965Z",
      "Task": 3,
      "ThreadID": 2264,
      "User": "IIS APPPOOL\\DefaultAppPool",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-26 15:47:59.148",
      "Version": 5
    },
    {
      "row_id": 13,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "IEWIN7",
      "DestinationIp": "10.0.2.18",
      "DestinationIsIpv6": 0,
      "DestinationPort": 888,
      "EventID": 3,
      "EventRecordID": 5420,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\System32\\notepad.exe",
      "Initiated": 1,
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "privesc_rotten_potato_from_webshell_metasploit_sysmon_1_8_3.evtx",
      "ProcessGuid": "365ABB72-B530-5CEA-0000-0010621A1100",
      "ProcessID": 324,
      "Protocol": "tcp",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SourceHostname": "IEWIN7",
      "SourceIp": "10.0.2.13",
      "SourceIsIpv6": 0,
      "SourcePort": 49172,
      "SystemTime": "2019-05-26T15:48:01.864592Z",
      "Task": 3,
      "ThreadID": 2264,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-26 15:48:00.245",
      "Version": 5
    }
  ]
},
{
  "title": "Rare Remote Thread Creation By Uncommon Source Image",
  "id": "02d1d718-dd13-41af-989d-ea85c7fab93f",
  "description": "Detects uncommon processes creating remote threads.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=8 AND ((SourceImage LIKE '%\\\\bash.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\cscript.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\cvtres.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\defrag.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\dialer.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\dnx.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\esentutl.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\excel.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\expand.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\find.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\findstr.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\forfiles.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\gpupdate.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\hh.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\installutil.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\lync.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\makecab.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\mDNSResponder.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\monitoringhost.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\msbuild.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\mshta.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\mspaint.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\outlook.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\ping.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\provtool.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\python.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\regsvr32.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\robocopy.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\runonce.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\sapcimc.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\smartscreen.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\spoolsv.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\tstheme.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\userinit.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\vssadmin.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\vssvc.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\w3wp.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\winscp.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\winword.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\wmic.exe' ESCAPE '\\' OR SourceImage LIKE '%\\\\wscript.exe' ESCAPE '\\') AND (NOT (((SourceImage LIKE 'C:\\\\Windows\\\\System32\\\\Defrag.exe' ESCAPE '\\' OR SourceImage LIKE 'C:\\\\Windows\\\\System32\\\\makecab.exe' ESCAPE '\\') AND TargetImage LIKE 'C:\\\\Windows\\\\System32\\\\conhost.exe' ESCAPE '\\') OR (SourceImage LIKE 'C:\\\\Windows\\\\System32\\\\provtool.exe' ESCAPE '\\' AND TargetImage LIKE 'C:\\\\Windows\\\\System32\\\\svchost.exe' ESCAPE '\\') OR (SourceImage LIKE 'C:\\\\Windows\\\\System32\\\\provtool.exe' ESCAPE '\\' AND TargetImage='System') OR (SourceImage LIKE 'C:\\\\Windows\\\\System32\\\\userinit.exe' ESCAPE '\\' AND TargetImage LIKE 'C:\\\\Windows\\\\explorer.exe' ESCAPE '\\') OR (SourceImage LIKE '%\\\\WINWORD.EXE' ESCAPE '\\' AND (TargetImage LIKE 'C:\\\\Program Files (x86)\\\\%' ESCAPE '\\' OR TargetImage LIKE 'C:\\\\Program Files\\\\%' ESCAPE '\\')) OR ((SourceImage LIKE 'C:\\\\Program Files\\\\Microsoft Office\\\\%' ESCAPE '\\' OR SourceImage LIKE 'C:\\\\Program Files (x86)\\\\Microsoft Office\\\\%' ESCAPE '\\') AND TargetImage='System'))) AND (NOT (SourceImage LIKE '%\\\\SysWOW64\\\\explorer.exe' ESCAPE '\\' AND (TargetImage LIKE 'C:\\\\Program Files (x86)\\\\VMware\\\\VMware Tools\\\\vmtoolsd.exe' ESCAPE '\\' OR TargetImage LIKE 'C:\\\\Program Files\\\\VMware\\\\VMware Tools\\\\vmtoolsd.exe' ESCAPE '\\')))))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.defense-evasion",
    "attack.t1055"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 4,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "IEWIN7",
      "EventID": 8,
      "EventRecordID": 5411,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "NewThreadId": 3520,
      "Opcode": 0,
      "OriginalLogfile": "privesc_rotten_potato_from_webshell_metasploit_sysmon_1_8_3.evtx",
      "ProcessID": 324,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SourceImage": "C:\\Windows\\System32\\inetsrv\\w3wp.exe",
      "SourceProcessId": 2744,
      "StartAddress": "0x005A28D0",
      "SystemTime": "2019-05-26T15:47:57.628501Z",
      "TargetImage": "C:\\Windows\\System32\\notepad.exe",
      "TargetProcessId": 3388,
      "Task": 8,
      "ThreadID": 2260,
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-26 15:47:57.628",
      "Version": 2
    }
  ]
},
{
  "title": "Uncommon Process Access Rights For Target Image",
  "id": "a24e5861-c6ca-4fde-a93c-ba9256feddf0",
  "description": "Detects process access request to uncommon target images with a \"PROCESS_ALL_ACCESS\" access mask.\n",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=10 AND ((TargetImage LIKE '%\\\\calc.exe' ESCAPE '\\' OR TargetImage LIKE '%\\\\calculator.exe' ESCAPE '\\' OR TargetImage LIKE '%\\\\mspaint.exe' ESCAPE '\\' OR TargetImage LIKE '%\\\\notepad.exe' ESCAPE '\\' OR TargetImage LIKE '%\\\\ping.exe' ESCAPE '\\' OR TargetImage LIKE '%\\\\wordpad.exe' ESCAPE '\\' OR TargetImage LIKE '%\\\\write.exe' ESCAPE '\\') AND GrantedAccess='0x1FFFFF'))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.defense-evasion",
    "attack.privilege-escalation",
    "attack.t1055.011"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "CallTrace": "C:\\Windows\\SYSTEM32\\ntdll.dll+4530c|C:\\Windows\\system32\\kernel32.dll+51133|C:\\Windows\\system32\\kernel32.dll+5cc37|C:\\Windows\\system32\\kernel32.dll+20ae|UNKNOWN(0358F723)|UNKNOWN(010B7486)|UNKNOWN(010B73A0)|UNKNOWN(010B78A3)|C:\\Windows\\system32\\kernel32.dll+4ef3c|C:\\Windows\\SYSTEM32\\ntdll.dll+63618|C:\\Windows\\SYSTEM32\\ntdll.dll+635eb",
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "IEWIN7",
      "EventID": 10,
      "EventRecordID": 5409,
      "GrantedAccess": "0x1fffff",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "privesc_rotten_potato_from_webshell_metasploit_sysmon_1_8_3.evtx",
      "ProcessID": 324,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SourceImage": "c:\\windows\\system32\\inetsrv\\w3wp.exe",
      "SourceProcessGUID": "365ABB72-B26B-5CEA-0000-0010582A0800",
      "SourceProcessId": 2744,
      "SourceThreadId": 168,
      "SystemTime": "2019-05-26T15:47:56.667118Z",
      "TargetImage": "C:\\Windows\\System32\\notepad.exe",
      "TargetProcessGUID": "365ABB72-B52C-5CEA-0000-00107A0D1100",
      "TargetProcessId": 3388,
      "Task": 10,
      "ThreadID": 2260,
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-26 15:47:56.627",
      "Version": 3
    }
  ]
}]