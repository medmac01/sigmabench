[{
  "title": "Whoami.EXE Execution From Privileged Process",
  "id": "79ce34ca-af29-4d0e-b832-fc1b377020db",
  "description": "Detects the execution of \"whoami.exe\" by privileged accounts that are often abused by threat actors",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((OriginalFileName='whoami.exe' OR Image LIKE '%\\\\whoami.exe' ESCAPE '\\') AND (User LIKE '%AUTHORI%' ESCAPE '\\' OR User LIKE '%AUTORI%' ESCAPE '\\' OR User LIKE '%TrustedInstaller%' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.discovery",
    "attack.t1033"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 6,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\Windows\\system32\\whoami.exe\"",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "whoami - displays logged on user information",
      "EventID": 1,
      "EventRecordID": 110435,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=47D7864D26FC67E0D60391CBF170D33DA518C322,MD5=43C2D3293AD939241DF61B3630A9D3B6,SHA256=1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A,IMPHASH=7FF0758B766F747CE57DFAC70743FB88",
      "IMPHASH": "7FF0758B766F747CE57DFAC70743FB88",
      "Image": "C:\\Windows\\System32\\whoami.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-6ABB-5EAD-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "43C2D3293AD939241DF61B3630A9D3B6",
      "Opcode": 0,
      "OriginalFileName": "whoami.exe",
      "OriginalLogfile": "privesc_seimpersonate_tosys_spoolsv_sysmon_17_18.evtx",
      "ParentCommandLine": "powershell.exe",
      "ParentImage": "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
      "ParentProcessGuid": "747F3D96-B592-5EAD-0000-0010D4CDC200",
      "ParentProcessId": 1428,
      "ProcessGuid": "747F3D96-B595-5EAD-0000-00106BFDC200",
      "ProcessID": 3068,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "47D7864D26FC67E0D60391CBF170D33DA518C322",
      "SHA256": "1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A",
      "SystemTime": "2020-05-02T18:01:57.418442Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 2232,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-05-02 18:01:57.417",
      "Version": 5
    }
  ]
},
{
  "title": "HackTool - EfsPotato Named Pipe Creation",
  "id": "637f689e-b4a5-4a86-be0e-0100a0a33ba2",
  "description": "Detects the pattern of a pipe name as used by the hack tool EfsPotato",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND ((EventID=17 OR EventID=18) AND ((PipeName LIKE '%\\\\pipe\\\\%' ESCAPE '\\' OR PipeName LIKE '%\\\\pipe\\\\srvsvc%' ESCAPE '\\') AND (NOT (PipeName LIKE '%\\\\CtxShare%' ESCAPE '\\' OR PipeName LIKE '\\\\pipe\\\\%' ESCAPE '\\'))))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.privilege-escalation",
    "attack.t1055"
  ],
  "count": 2,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "MSEDGEWIN10",
      "EventID": 17,
      "EventRecordID": 110431,
      "EventType": "CreatePipe",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "c:\\Users\\IEUser\\Tools\\PrivEsc\\PrintSpoofer.exe",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "privesc_seimpersonate_tosys_spoolsv_sysmon_17_18.evtx",
      "PipeName": "\\9023de59-e026-4da5-97dd-913597cd038f\\pipe\\spoolss",
      "ProcessGuid": "747F3D96-B592-5EAD-0000-0010ECCBC200",
      "ProcessID": 3068,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "Possible PrivEsc attempt - Rogue Spoolss Named Pipe",
      "SystemTime": "2020-05-02T18:01:54.863989Z",
      "Task": 17,
      "ThreadID": 2232,
      "UserID": "S-1-5-18",
      "UtcTime": "2020-05-02 18:01:54.857",
      "Version": 1
    },
    {
      "row_id": 4,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "MSEDGEWIN10",
      "EventID": 18,
      "EventRecordID": 110433,
      "EventType": "ConnectPipe",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "privesc_seimpersonate_tosys_spoolsv_sysmon_17_18.evtx",
      "PipeName": "\\9023de59-e026-4da5-97dd-913597cd038f\\pipe\\spoolss",
      "ProcessGuid": "747F3D96-6AB8-5EAD-0000-0010EB030000",
      "ProcessID": 3068,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "Possible PrivEsc attempt - Rogue Spoolss Named Pipe",
      "SystemTime": "2020-05-02T18:01:54.864735Z",
      "Task": 18,
      "ThreadID": 2232,
      "UserID": "S-1-5-18",
      "UtcTime": "2020-05-02 18:01:54.863",
      "Version": 1
    }
  ]
},
{
  "title": "Elevated System Shell Spawned From Uncommon Parent Location",
  "id": "178e615d-e666-498b-9630-9ed363038101",
  "description": "Detects when a shell program such as the Windows command prompt or PowerShell is launched with system privileges from a uncommon parent location.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((((Image LIKE '%\\\\powershell.exe' ESCAPE '\\' OR Image LIKE '%\\\\powershell\\_ise.exe' ESCAPE '\\' OR Image LIKE '%\\\\pwsh.exe' ESCAPE '\\' OR Image LIKE '%\\\\cmd.exe' ESCAPE '\\') OR (OriginalFileName='PowerShell.EXE' OR OriginalFileName LIKE 'powershell\\_ise.EXE' ESCAPE '\\' OR OriginalFileName='pwsh.dll' OR OriginalFileName='Cmd.Exe')) AND ((User LIKE '%AUTHORI%' ESCAPE '\\' OR User LIKE '%AUTORI%' ESCAPE '\\') AND LogonId='0x3e7')) AND (NOT ((ParentImage LIKE '%:\\\\Program Files (x86)\\\\%' ESCAPE '\\' OR ParentImage LIKE '%:\\\\Program Files\\\\%' ESCAPE '\\' OR ParentImage LIKE '%:\\\\ProgramData\\\\%' ESCAPE '\\' OR ParentImage LIKE '%:\\\\Windows\\\\System32\\\\%' ESCAPE '\\' OR ParentImage LIKE '%:\\\\Windows\\\\SysWOW64\\\\%' ESCAPE '\\' OR ParentImage LIKE '%:\\\\Windows\\\\Temp\\\\%' ESCAPE '\\' OR ParentImage LIKE '%:\\\\Windows\\\\WinSxS\\\\%' ESCAPE '\\') OR ParentImage IS NULL OR (ParentImage='' OR ParentImage='-'))) AND (NOT ((ParentImage LIKE '%:\\\\ManageEngine\\\\ADManager Plus\\\\pgsql\\\\bin\\\\postgres.exe' ESCAPE '\\' AND Image LIKE '%\\\\cmd.exe' ESCAPE '\\') OR (CommandLine LIKE '%:\\\\WINDOWS\\\\system32\\\\cmd.exe /c \"%' ESCAPE '\\' AND CurrentDirectory LIKE '%:\\\\WINDOWS\\\\Temp\\\\asgard2-agent\\\\%' ESCAPE '\\') OR (ParentImage LIKE '%:\\\\IBM\\\\SpectrumProtect\\\\webserver\\\\scripts\\\\%' ESCAPE '\\' AND CommandLine LIKE '%:\\\\IBM\\\\SpectrumProtect\\\\webserver\\\\scripts\\\\%' ESCAPE '\\')))))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.privilege-escalation",
    "attack.defense-evasion",
    "attack.execution",
    "attack.t1059"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 5,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "powershell.exe",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows PowerShell",
      "EventID": 1,
      "EventRecordID": 110434,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=6CBCE4A295C163791B60FC23D285E6D84F28EE4C,MD5=7353F60B1739074EB17C5F4DDDEFE239,SHA256=DE96A6E69944335375DC1AC238336066889D9FFC7D73628EF4FE1B1B160AB32C,IMPHASH=741776AACCFC5B71FF59832DCDCACE0F",
      "IMPHASH": "741776AACCFC5B71FF59832DCDCACE0F",
      "Image": "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-6ABB-5EAD-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "7353F60B1739074EB17C5F4DDDEFE239",
      "Opcode": 0,
      "OriginalFileName": "PowerShell.EXE",
      "OriginalLogfile": "privesc_seimpersonate_tosys_spoolsv_sysmon_17_18.evtx",
      "ParentCommandLine": "PrintSpoofer.exe  -i -c powershell.exe",
      "ParentImage": "C:\\Users\\IEUser\\Tools\\PrivEsc\\PrintSpoofer.exe",
      "ParentProcessGuid": "747F3D96-B592-5EAD-0000-0010ECCBC200",
      "ParentProcessId": 6760,
      "ProcessGuid": "747F3D96-B592-5EAD-0000-0010D4CDC200",
      "ProcessID": 3068,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "6CBCE4A295C163791B60FC23D285E6D84F28EE4C",
      "SHA256": "DE96A6E69944335375DC1AC238336066889D9FFC7D73628EF4FE1B1B160AB32C",
      "SystemTime": "2020-05-02T18:01:54.867394Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 2232,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-05-02 18:01:54.866",
      "Version": 5
    }
  ]
},
{
  "title": "Non Interactive PowerShell Process Spawned",
  "id": "f4bbd493-b796-416e-bbf2-121235348529",
  "description": "Detects non-interactive PowerShell activity by looking at the \"powershell\" process with a non-user GUI process such as \"explorer.exe\" as a parent.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (((Image LIKE '%\\\\powershell.exe' ESCAPE '\\' OR Image LIKE '%\\\\pwsh.exe' ESCAPE '\\') OR (OriginalFileName='PowerShell.EXE' OR OriginalFileName='pwsh.dll')) AND (NOT ((ParentImage LIKE '%:\\\\Windows\\\\explorer.exe' ESCAPE '\\' OR ParentImage LIKE '%:\\\\Windows\\\\System32\\\\CompatTelRunner.exe' ESCAPE '\\' OR ParentImage LIKE '%:\\\\Windows\\\\SysWOW64\\\\explorer.exe' ESCAPE '\\') OR ParentImage LIKE ':\\\\$WINDOWS.~BT\\\\Sources\\\\SetupHost.exe' ESCAPE '\\')) AND (NOT ((ParentImage LIKE '%\\\\AppData\\\\Local\\\\Programs\\\\Microsoft VS Code\\\\Code.exe' ESCAPE '\\' AND ParentCommandLine LIKE '% --ms-enable-electron-run-as-node %' ESCAPE '\\') OR (ParentImage LIKE '%:\\\\Program Files\\\\WindowsApps\\\\Microsoft.WindowsTerminal\\_%' ESCAPE '\\' AND ParentImage LIKE '%\\\\WindowsTerminal.exe' ESCAPE '\\')))))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.execution",
    "attack.t1059.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 5,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "powershell.exe",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows PowerShell",
      "EventID": 1,
      "EventRecordID": 110434,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=6CBCE4A295C163791B60FC23D285E6D84F28EE4C,MD5=7353F60B1739074EB17C5F4DDDEFE239,SHA256=DE96A6E69944335375DC1AC238336066889D9FFC7D73628EF4FE1B1B160AB32C,IMPHASH=741776AACCFC5B71FF59832DCDCACE0F",
      "IMPHASH": "741776AACCFC5B71FF59832DCDCACE0F",
      "Image": "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-6ABB-5EAD-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "7353F60B1739074EB17C5F4DDDEFE239",
      "Opcode": 0,
      "OriginalFileName": "PowerShell.EXE",
      "OriginalLogfile": "privesc_seimpersonate_tosys_spoolsv_sysmon_17_18.evtx",
      "ParentCommandLine": "PrintSpoofer.exe  -i -c powershell.exe",
      "ParentImage": "C:\\Users\\IEUser\\Tools\\PrivEsc\\PrintSpoofer.exe",
      "ParentProcessGuid": "747F3D96-B592-5EAD-0000-0010ECCBC200",
      "ParentProcessId": 6760,
      "ProcessGuid": "747F3D96-B592-5EAD-0000-0010D4CDC200",
      "ProcessID": 3068,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "6CBCE4A295C163791B60FC23D285E6D84F28EE4C",
      "SHA256": "DE96A6E69944335375DC1AC238336066889D9FFC7D73628EF4FE1B1B160AB32C",
      "SystemTime": "2020-05-02T18:01:54.867394Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 2232,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-05-02 18:01:54.866",
      "Version": 5
    }
  ]
},
{
  "title": "Local Accounts Discovery",
  "id": "502b42de-4306-40b4-9596-6f590c81f073",
  "description": "Local accounts, System Owner/User discovery using operating systems utilities",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (((Image LIKE '%\\\\cmd.exe' ESCAPE '\\' AND (CommandLine LIKE '% /c%' ESCAPE '\\' AND CommandLine LIKE '%dir %' ESCAPE '\\' AND CommandLine LIKE '%\\\\Users\\\\%' ESCAPE '\\')) AND (NOT CommandLine LIKE '% rmdir %' ESCAPE '\\')) OR (((Image LIKE '%\\\\net.exe' ESCAPE '\\' OR Image LIKE '%\\\\net1.exe' ESCAPE '\\') AND CommandLine LIKE '%user%' ESCAPE '\\') AND (NOT (CommandLine LIKE '%/domain%' ESCAPE '\\' OR CommandLine LIKE '%/add%' ESCAPE '\\' OR CommandLine LIKE '%/delete%' ESCAPE '\\' OR CommandLine LIKE '%/active%' ESCAPE '\\' OR CommandLine LIKE '%/expires%' ESCAPE '\\' OR CommandLine LIKE '%/passwordreq%' ESCAPE '\\' OR CommandLine LIKE '%/scriptpath%' ESCAPE '\\' OR CommandLine LIKE '%/times%' ESCAPE '\\' OR CommandLine LIKE '%/workstations%' ESCAPE '\\'))) OR (((Image LIKE '%\\\\whoami.exe' ESCAPE '\\' OR Image LIKE '%\\\\quser.exe' ESCAPE '\\' OR Image LIKE '%\\\\qwinsta.exe' ESCAPE '\\') OR (OriginalFileName='whoami.exe' OR OriginalFileName='quser.exe' OR OriginalFileName='qwinsta.exe')) OR (Image LIKE '%\\\\wmic.exe' ESCAPE '\\' AND (CommandLine LIKE '%useraccount%' ESCAPE '\\' AND CommandLine LIKE '%get%' ESCAPE '\\')) OR (Image LIKE '%\\\\cmdkey.exe' ESCAPE '\\' AND CommandLine LIKE '% /l%' ESCAPE '\\'))))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.discovery",
    "attack.t1033",
    "attack.t1087.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 6,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\Windows\\system32\\whoami.exe\"",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "whoami - displays logged on user information",
      "EventID": 1,
      "EventRecordID": 110435,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=47D7864D26FC67E0D60391CBF170D33DA518C322,MD5=43C2D3293AD939241DF61B3630A9D3B6,SHA256=1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A,IMPHASH=7FF0758B766F747CE57DFAC70743FB88",
      "IMPHASH": "7FF0758B766F747CE57DFAC70743FB88",
      "Image": "C:\\Windows\\System32\\whoami.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-6ABB-5EAD-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "43C2D3293AD939241DF61B3630A9D3B6",
      "Opcode": 0,
      "OriginalFileName": "whoami.exe",
      "OriginalLogfile": "privesc_seimpersonate_tosys_spoolsv_sysmon_17_18.evtx",
      "ParentCommandLine": "powershell.exe",
      "ParentImage": "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
      "ParentProcessGuid": "747F3D96-B592-5EAD-0000-0010D4CDC200",
      "ParentProcessId": 1428,
      "ProcessGuid": "747F3D96-B595-5EAD-0000-00106BFDC200",
      "ProcessID": 3068,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "47D7864D26FC67E0D60391CBF170D33DA518C322",
      "SHA256": "1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A",
      "SystemTime": "2020-05-02T18:01:57.418442Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 2232,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-05-02 18:01:57.417",
      "Version": 5
    }
  ]
}]