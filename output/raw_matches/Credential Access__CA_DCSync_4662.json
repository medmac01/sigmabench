[{
  "title": "Active Directory Replication from Non Machine Account",
  "id": "17d619c1-e020-4347-957e-1d1207455c93",
  "description": "Detects potential abuse of Active Directory Replication Service (ADRS) from a non machine account to request credentials.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND ((EventID=4662 AND AccessMask='0x100' AND (Properties LIKE '%1131f6aa-9c07-11d1-f79f-00c04fc2dcd2%' ESCAPE '\\' OR Properties LIKE '%1131f6ad-9c07-11d1-f79f-00c04fc2dcd2%' ESCAPE '\\' OR Properties LIKE '%89e95b76-444d-4c62-991a-0facbeda640c%' ESCAPE '\\')) AND (NOT (SubjectUserName LIKE '%$' ESCAPE '\\' OR SubjectUserName LIKE 'MSOL\\_%' ESCAPE '\\')))"
  ],
  "rule_level": "critical",
  "tags": [
    "attack.credential-access",
    "attack.t1003.006"
  ],
  "count": 3,
  "matches": [
    {
      "row_id": 1,
      "AccessList": "%%7688",
      "AccessMask": "0x100",
      "AdditionalInfo": "-",
      "Channel": "Security",
      "Computer": "DC1.insecurebank.local",
      "EventID": 4662,
      "EventRecordID": 202791,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "HandleId": "0x0",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectName": "%{c6faf700-bfe4-452a-a766-424f84c29583}",
      "ObjectServer": "DS",
      "ObjectType": "%{19195a5b-6da0-11d0-afd3-00c04fd930c9}",
      "Opcode": 0,
      "OperationType": "Object Access",
      "OriginalLogfile": "CA_DCSync_4662.evtx",
      "ProcessID": 444,
      "Properties": "%%7688\r\n\t\t{1131f6aa-9c07-11d1-f79f-00c04fc2dcd2}\r\n\t{19195a5b-6da0-11d0-afd3-00c04fd930c9}",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "SubjectDomainName": "insecurebank",
      "SubjectLogonId": "0x40c6511",
      "SubjectUserName": "Administrator",
      "SubjectUserSid": "S-1-5-21-738609754-2819869699-4189121830-500",
      "SystemTime": "2019-05-08T02:10:43.487217Z",
      "Task": 14080,
      "ThreadID": 4632,
      "Version": 0
    },
    {
      "row_id": 2,
      "AccessList": "%%7688",
      "AccessMask": "0x100",
      "AdditionalInfo": "-",
      "Channel": "Security",
      "Computer": "DC1.insecurebank.local",
      "EventID": 4662,
      "EventRecordID": 202792,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "HandleId": "0x0",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectName": "%{c6faf700-bfe4-452a-a766-424f84c29583}",
      "ObjectServer": "DS",
      "ObjectType": "%{19195a5b-6da0-11d0-afd3-00c04fd930c9}",
      "Opcode": 0,
      "OperationType": "Object Access",
      "OriginalLogfile": "CA_DCSync_4662.evtx",
      "ProcessID": 444,
      "Properties": "%%7688\r\n\t\t{1131f6aa-9c07-11d1-f79f-00c04fc2dcd2}\r\n\t{19195a5b-6da0-11d0-afd3-00c04fd930c9}",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "SubjectDomainName": "insecurebank",
      "SubjectLogonId": "0x40c6511",
      "SubjectUserName": "Administrator",
      "SubjectUserSid": "S-1-5-21-738609754-2819869699-4189121830-500",
      "SystemTime": "2019-05-08T02:10:43.487217Z",
      "Task": 14080,
      "ThreadID": 4632,
      "Version": 0
    },
    {
      "row_id": 3,
      "AccessList": "%%7688",
      "AccessMask": "0x100",
      "AdditionalInfo": "-",
      "Channel": "Security",
      "Computer": "DC1.insecurebank.local",
      "EventID": 4662,
      "EventRecordID": 202793,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "HandleId": "0x0",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectName": "%{c6faf700-bfe4-452a-a766-424f84c29583}",
      "ObjectServer": "DS",
      "ObjectType": "%{19195a5b-6da0-11d0-afd3-00c04fd930c9}",
      "Opcode": 0,
      "OperationType": "Object Access",
      "OriginalLogfile": "CA_DCSync_4662.evtx",
      "ProcessID": 444,
      "Properties": "%%7688\r\n\t\t{1131f6ad-9c07-11d1-f79f-00c04fc2dcd2}\r\n\t{19195a5b-6da0-11d0-afd3-00c04fd930c9}",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "SubjectDomainName": "insecurebank",
      "SubjectLogonId": "0x40c6511",
      "SubjectUserName": "Administrator",
      "SubjectUserSid": "S-1-5-21-738609754-2819869699-4189121830-500",
      "SystemTime": "2019-05-08T02:10:43.487217Z",
      "Task": 14080,
      "ThreadID": 4632,
      "Version": 0
    }
  ]
},
{
  "title": "Mimikatz DC Sync",
  "id": "611eab06-a145-4dfa-a295-3ccc5c20f59a",
  "description": "Detects Mimikatz DC sync security events",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND ((EventID=4662 AND (Properties LIKE '%Replicating Directory Changes All%' ESCAPE '\\' OR Properties LIKE '%1131f6ad-9c07-11d1-f79f-00c04fc2dcd2%' ESCAPE '\\' OR Properties LIKE '%1131f6aa-9c07-11d1-f79f-00c04fc2dcd2%' ESCAPE '\\' OR Properties LIKE '%9923a32a-3607-11d2-b9be-0000f87a36b2%' ESCAPE '\\' OR Properties LIKE '%89e95b76-444d-4c62-991a-0facbeda640c%' ESCAPE '\\') AND AccessMask='0x100') AND (NOT (SubjectDomainName='Window Manager' OR (SubjectUserName LIKE 'NT AUT%' ESCAPE '\\' OR SubjectUserName LIKE 'MSOL\\_%' ESCAPE '\\') OR SubjectUserName LIKE '%$' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.credential-access",
    "attack.s0002",
    "attack.t1003.006"
  ],
  "count": 3,
  "matches": [
    {
      "row_id": 1,
      "AccessList": "%%7688",
      "AccessMask": "0x100",
      "AdditionalInfo": "-",
      "Channel": "Security",
      "Computer": "DC1.insecurebank.local",
      "EventID": 4662,
      "EventRecordID": 202791,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "HandleId": "0x0",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectName": "%{c6faf700-bfe4-452a-a766-424f84c29583}",
      "ObjectServer": "DS",
      "ObjectType": "%{19195a5b-6da0-11d0-afd3-00c04fd930c9}",
      "Opcode": 0,
      "OperationType": "Object Access",
      "OriginalLogfile": "CA_DCSync_4662.evtx",
      "ProcessID": 444,
      "Properties": "%%7688\r\n\t\t{1131f6aa-9c07-11d1-f79f-00c04fc2dcd2}\r\n\t{19195a5b-6da0-11d0-afd3-00c04fd930c9}",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "SubjectDomainName": "insecurebank",
      "SubjectLogonId": "0x40c6511",
      "SubjectUserName": "Administrator",
      "SubjectUserSid": "S-1-5-21-738609754-2819869699-4189121830-500",
      "SystemTime": "2019-05-08T02:10:43.487217Z",
      "Task": 14080,
      "ThreadID": 4632,
      "Version": 0
    },
    {
      "row_id": 2,
      "AccessList": "%%7688",
      "AccessMask": "0x100",
      "AdditionalInfo": "-",
      "Channel": "Security",
      "Computer": "DC1.insecurebank.local",
      "EventID": 4662,
      "EventRecordID": 202792,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "HandleId": "0x0",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectName": "%{c6faf700-bfe4-452a-a766-424f84c29583}",
      "ObjectServer": "DS",
      "ObjectType": "%{19195a5b-6da0-11d0-afd3-00c04fd930c9}",
      "Opcode": 0,
      "OperationType": "Object Access",
      "OriginalLogfile": "CA_DCSync_4662.evtx",
      "ProcessID": 444,
      "Properties": "%%7688\r\n\t\t{1131f6aa-9c07-11d1-f79f-00c04fc2dcd2}\r\n\t{19195a5b-6da0-11d0-afd3-00c04fd930c9}",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "SubjectDomainName": "insecurebank",
      "SubjectLogonId": "0x40c6511",
      "SubjectUserName": "Administrator",
      "SubjectUserSid": "S-1-5-21-738609754-2819869699-4189121830-500",
      "SystemTime": "2019-05-08T02:10:43.487217Z",
      "Task": 14080,
      "ThreadID": 4632,
      "Version": 0
    },
    {
      "row_id": 3,
      "AccessList": "%%7688",
      "AccessMask": "0x100",
      "AdditionalInfo": "-",
      "Channel": "Security",
      "Computer": "DC1.insecurebank.local",
      "EventID": 4662,
      "EventRecordID": 202793,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "HandleId": "0x0",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectName": "%{c6faf700-bfe4-452a-a766-424f84c29583}",
      "ObjectServer": "DS",
      "ObjectType": "%{19195a5b-6da0-11d0-afd3-00c04fd930c9}",
      "Opcode": 0,
      "OperationType": "Object Access",
      "OriginalLogfile": "CA_DCSync_4662.evtx",
      "ProcessID": 444,
      "Properties": "%%7688\r\n\t\t{1131f6ad-9c07-11d1-f79f-00c04fc2dcd2}\r\n\t{19195a5b-6da0-11d0-afd3-00c04fd930c9}",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "SubjectDomainName": "insecurebank",
      "SubjectLogonId": "0x40c6511",
      "SubjectUserName": "Administrator",
      "SubjectUserSid": "S-1-5-21-738609754-2819869699-4189121830-500",
      "SystemTime": "2019-05-08T02:10:43.487217Z",
      "Task": 14080,
      "ThreadID": 4632,
      "Version": 0
    }
  ]
}]