[{
  "title": "Whoami.EXE Execution From Privileged Process",
  "id": "79ce34ca-af29-4d0e-b832-fc1b377020db",
  "description": "Detects the execution of \"whoami.exe\" by privileged accounts that are often abused by threat actors",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((OriginalFileName='whoami.exe' OR Image LIKE '%\\\\whoami.exe' ESCAPE '\\') AND (User LIKE '%AUTHORI%' ESCAPE '\\' OR User LIKE '%AUTORI%' ESCAPE '\\' OR User LIKE '%TrustedInstaller%' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.discovery",
    "attack.t1033"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 6,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "whoami",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "whoami - displays logged on user information",
      "EventID": 1,
      "EventRecordID": 196375,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=47D7864D26FC67E0D60391CBF170D33DA518C322,MD5=43C2D3293AD939241DF61B3630A9D3B6,SHA256=1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A,IMPHASH=7FF0758B766F747CE57DFAC70743FB88",
      "IMPHASH": "7FF0758B766F747CE57DFAC70743FB88",
      "Image": "C:\\Windows\\System32\\whoami.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-BDD1-5EC9-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "43C2D3293AD939241DF61B3630A9D3B6",
      "Opcode": 0,
      "OriginalFileName": "whoami.exe",
      "OriginalLogfile": "RogueWinRM.evtx",
      "ParentCommandLine": "c:\\Windows\\System32\\cmd.exe",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "747F3D96-CA4E-5EC9-0000-00109FE23700",
      "ParentProcessId": 1516,
      "ProcessGuid": "747F3D96-CA52-5EC9-0000-001027FA3700",
      "ProcessID": 2812,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "47D7864D26FC67E0D60391CBF170D33DA518C322",
      "SHA256": "1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A",
      "SystemTime": "2020-05-24T01:13:54.120170Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 3656,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-05-24 01:13:54.117",
      "Version": 5
    }
  ]
},
{
  "title": "Elevated System Shell Spawned From Uncommon Parent Location",
  "id": "178e615d-e666-498b-9630-9ed363038101",
  "description": "Detects when a shell program such as the Windows command prompt or PowerShell is launched with system privileges from a uncommon parent location.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((((Image LIKE '%\\\\powershell.exe' ESCAPE '\\' OR Image LIKE '%\\\\powershell\\_ise.exe' ESCAPE '\\' OR Image LIKE '%\\\\pwsh.exe' ESCAPE '\\' OR Image LIKE '%\\\\cmd.exe' ESCAPE '\\') OR (OriginalFileName='PowerShell.EXE' OR OriginalFileName LIKE 'powershell\\_ise.EXE' ESCAPE '\\' OR OriginalFileName='pwsh.dll' OR OriginalFileName='Cmd.Exe')) AND ((User LIKE '%AUTHORI%' ESCAPE '\\' OR User LIKE '%AUTORI%' ESCAPE '\\') AND LogonId='0x3e7')) AND (NOT ((ParentImage LIKE '%:\\\\Program Files (x86)\\\\%' ESCAPE '\\' OR ParentImage LIKE '%:\\\\Program Files\\\\%' ESCAPE '\\' OR ParentImage LIKE '%:\\\\ProgramData\\\\%' ESCAPE '\\' OR ParentImage LIKE '%:\\\\Windows\\\\System32\\\\%' ESCAPE '\\' OR ParentImage LIKE '%:\\\\Windows\\\\SysWOW64\\\\%' ESCAPE '\\' OR ParentImage LIKE '%:\\\\Windows\\\\Temp\\\\%' ESCAPE '\\' OR ParentImage LIKE '%:\\\\Windows\\\\WinSxS\\\\%' ESCAPE '\\') OR ParentImage IS NULL OR (ParentImage='' OR ParentImage='-'))) AND (NOT ((ParentImage LIKE '%:\\\\ManageEngine\\\\ADManager Plus\\\\pgsql\\\\bin\\\\postgres.exe' ESCAPE '\\' AND Image LIKE '%\\\\cmd.exe' ESCAPE '\\') OR (CommandLine LIKE '%:\\\\WINDOWS\\\\system32\\\\cmd.exe /c \"%' ESCAPE '\\' AND CurrentDirectory LIKE '%:\\\\WINDOWS\\\\Temp\\\\asgard2-agent\\\\%' ESCAPE '\\') OR (ParentImage LIKE '%:\\\\IBM\\\\SpectrumProtect\\\\webserver\\\\scripts\\\\%' ESCAPE '\\' AND CommandLine LIKE '%:\\\\IBM\\\\SpectrumProtect\\\\webserver\\\\scripts\\\\%' ESCAPE '\\')))))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.privilege-escalation",
    "attack.defense-evasion",
    "attack.execution",
    "attack.t1059"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 3,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "c:\\Windows\\System32\\cmd.exe",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows Command Processor",
      "EventID": 1,
      "EventRecordID": 196371,
      "FileVersion": "10.0.17763.592 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=8C5437CD76A89EC983E3B364E219944DA3DAB464,MD5=975B45B669930B0CC773EAF2B414206F,SHA256=3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2,IMPHASH=272245E2988E1E430500B852C4FB5E18",
      "IMPHASH": "272245E2988E1E430500B852C4FB5E18",
      "Image": "C:\\Windows\\System32\\cmd.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-BDD1-5EC9-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "975B45B669930B0CC773EAF2B414206F",
      "Opcode": 0,
      "OriginalFileName": "Cmd.Exe",
      "OriginalLogfile": "RogueWinRM.evtx",
      "ParentCommandLine": "RogueWinRM.exe  -p c:\\Windows\\System32\\cmd.exe",
      "ParentImage": "C:\\Users\\IEUser\\Tools\\PrivEsc\\RogueWinRM.exe",
      "ParentProcessGuid": "747F3D96-CA4B-5EC9-0000-0010B8CB3700",
      "ParentProcessId": 3960,
      "ProcessGuid": "747F3D96-CA4E-5EC9-0000-00109FE23700",
      "ProcessID": 2812,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "8C5437CD76A89EC983E3B364E219944DA3DAB464",
      "SHA256": "3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2",
      "SystemTime": "2020-05-24T01:13:50.327170Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 3656,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-05-24 01:13:50.301",
      "Version": 5
    }
  ]
},
{
  "title": "Local Accounts Discovery",
  "id": "502b42de-4306-40b4-9596-6f590c81f073",
  "description": "Local accounts, System Owner/User discovery using operating systems utilities",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (((Image LIKE '%\\\\cmd.exe' ESCAPE '\\' AND (CommandLine LIKE '% /c%' ESCAPE '\\' AND CommandLine LIKE '%dir %' ESCAPE '\\' AND CommandLine LIKE '%\\\\Users\\\\%' ESCAPE '\\')) AND (NOT CommandLine LIKE '% rmdir %' ESCAPE '\\')) OR (((Image LIKE '%\\\\net.exe' ESCAPE '\\' OR Image LIKE '%\\\\net1.exe' ESCAPE '\\') AND CommandLine LIKE '%user%' ESCAPE '\\') AND (NOT (CommandLine LIKE '%/domain%' ESCAPE '\\' OR CommandLine LIKE '%/add%' ESCAPE '\\' OR CommandLine LIKE '%/delete%' ESCAPE '\\' OR CommandLine LIKE '%/active%' ESCAPE '\\' OR CommandLine LIKE '%/expires%' ESCAPE '\\' OR CommandLine LIKE '%/passwordreq%' ESCAPE '\\' OR CommandLine LIKE '%/scriptpath%' ESCAPE '\\' OR CommandLine LIKE '%/times%' ESCAPE '\\' OR CommandLine LIKE '%/workstations%' ESCAPE '\\'))) OR (((Image LIKE '%\\\\whoami.exe' ESCAPE '\\' OR Image LIKE '%\\\\quser.exe' ESCAPE '\\' OR Image LIKE '%\\\\qwinsta.exe' ESCAPE '\\') OR (OriginalFileName='whoami.exe' OR OriginalFileName='quser.exe' OR OriginalFileName='qwinsta.exe')) OR (Image LIKE '%\\\\wmic.exe' ESCAPE '\\' AND (CommandLine LIKE '%useraccount%' ESCAPE '\\' AND CommandLine LIKE '%get%' ESCAPE '\\')) OR (Image LIKE '%\\\\cmdkey.exe' ESCAPE '\\' AND CommandLine LIKE '% /l%' ESCAPE '\\'))))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.discovery",
    "attack.t1033",
    "attack.t1087.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 6,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "whoami",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "whoami - displays logged on user information",
      "EventID": 1,
      "EventRecordID": 196375,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=47D7864D26FC67E0D60391CBF170D33DA518C322,MD5=43C2D3293AD939241DF61B3630A9D3B6,SHA256=1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A,IMPHASH=7FF0758B766F747CE57DFAC70743FB88",
      "IMPHASH": "7FF0758B766F747CE57DFAC70743FB88",
      "Image": "C:\\Windows\\System32\\whoami.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-BDD1-5EC9-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "43C2D3293AD939241DF61B3630A9D3B6",
      "Opcode": 0,
      "OriginalFileName": "whoami.exe",
      "OriginalLogfile": "RogueWinRM.evtx",
      "ParentCommandLine": "c:\\Windows\\System32\\cmd.exe",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "747F3D96-CA4E-5EC9-0000-00109FE23700",
      "ParentProcessId": 1516,
      "ProcessGuid": "747F3D96-CA52-5EC9-0000-001027FA3700",
      "ProcessID": 2812,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "47D7864D26FC67E0D60391CBF170D33DA518C322",
      "SHA256": "1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A",
      "SystemTime": "2020-05-24T01:13:54.120170Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 3656,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-05-24 01:13:54.117",
      "Version": 5
    }
  ]
}]