[{
  "title": "Whoami.EXE Execution From Privileged Process",
  "id": "79ce34ca-af29-4d0e-b832-fc1b377020db",
  "description": "Detects the execution of \"whoami.exe\" by privileged accounts that are often abused by threat actors",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((OriginalFileName='whoami.exe' OR Image LIKE '%\\\\whoami.exe' ESCAPE '\\') AND (User LIKE '%AUTHORI%' ESCAPE '\\' OR User LIKE '%AUTORI%' ESCAPE '\\' OR User LIKE '%TrustedInstaller%' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.discovery",
    "attack.t1033"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 10,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "whoami",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "whoami - displays logged on user information",
      "EventID": 1,
      "EventRecordID": 339891,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=47D7864D26FC67E0D60391CBF170D33DA518C322,MD5=43C2D3293AD939241DF61B3630A9D3B6,SHA256=1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A,IMPHASH=7FF0758B766F747CE57DFAC70743FB88",
      "IMPHASH": "7FF0758B766F747CE57DFAC70743FB88",
      "Image": "C:\\Windows\\System32\\whoami.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-E308-5F26-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "43C2D3293AD939241DF61B3630A9D3B6",
      "Opcode": 0,
      "OriginalFileName": "whoami.exe",
      "OriginalLogfile": "faxhell_sysmon_7_1_18_3_bindshell_dllhijack.evtx",
      "ParentCommandLine": "\"c:\\windows\\system32\\cmd.exe\"",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "747F3D96-E8BA-5F26-0000-001035BE1A00",
      "ParentProcessId": 8104,
      "ProcessGuid": "747F3D96-E8BC-5F26-0000-0010F7C41A00",
      "ProcessID": 3200,
      "Product": "Microsoft速 Windows速 Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "47D7864D26FC67E0D60391CBF170D33DA518C322",
      "SHA256": "1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A",
      "SystemTime": "2020-08-02T16:24:28.640990Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 3032,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-08-02 16:24:28.637",
      "Version": 5
    }
  ]
},
{
  "title": "Fax Service DLL Search Order Hijack",
  "id": "828af599-4c53-4ed2-ba4a-a9f835c434ea",
  "description": "The Fax service attempts to load ualapi.dll, which is non-existent. An attacker can then (side)load their own malicious DLL using this service.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=7 AND ((Image LIKE '%\\\\fxssvc.exe' ESCAPE '\\' AND ImageLoaded LIKE '%ualapi.dll' ESCAPE '\\') AND (NOT ImageLoaded LIKE 'C:\\\\Windows\\\\WinSxS\\\\%' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.persistence",
    "attack.defense-evasion",
    "attack.t1574.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Company": "?",
      "Computer": "MSEDGEWIN10",
      "Description": "?",
      "EventID": 7,
      "EventRecordID": 339882,
      "FileVersion": "?",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=9D1873AEFC3F59E649F3FB822C1FA3D52C39970E,MD5=9B97E05E67107AA18BBF3E4F5F121B2B,SHA256=9915C62360EFF866C09072AF754FA70A9BD4BF4A73CDB4048F415002F7256AD0,IMPHASH=DF1295012B8EB2127DC3667CF1881634",
      "IMPHASH": "DF1295012B8EB2127DC3667CF1881634",
      "Image": "C:\\Windows\\System32\\FXSSVC.exe",
      "ImageLoaded": "C:\\Windows\\System32\\Ualapi.dll",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "MD5": "9B97E05E67107AA18BBF3E4F5F121B2B",
      "Opcode": 0,
      "OriginalFileName": "?",
      "OriginalLogfile": "faxhell_sysmon_7_1_18_3_bindshell_dllhijack.evtx",
      "ProcessGuid": "747F3D96-E8A7-5F26-0000-0010230D1A00",
      "ProcessID": 3200,
      "Product": "?",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "9D1873AEFC3F59E649F3FB822C1FA3D52C39970E",
      "SHA256": "9915C62360EFF866C09072AF754FA70A9BD4BF4A73CDB4048F415002F7256AD0",
      "SignatureStatus": "Unavailable",
      "Signed": "false",
      "SystemTime": "2020-08-02T16:24:07.551366Z",
      "Task": 7,
      "ThreadID": 3596,
      "UserID": "S-1-5-18",
      "UtcTime": "2020-08-02 16:24:07.483",
      "Version": 3
    }
  ]
},
{
  "title": "Local Accounts Discovery",
  "id": "502b42de-4306-40b4-9596-6f590c81f073",
  "description": "Local accounts, System Owner/User discovery using operating systems utilities",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (((Image LIKE '%\\\\cmd.exe' ESCAPE '\\' AND (CommandLine LIKE '% /c%' ESCAPE '\\' AND CommandLine LIKE '%dir %' ESCAPE '\\' AND CommandLine LIKE '%\\\\Users\\\\%' ESCAPE '\\')) AND (NOT CommandLine LIKE '% rmdir %' ESCAPE '\\')) OR (((Image LIKE '%\\\\net.exe' ESCAPE '\\' OR Image LIKE '%\\\\net1.exe' ESCAPE '\\') AND CommandLine LIKE '%user%' ESCAPE '\\') AND (NOT (CommandLine LIKE '%/domain%' ESCAPE '\\' OR CommandLine LIKE '%/add%' ESCAPE '\\' OR CommandLine LIKE '%/delete%' ESCAPE '\\' OR CommandLine LIKE '%/active%' ESCAPE '\\' OR CommandLine LIKE '%/expires%' ESCAPE '\\' OR CommandLine LIKE '%/passwordreq%' ESCAPE '\\' OR CommandLine LIKE '%/scriptpath%' ESCAPE '\\' OR CommandLine LIKE '%/times%' ESCAPE '\\' OR CommandLine LIKE '%/workstations%' ESCAPE '\\'))) OR (((Image LIKE '%\\\\whoami.exe' ESCAPE '\\' OR Image LIKE '%\\\\quser.exe' ESCAPE '\\' OR Image LIKE '%\\\\qwinsta.exe' ESCAPE '\\') OR (OriginalFileName='whoami.exe' OR OriginalFileName='quser.exe' OR OriginalFileName='qwinsta.exe')) OR (Image LIKE '%\\\\wmic.exe' ESCAPE '\\' AND (CommandLine LIKE '%useraccount%' ESCAPE '\\' AND CommandLine LIKE '%get%' ESCAPE '\\')) OR (Image LIKE '%\\\\cmdkey.exe' ESCAPE '\\' AND CommandLine LIKE '% /l%' ESCAPE '\\'))))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.discovery",
    "attack.t1033",
    "attack.t1087.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 10,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "whoami",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "whoami - displays logged on user information",
      "EventID": 1,
      "EventRecordID": 339891,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=47D7864D26FC67E0D60391CBF170D33DA518C322,MD5=43C2D3293AD939241DF61B3630A9D3B6,SHA256=1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A,IMPHASH=7FF0758B766F747CE57DFAC70743FB88",
      "IMPHASH": "7FF0758B766F747CE57DFAC70743FB88",
      "Image": "C:\\Windows\\System32\\whoami.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-E308-5F26-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "43C2D3293AD939241DF61B3630A9D3B6",
      "Opcode": 0,
      "OriginalFileName": "whoami.exe",
      "OriginalLogfile": "faxhell_sysmon_7_1_18_3_bindshell_dllhijack.evtx",
      "ParentCommandLine": "\"c:\\windows\\system32\\cmd.exe\"",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "747F3D96-E8BA-5F26-0000-001035BE1A00",
      "ParentProcessId": 8104,
      "ProcessGuid": "747F3D96-E8BC-5F26-0000-0010F7C41A00",
      "ProcessID": 3200,
      "Product": "Microsoft速 Windows速 Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "47D7864D26FC67E0D60391CBF170D33DA518C322",
      "SHA256": "1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A",
      "SystemTime": "2020-08-02T16:24:28.640990Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 3032,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-08-02 16:24:28.637",
      "Version": 5
    }
  ]
}]