[{
  "title": "UAC Bypass Using Consent and Comctl32 - Process",
  "id": "1ca6bd18-0ba0-44ca-851c-92ed89a61085",
  "description": "Detects the pattern of UAC Bypass using consent.exe and comctl32.dll (UACMe 22)",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (ParentImage LIKE '%\\\\consent.exe' ESCAPE '\\' AND Image LIKE '%\\\\werfault.exe' ESCAPE '\\' AND (IntegrityLevel='High' OR IntegrityLevel='System' OR IntegrityLevel='S-1-16-16384' OR IntegrityLevel='S-1-16-12288')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.privilege-escalation",
    "attack.t1548.002"
  ],
  "count": 2,
  "matches": [
    {
      "row_id": 9,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "C:\\Windows\\system32\\WerFault.exe -u -p 4740 -s 128",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows Problem Reporting",
      "EventID": 1,
      "EventRecordID": 5445,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=1B59C8D752E031AF4C6B0B02F3780E7156AAEECF,MD5=603A88C6EC5CA36FC9C382F9A2EA9105,SHA256=DFAE5391EA274620F2B025976DC9787051EE416AEB360F68F20B108323924955,IMPHASH=3B9DE67ACC19291D79083D12452FA5BA",
      "IMPHASH": "3B9DE67ACC19291D79083D12452FA5BA",
      "Image": "C:\\Windows\\System32\\WerFault.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-D4E9-5D45-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "603A88C6EC5CA36FC9C382F9A2EA9105",
      "Opcode": 0,
      "OriginalLogfile": "Sysmon_UACME_22.evtx",
      "ParentCommandLine": "consent.exe 896 318 0000028064471300",
      "ParentImage": "C:\\Windows\\System32\\consent.exe",
      "ParentProcessGuid": "747F3D96-7930-5D45-0000-001055DE0601",
      "ParentProcessId": 4740,
      "ProcessGuid": "747F3D96-7930-5D45-0000-001085EE0601",
      "ProcessID": 2780,
      "Product": "Microsoft速 Windows速 Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "1B59C8D752E031AF4C6B0B02F3780E7156AAEECF",
      "SHA256": "DFAE5391EA274620F2B025976DC9787051EE416AEB360F68F20B108323924955",
      "SystemTime": "2019-08-03T12:08:16.853765Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 3676,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-08-03 12:08:16.578",
      "Version": 5
    },
    {
      "row_id": 14,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "C:\\Windows\\system32\\WerFault.exe -u -p 7564 -s 152",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows Problem Reporting",
      "EventID": 1,
      "EventRecordID": 5450,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=1B59C8D752E031AF4C6B0B02F3780E7156AAEECF,MD5=603A88C6EC5CA36FC9C382F9A2EA9105,SHA256=DFAE5391EA274620F2B025976DC9787051EE416AEB360F68F20B108323924955,IMPHASH=3B9DE67ACC19291D79083D12452FA5BA",
      "IMPHASH": "3B9DE67ACC19291D79083D12452FA5BA",
      "Image": "C:\\Windows\\System32\\WerFault.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-D4E9-5D45-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "603A88C6EC5CA36FC9C382F9A2EA9105",
      "Opcode": 0,
      "OriginalLogfile": "Sysmon_UACME_22.evtx",
      "ParentCommandLine": "consent.exe 896 272 00000280644BC500",
      "ParentImage": "C:\\Windows\\System32\\consent.exe",
      "ParentProcessGuid": "747F3D96-7934-5D45-0000-0010CAB90701",
      "ParentProcessId": 7564,
      "ProcessGuid": "747F3D96-7935-5D45-0000-001066CA0701",
      "ProcessID": 2780,
      "Product": "Microsoft速 Windows速 Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "1B59C8D752E031AF4C6B0B02F3780E7156AAEECF",
      "SHA256": "DFAE5391EA274620F2B025976DC9787051EE416AEB360F68F20B108323924955",
      "SystemTime": "2019-08-03T12:08:21.954597Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 3676,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-08-03 12:08:21.036",
      "Version": 5
    }
  ]
},
{
  "title": "Potential DLL Sideloading Via comctl32.dll",
  "id": "6360757a-d460-456c-8b13-74cf0e60cceb",
  "description": "Detects potential DLL sideloading using comctl32.dll to obtain system privileges",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=7 AND ((ImageLoaded LIKE 'C:\\\\Windows\\\\System32\\\\logonUI.exe.local\\\\%' ESCAPE '\\' OR ImageLoaded LIKE 'C:\\\\Windows\\\\System32\\\\werFault.exe.local\\\\%' ESCAPE '\\' OR ImageLoaded LIKE 'C:\\\\Windows\\\\System32\\\\consent.exe.local\\\\%' ESCAPE '\\' OR ImageLoaded LIKE 'C:\\\\Windows\\\\System32\\\\narrator.exe.local\\\\%' ESCAPE '\\' OR ImageLoaded LIKE 'C:\\\\windows\\\\system32\\\\wermgr.exe.local\\\\%' ESCAPE '\\') AND ImageLoaded LIKE '%\\\\comctl32.dll' ESCAPE '\\'))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.persistence",
    "attack.privilege-escalation",
    "attack.t1574.001"
  ],
  "count": 2,
  "matches": [
    {
      "row_id": 10,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Company": "Hazardous Environments",
      "Computer": "MSEDGEWIN10",
      "Description": "UACMe proxy DLL",
      "EventID": 7,
      "EventRecordID": 5446,
      "FileVersion": "3.1.8.1904",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=A309A622B9D4A62CFE59B73FDD32BD8384E66628,MD5=9E5AED3F57CEBC5154F9373B2BB9BA05,SHA256=FF40C2F8E6635F4D33997EB928C72C1293C5A844185DFDD3FD444FFD8C959E80,IMPHASH=1C6B5C991BBBDC2B578EA7DEEF4AFA1B",
      "IMPHASH": "1C6B5C991BBBDC2B578EA7DEEF4AFA1B",
      "Image": "C:\\Windows\\System32\\consent.exe",
      "ImageLoaded": "C:\\Windows\\System32\\consent.exe.local\\amd64_microsoft.windows.common-controls_6595b64144ccf1df_6.0.17763.615_none_05b4414a072024d4\\comctl32.dll",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "MD5": "9E5AED3F57CEBC5154F9373B2BB9BA05",
      "Opcode": 0,
      "OriginalLogfile": "Sysmon_UACME_22.evtx",
      "ProcessGuid": "747F3D96-7930-5D45-0000-001055DE0601",
      "ProcessID": 2780,
      "Product": "UACMe",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "PrivEsc - DLL Hijack - UACME 22",
      "SHA1": "A309A622B9D4A62CFE59B73FDD32BD8384E66628",
      "SHA256": "FF40C2F8E6635F4D33997EB928C72C1293C5A844185DFDD3FD444FFD8C959E80",
      "SignatureStatus": "Unavailable",
      "Signed": "false",
      "SystemTime": "2019-08-03T12:08:19.888068Z",
      "Task": 7,
      "ThreadID": 3680,
      "UserID": "S-1-5-18",
      "UtcTime": "2019-08-03 12:08:19.877",
      "Version": 3
    },
    {
      "row_id": 15,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Company": "Hazardous Environments",
      "Computer": "MSEDGEWIN10",
      "Description": "UACMe proxy DLL",
      "EventID": 7,
      "EventRecordID": 5451,
      "FileVersion": "3.1.8.1904",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=A309A622B9D4A62CFE59B73FDD32BD8384E66628,MD5=9E5AED3F57CEBC5154F9373B2BB9BA05,SHA256=FF40C2F8E6635F4D33997EB928C72C1293C5A844185DFDD3FD444FFD8C959E80,IMPHASH=1C6B5C991BBBDC2B578EA7DEEF4AFA1B",
      "IMPHASH": "1C6B5C991BBBDC2B578EA7DEEF4AFA1B",
      "Image": "C:\\Windows\\System32\\consent.exe",
      "ImageLoaded": "C:\\Windows\\System32\\consent.exe.local\\amd64_microsoft.windows.common-controls_6595b64144ccf1df_6.0.17763.615_none_05b4414a072024d4\\comctl32.dll",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "MD5": "9E5AED3F57CEBC5154F9373B2BB9BA05",
      "Opcode": 0,
      "OriginalLogfile": "Sysmon_UACME_22.evtx",
      "ProcessGuid": "747F3D96-7934-5D45-0000-0010CAB90701",
      "ProcessID": 2780,
      "Product": "UACMe",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "PrivEsc - DLL Hijack - UACME 22",
      "SHA1": "A309A622B9D4A62CFE59B73FDD32BD8384E66628",
      "SHA256": "FF40C2F8E6635F4D33997EB928C72C1293C5A844185DFDD3FD444FFD8C959E80",
      "SignatureStatus": "Unavailable",
      "Signed": "false",
      "SystemTime": "2019-08-03T12:08:23.524314Z",
      "Task": 7,
      "ThreadID": 3676,
      "UserID": "S-1-5-18",
      "UtcTime": "2019-08-03 12:08:23.363",
      "Version": 3
    }
  ]
}]