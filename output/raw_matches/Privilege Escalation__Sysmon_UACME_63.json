[{
  "title": "MMC Spawning Windows Shell",
  "id": "05a2ab7e-ce11-4b63-86db-ab32e763e11d",
  "description": "Detects a Windows command line executable started from MMC",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (ParentImage LIKE '%\\\\mmc.exe' ESCAPE '\\' AND ((Image LIKE '%\\\\cmd.exe' ESCAPE '\\' OR Image LIKE '%\\\\powershell.exe' ESCAPE '\\' OR Image LIKE '%\\\\pwsh.exe' ESCAPE '\\' OR Image LIKE '%\\\\wscript.exe' ESCAPE '\\' OR Image LIKE '%\\\\cscript.exe' ESCAPE '\\' OR Image LIKE '%\\\\sh.exe' ESCAPE '\\' OR Image LIKE '%\\\\bash.exe' ESCAPE '\\' OR Image LIKE '%\\\\reg.exe' ESCAPE '\\' OR Image LIKE '%\\\\regsvr32.exe' ESCAPE '\\') OR Image LIKE '%\\\\BITSADMIN%' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.lateral-movement",
    "attack.t1021.003"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\windows\\system32\\cmd.exe\"",
      "Company": "Microsoft Corporation",
      "Computer": "LAPTOP-JU4M3I0E",
      "CurrentDirectory": "C:\\windows\\system32\\",
      "Description": "Windows Command Processor",
      "EventID": 1,
      "EventRecordID": 2164913,
      "FileVersion": "10.0.18362.449 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=8DCA9749CD48D286950E7A9FA1088C937CBCCAD4,MD5=D7AB69FAD18D4A643D84A271DFC0DBDF,SHA256=FF79D3C4A0B7EB191783C323AB8363EBD1FD10BE58D8BCC96B07067743CA81D5,IMPHASH=272245E2988E1E430500B852C4FB5E18",
      "IMPHASH": "272245E2988E1E430500B852C4FB5E18",
      "Image": "C:\\Windows\\System32\\cmd.exe",
      "IntegrityLevel": "High",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "00247C92-8C36-5F75-0000-002034E39103",
      "LogonId": "0x391e334",
      "MD5": "D7AB69FAD18D4A643D84A271DFC0DBDF",
      "Opcode": 0,
      "OriginalFileName": "Cmd.Exe",
      "OriginalLogfile": "Sysmon_UACME_63.evtx",
      "ParentCommandLine": "\"C:\\Windows\\System32\\mmc.exe\" WF.msc",
      "ParentImage": "C:\\Windows\\System32\\mmc.exe",
      "ParentProcessGuid": "00247C92-9E03-5F7B-0000-0010A645272C",
      "ParentProcessId": 20228,
      "ProcessGuid": "00247C92-9E04-5F7B-0000-0010CF98272C",
      "ProcessID": 5424,
      "Product": "Microsoft速 Windows速 Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "8DCA9749CD48D286950E7A9FA1088C937CBCCAD4",
      "SHA256": "FF79D3C4A0B7EB191783C323AB8363EBD1FD10BE58D8BCC96B07067743CA81D5",
      "SystemTime": "2020-10-05T22:28:20.530062Z",
      "Task": 1,
      "TerminalSessionId": 2,
      "ThreadID": 6708,
      "User": "LAPTOP-JU4M3I0E\\bouss",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-10-05 22:28:20.529",
      "Version": 5
    }
  ]
},
{
  "title": "UAC Bypass via Windows Firewall Snap-In Hijack",
  "id": "e52cb31c-10ed-4aea-bcb7-593c9f4a315b",
  "description": "Detects attempts to bypass User Account Control (UAC) by hijacking the Microsoft Management Console (MMC) Windows Firewall snap-in",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((ParentImage LIKE '%\\\\mmc.exe' ESCAPE '\\' AND ParentCommandLine LIKE '%WF.msc%' ESCAPE '\\') AND (NOT Image LIKE '%\\\\WerFault.exe' ESCAPE '\\')))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.defense-evasion",
    "attack.privilege-escalation",
    "attack.t1548"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\windows\\system32\\cmd.exe\"",
      "Company": "Microsoft Corporation",
      "Computer": "LAPTOP-JU4M3I0E",
      "CurrentDirectory": "C:\\windows\\system32\\",
      "Description": "Windows Command Processor",
      "EventID": 1,
      "EventRecordID": 2164913,
      "FileVersion": "10.0.18362.449 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=8DCA9749CD48D286950E7A9FA1088C937CBCCAD4,MD5=D7AB69FAD18D4A643D84A271DFC0DBDF,SHA256=FF79D3C4A0B7EB191783C323AB8363EBD1FD10BE58D8BCC96B07067743CA81D5,IMPHASH=272245E2988E1E430500B852C4FB5E18",
      "IMPHASH": "272245E2988E1E430500B852C4FB5E18",
      "Image": "C:\\Windows\\System32\\cmd.exe",
      "IntegrityLevel": "High",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "00247C92-8C36-5F75-0000-002034E39103",
      "LogonId": "0x391e334",
      "MD5": "D7AB69FAD18D4A643D84A271DFC0DBDF",
      "Opcode": 0,
      "OriginalFileName": "Cmd.Exe",
      "OriginalLogfile": "Sysmon_UACME_63.evtx",
      "ParentCommandLine": "\"C:\\Windows\\System32\\mmc.exe\" WF.msc",
      "ParentImage": "C:\\Windows\\System32\\mmc.exe",
      "ParentProcessGuid": "00247C92-9E03-5F7B-0000-0010A645272C",
      "ParentProcessId": 20228,
      "ProcessGuid": "00247C92-9E04-5F7B-0000-0010CF98272C",
      "ProcessID": 5424,
      "Product": "Microsoft速 Windows速 Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "8DCA9749CD48D286950E7A9FA1088C937CBCCAD4",
      "SHA256": "FF79D3C4A0B7EB191783C323AB8363EBD1FD10BE58D8BCC96B07067743CA81D5",
      "SystemTime": "2020-10-05T22:28:20.530062Z",
      "Task": 1,
      "TerminalSessionId": 2,
      "ThreadID": 6708,
      "User": "LAPTOP-JU4M3I0E\\bouss",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-10-05 22:28:20.529",
      "Version": 5
    }
  ]
}]