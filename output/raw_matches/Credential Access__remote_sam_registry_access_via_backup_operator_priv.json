[{
  "title": "Security Eventlog Cleared",
  "id": "d99b79d2-0a6f-4f46-ad8b-260b6e17f982",
  "description": "One of the Windows Eventlogs has been cleared. e.g. caused by \"wevtutil cl\" command execution",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND ((EventID=517 AND Provider_Name='Security') OR (EventID=1102 AND Provider_Name='Microsoft-Windows-Eventlog'))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.t1070.001",
    "car.2016-04-002"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "Channel": "Security",
      "Computer": "01566s-win16-ir.threebeesco.com",
      "EventID": 1102,
      "EventRecordID": 2988521,
      "Guid": "{fc65ddd8-d6ef-4962-83d5-6e5cfe9ce148}",
      "Keywords": "0x4020000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "remote_sam_registry_access_via_backup_operator_priv.evtx",
      "ProcessID": 604,
      "Provider_Name": "Microsoft-Windows-Eventlog",
      "SubjectDomainName": "3B",
      "SubjectLogonId": "0x1717b6",
      "SubjectUserName": "jbrown",
      "SubjectUserSid": "S-1-5-21-308926384-506822093-3341789130-1105",
      "SystemTime": "2022-02-16T10:37:07.251285Z",
      "Task": 104,
      "ThreadID": 3848,
      "Version": 0
    }
  ]
},
{
  "title": "SMB Create Remote File Admin Share",
  "id": "b210394c-ba12-4f89-9117-44a2464b9511",
  "description": "Look for non-system accounts SMB accessing a file with write (0x2) access mask via administrative share (i.e C$).",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND ((EventID=5145 AND ShareName LIKE '%C$' ESCAPE '\\' AND AccessMask='0x2') AND (NOT SubjectUserName LIKE '%$' ESCAPE '\\') AND (NOT IpAddress='::1'))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.lateral-movement",
    "attack.t1021.002"
  ],
  "count": 3,
  "matches": [
    {
      "row_id": 11,
      "AccessList": "%%4417",
      "AccessMask": "0x2",
      "AccessReason": "-",
      "Channel": "Security",
      "Computer": "01566s-win16-ir.threebeesco.com",
      "EventID": 5145,
      "EventRecordID": 2988538,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "IpAddress": "172.16.66.36",
      "IpPort": "64224",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectType": "File",
      "Opcode": 0,
      "OriginalLogfile": "remote_sam_registry_access_via_backup_operator_priv.evtx",
      "ProcessID": 4,
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RelativeTargetName": "Users\\PSAM",
      "ShareLocalPath": "\\??\\C:\\",
      "ShareName": "\\\\*\\C$",
      "SubjectDomainName": "3B",
      "SubjectLogonId": "0x567758",
      "SubjectUserName": "samir",
      "SubjectUserSid": "S-1-5-21-308926384-506822093-3341789130-220106",
      "SystemTime": "2022-02-16T10:37:20.534128Z",
      "Task": 12811,
      "ThreadID": 7720,
      "Version": 0
    },
    {
      "row_id": 13,
      "AccessList": "%%4417",
      "AccessMask": "0x2",
      "AccessReason": "-",
      "Channel": "Security",
      "Computer": "01566s-win16-ir.threebeesco.com",
      "EventID": 5145,
      "EventRecordID": 2988540,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "IpAddress": "172.16.66.36",
      "IpPort": "64224",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectType": "File",
      "Opcode": 0,
      "OriginalLogfile": "remote_sam_registry_access_via_backup_operator_priv.evtx",
      "ProcessID": 4,
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RelativeTargetName": "Users\\PSYSTEM",
      "ShareLocalPath": "\\??\\C:\\",
      "ShareName": "\\\\*\\C$",
      "SubjectDomainName": "3B",
      "SubjectLogonId": "0x567758",
      "SubjectUserName": "samir",
      "SubjectUserSid": "S-1-5-21-308926384-506822093-3341789130-220106",
      "SystemTime": "2022-02-16T10:37:20.550664Z",
      "Task": 12811,
      "ThreadID": 7720,
      "Version": 0
    },
    {
      "row_id": 15,
      "AccessList": "%%4417",
      "AccessMask": "0x2",
      "AccessReason": "-",
      "Channel": "Security",
      "Computer": "01566s-win16-ir.threebeesco.com",
      "EventID": 5145,
      "EventRecordID": 2988542,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "IpAddress": "172.16.66.36",
      "IpPort": "64224",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectType": "File",
      "Opcode": 0,
      "OriginalLogfile": "remote_sam_registry_access_via_backup_operator_priv.evtx",
      "ProcessID": 4,
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RelativeTargetName": "Users\\PSECURITY",
      "ShareLocalPath": "\\??\\C:\\",
      "ShareName": "\\\\*\\C$",
      "SubjectDomainName": "3B",
      "SubjectLogonId": "0x567758",
      "SubjectUserName": "samir",
      "SubjectUserSid": "S-1-5-21-308926384-506822093-3341789130-220106",
      "SystemTime": "2022-02-16T10:37:20.934639Z",
      "Task": 12811,
      "ThreadID": 7720,
      "Version": 0
    }
  ]
},
{
  "title": "External Remote SMB Logon from Public IP",
  "id": "78d5cab4-557e-454f-9fb9-a222bd0d5edc",
  "description": "Detects successful logon from public IP address via SMB. This can indicate a publicly-exposed SMB port.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND ((EventID=4624 AND LogonType=3) AND (NOT ((IpAddress='::1/128' OR IpAddress LIKE '10.%' ESCAPE '\\' OR IpAddress LIKE '127.%' ESCAPE '\\' OR IpAddress LIKE '172.16.%' ESCAPE '\\' OR IpAddress LIKE '172.17.%' ESCAPE '\\' OR IpAddress LIKE '172.18.%' ESCAPE '\\' OR IpAddress LIKE '172.19.%' ESCAPE '\\' OR IpAddress LIKE '172.20.%' ESCAPE '\\' OR IpAddress LIKE '172.21.%' ESCAPE '\\' OR IpAddress LIKE '172.22.%' ESCAPE '\\' OR IpAddress LIKE '172.23.%' ESCAPE '\\' OR IpAddress LIKE '172.24.%' ESCAPE '\\' OR IpAddress LIKE '172.25.%' ESCAPE '\\' OR IpAddress LIKE '172.26.%' ESCAPE '\\' OR IpAddress LIKE '172.27.%' ESCAPE '\\' OR IpAddress LIKE '172.28.%' ESCAPE '\\' OR IpAddress LIKE '172.29.%' ESCAPE '\\' OR IpAddress LIKE '172.30.%' ESCAPE '\\' OR IpAddress LIKE '172.31.%' ESCAPE '\\' OR IpAddress LIKE '192.168.%' ESCAPE '\\' OR IpAddress LIKE '169.254.%' ESCAPE '\\' OR IpAddress LIKE 'fc%' ESCAPE '\\' OR IpAddress LIKE 'fd%' ESCAPE '\\' OR IpAddress LIKE 'fe8%' ESCAPE '\\' OR IpAddress LIKE 'fe9%' ESCAPE '\\' OR IpAddress LIKE 'fea%' ESCAPE '\\' OR IpAddress LIKE 'feb%' ESCAPE '\\') OR IpAddress='-')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.persistence",
    "attack.defense-evasion",
    "attack.initial-access",
    "attack.credential-access",
    "attack.t1133",
    "attack.t1078",
    "attack.t1110"
  ],
  "count": 4,
  "matches": [
    {
      "row_id": 3,
      "AuthenticationPackageName": "Kerberos",
      "Channel": "Security",
      "Computer": "01566s-win16-ir.threebeesco.com",
      "ElevatedToken": "%%1842",
      "EventID": 4624,
      "EventRecordID": 2988525,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "ImpersonationLevel": "%%1833",
      "IpAddress": "::1",
      "IpPort": "64223",
      "KeyLength": 0,
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "LmPackageName": "-",
      "LogonGuid": "B683BAFB-5884-30E1-12DA-31368F04511D",
      "LogonProcessName": "Kerberos",
      "LogonType": 3,
      "Opcode": 0,
      "OriginalLogfile": "remote_sam_registry_access_via_backup_operator_priv.evtx",
      "ProcessID": 624,
      "ProcessName": "-",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RestrictedAdminMode": "-",
      "SubjectDomainName": "-",
      "SubjectLogonId": "0x0",
      "SubjectUserName": "-",
      "SubjectUserSid": "S-1-0-0",
      "SystemTime": "2022-02-16T10:37:19.725408Z",
      "TargetDomainName": "THREEBEESCO.COM",
      "TargetLinkedLogonId": "0x0",
      "TargetLogonId": "0x56738f",
      "TargetOutboundDomainName": "-",
      "TargetOutboundUserName": "-",
      "TargetUserName": "01566S-WIN16-IR$",
      "TargetUserSid": "S-1-5-18",
      "Task": 12544,
      "ThreadID": 4524,
      "TransmittedServices": "-",
      "Version": 2,
      "VirtualAccount": "%%1843",
      "WorkstationName": "-"
    },
    {
      "row_id": 16,
      "AuthenticationPackageName": "Kerberos",
      "Channel": "Security",
      "Computer": "01566s-win16-ir.threebeesco.com",
      "ElevatedToken": "%%1842",
      "EventID": 4624,
      "EventRecordID": 2988544,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "ImpersonationLevel": "%%1833",
      "IpAddress": "::1",
      "IpPort": "64226",
      "KeyLength": 0,
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "LmPackageName": "-",
      "LogonGuid": "B683BAFB-5884-30E1-12DA-31368F04511D",
      "LogonProcessName": "Kerberos",
      "LogonType": 3,
      "Opcode": 0,
      "OriginalLogfile": "remote_sam_registry_access_via_backup_operator_priv.evtx",
      "ProcessID": 624,
      "ProcessName": "-",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RestrictedAdminMode": "-",
      "SubjectDomainName": "-",
      "SubjectLogonId": "0x0",
      "SubjectUserName": "-",
      "SubjectUserSid": "S-1-0-0",
      "SystemTime": "2022-02-16T10:37:22.906195Z",
      "TargetDomainName": "THREEBEESCO.COM",
      "TargetLinkedLogonId": "0x0",
      "TargetLogonId": "0x5686d9",
      "TargetOutboundDomainName": "-",
      "TargetOutboundUserName": "-",
      "TargetUserName": "01566S-WIN16-IR$",
      "TargetUserSid": "S-1-5-18",
      "Task": 12544,
      "ThreadID": 4524,
      "TransmittedServices": "-",
      "Version": 2,
      "VirtualAccount": "%%1843",
      "WorkstationName": "-"
    },
    {
      "row_id": 17,
      "AuthenticationPackageName": "Kerberos",
      "Channel": "Security",
      "Computer": "01566s-win16-ir.threebeesco.com",
      "ElevatedToken": "%%1842",
      "EventID": 4624,
      "EventRecordID": 2988547,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "ImpersonationLevel": "%%1833",
      "IpAddress": "::1",
      "IpPort": "64227",
      "KeyLength": 0,
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "LmPackageName": "-",
      "LogonGuid": "B683BAFB-5884-30E1-12DA-31368F04511D",
      "LogonProcessName": "Kerberos",
      "LogonType": 3,
      "Opcode": 0,
      "OriginalLogfile": "remote_sam_registry_access_via_backup_operator_priv.evtx",
      "ProcessID": 624,
      "ProcessName": "-",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RestrictedAdminMode": "-",
      "SubjectDomainName": "-",
      "SubjectLogonId": "0x0",
      "SubjectUserName": "-",
      "SubjectUserSid": "S-1-0-0",
      "SystemTime": "2022-02-16T10:37:22.920903Z",
      "TargetDomainName": "THREEBEESCO.COM",
      "TargetLinkedLogonId": "0x0",
      "TargetLogonId": "0x56874b",
      "TargetOutboundDomainName": "-",
      "TargetOutboundUserName": "-",
      "TargetUserName": "01566S-WIN16-IR$",
      "TargetUserSid": "S-1-5-18",
      "Task": 12544,
      "ThreadID": 4528,
      "TransmittedServices": "-",
      "Version": 2,
      "VirtualAccount": "%%1843",
      "WorkstationName": "-"
    },
    {
      "row_id": 18,
      "AuthenticationPackageName": "Kerberos",
      "Channel": "Security",
      "Computer": "01566s-win16-ir.threebeesco.com",
      "ElevatedToken": "%%1842",
      "EventID": 4624,
      "EventRecordID": 2988550,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "ImpersonationLevel": "%%1833",
      "IpAddress": "::1",
      "IpPort": "64229",
      "KeyLength": 0,
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "LmPackageName": "-",
      "LogonGuid": "B683BAFB-5884-30E1-12DA-31368F04511D",
      "LogonProcessName": "Kerberos",
      "LogonType": 3,
      "Opcode": 0,
      "OriginalLogfile": "remote_sam_registry_access_via_backup_operator_priv.evtx",
      "ProcessID": 624,
      "ProcessName": "-",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RestrictedAdminMode": "-",
      "SubjectDomainName": "-",
      "SubjectLogonId": "0x0",
      "SubjectUserName": "-",
      "SubjectUserSid": "S-1-0-0",
      "SystemTime": "2022-02-16T10:37:25.097874Z",
      "TargetDomainName": "THREEBEESCO.COM",
      "TargetLinkedLogonId": "0x0",
      "TargetLogonId": "0x568d99",
      "TargetOutboundDomainName": "-",
      "TargetOutboundUserName": "-",
      "TargetUserName": "01566S-WIN16-IR$",
      "TargetUserSid": "S-1-5-18",
      "Task": 12544,
      "ThreadID": 3868,
      "TransmittedServices": "-",
      "Version": 2,
      "VirtualAccount": "%%1843",
      "WorkstationName": "-"
    }
  ]
}]