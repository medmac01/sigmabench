[{
  "title": "CMSTP UAC Bypass via COM Object Access",
  "id": "4b60e6f2-bf39-47b4-b4ea-398e33cfe253",
  "description": "Detects UAC Bypass Attempt Using Microsoft Connection Manager Profile Installer Autoelevate-capable COM Objects (e.g. UACMe ID of 41, 43, 58 or 65)",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (ParentImage LIKE '%\\\\DllHost.exe' ESCAPE '\\' AND (ParentCommandLine LIKE '% /Processid:{3E5FC7F9-9A51-4367-9063-A120244FBEC7}%' ESCAPE '\\' OR ParentCommandLine LIKE '% /Processid:{3E000D72-A845-4CD9-BD83-80C07C3B881F}%' ESCAPE '\\' OR ParentCommandLine LIKE '% /Processid:{BD54C901-076B-434E-B6C7-17C531F4AB41}%' ESCAPE '\\' OR ParentCommandLine LIKE '% /Processid:{D2E7041B-2927-42FB-8E9F-7CE93B6DC937}%' ESCAPE '\\' OR ParentCommandLine LIKE '% /Processid:{E9495B87-D950-4AB5-87A5-FF6D70BF3E90}%' ESCAPE '\\') AND (IntegrityLevel='High' OR IntegrityLevel='System' OR IntegrityLevel='S-1-16-16384' OR IntegrityLevel='S-1-16-12288')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.execution",
    "attack.defense-evasion",
    "attack.privilege-escalation",
    "attack.t1548.002",
    "attack.t1218.003",
    "attack.g0069",
    "car.2019-04-001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 5,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "c:\\windows\\System32\\cmd.exe",
      "Company": "Microsoft Corporation",
      "Computer": "IEWIN7",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows Command Processor",
      "EventID": 1,
      "EventRecordID": 16040,
      "FileVersion": "6.1.7601.17514 (win7sp1_rtm.101119-1850)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=EE8CBF12D87C4D388F09B4F69BED2E91682920B5,MD5=AD7B9C14083B52BC532FBA5948342B98,SHA256=17F746D82695FA9B35493B41859D39D786D32B23A9D2E00F4011DEC7A02402AE,IMPHASH=CEEFB55F764020CC5C5F8F23349AB163",
      "IMPHASH": "CEEFB55F764020CC5C5F8F23349AB163",
      "Image": "C:\\Windows\\System32\\cmd.exe",
      "IntegrityLevel": "High",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "365ABB72-F9CD-5CD6-0000-00201B370100",
      "LogonId": "0x1371b",
      "MD5": "AD7B9C14083B52BC532FBA5948342B98",
      "Opcode": 0,
      "OriginalLogfile": "sysmon_1_13_11_cmstp_ini_uacbypass.evtx",
      "ParentCommandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{3E5FC7F9-9A51-4367-9063-A120244FBEC7}",
      "ParentImage": "C:\\Windows\\System32\\dllhost.exe",
      "ParentProcessGuid": "365ABB72-0545-5CD7-0000-001078371F00",
      "ParentProcessId": 3044,
      "ProcessGuid": "365ABB72-0636-5CD7-0000-0010A6C72100",
      "ProcessID": 2008,
      "Product": "Microsoft速 Windows速 Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "EE8CBF12D87C4D388F09B4F69BED2E91682920B5",
      "SHA256": "17F746D82695FA9B35493B41859D39D786D32B23A9D2E00F4011DEC7A02402AE",
      "SystemTime": "2019-05-11T17:28:22.598305Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 1992,
      "User": "IEWIN7\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-11 17:28:22.488",
      "Version": 5
    }
  ]
},
{
  "title": "CMSTP Execution Registry Event",
  "id": "b6d235fc-1d38-4b12-adbe-325f06728f37",
  "description": "Detects various indicators of Microsoft Connection Manager Profile Installer execution",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND ((EventID=12 OR EventID=13 OR EventID=14) AND TargetObject LIKE '%\\\\cmmgr32.exe%' ESCAPE '\\')"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.execution",
    "attack.t1218.003",
    "attack.g0069",
    "car.2019-04-001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 4,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "IEWIN7",
      "Details": "C:\\ProgramData\\Microsoft\\Network\\Connections\\Cm",
      "EventID": 13,
      "EventRecordID": 16039,
      "EventType": "SetValue",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\system32\\DllHost.exe",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "sysmon_1_13_11_cmstp_ini_uacbypass.evtx",
      "ProcessGuid": "365ABB72-0545-5CD7-0000-001078371F00",
      "ProcessID": 2008,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SystemTime": "2019-05-11T17:28:22.598305Z",
      "TargetObject": "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\App Paths\\cmmgr32.exe\\ProfileInstallPath",
      "Task": 13,
      "ThreadID": 1992,
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-11 17:28:22.488",
      "Version": 2
    }
  ]
},
{
  "title": "Unusual Parent Process For Cmd.EXE",
  "id": "4b991083-3d0e-44ce-8fc4-b254025d8d4b",
  "description": "Detects suspicious parent process for cmd.exe",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (Image LIKE '%\\\\cmd.exe' ESCAPE '\\' AND (ParentImage LIKE '%\\\\csrss.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\ctfmon.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\dllhost.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\epad.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\FlashPlayerUpdateService.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\GoogleUpdate.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\jucheck.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\jusched.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\LogonUI.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\lsass.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\regsvr32.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\SearchIndexer.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\SearchProtocolHost.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\SIHClient.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\sihost.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\slui.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\spoolsv.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\sppsvc.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\taskhostw.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\unsecapp.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\WerFault.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\wermgr.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\wlanext.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\WUDFHost.exe' ESCAPE '\\')))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.execution",
    "attack.t1059"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 5,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "c:\\windows\\System32\\cmd.exe",
      "Company": "Microsoft Corporation",
      "Computer": "IEWIN7",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows Command Processor",
      "EventID": 1,
      "EventRecordID": 16040,
      "FileVersion": "6.1.7601.17514 (win7sp1_rtm.101119-1850)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=EE8CBF12D87C4D388F09B4F69BED2E91682920B5,MD5=AD7B9C14083B52BC532FBA5948342B98,SHA256=17F746D82695FA9B35493B41859D39D786D32B23A9D2E00F4011DEC7A02402AE,IMPHASH=CEEFB55F764020CC5C5F8F23349AB163",
      "IMPHASH": "CEEFB55F764020CC5C5F8F23349AB163",
      "Image": "C:\\Windows\\System32\\cmd.exe",
      "IntegrityLevel": "High",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "365ABB72-F9CD-5CD6-0000-00201B370100",
      "LogonId": "0x1371b",
      "MD5": "AD7B9C14083B52BC532FBA5948342B98",
      "Opcode": 0,
      "OriginalLogfile": "sysmon_1_13_11_cmstp_ini_uacbypass.evtx",
      "ParentCommandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{3E5FC7F9-9A51-4367-9063-A120244FBEC7}",
      "ParentImage": "C:\\Windows\\System32\\dllhost.exe",
      "ParentProcessGuid": "365ABB72-0545-5CD7-0000-001078371F00",
      "ParentProcessId": 3044,
      "ProcessGuid": "365ABB72-0636-5CD7-0000-0010A6C72100",
      "ProcessID": 2008,
      "Product": "Microsoft速 Windows速 Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "EE8CBF12D87C4D388F09B4F69BED2E91682920B5",
      "SHA256": "17F746D82695FA9B35493B41859D39D786D32B23A9D2E00F4011DEC7A02402AE",
      "SystemTime": "2019-05-11T17:28:22.598305Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 1992,
      "User": "IEWIN7\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-11 17:28:22.488",
      "Version": 5
    }
  ]
}]