[{
  "title": "Whoami.EXE Execution From Privileged Process",
  "id": "79ce34ca-af29-4d0e-b832-fc1b377020db",
  "description": "Detects the execution of \"whoami.exe\" by privileged accounts that are often abused by threat actors",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((OriginalFileName='whoami.exe' OR Image LIKE '%\\\\whoami.exe' ESCAPE '\\') AND (User LIKE '%AUTHORI%' ESCAPE '\\' OR User LIKE '%AUTORI%' ESCAPE '\\' OR User LIKE '%TrustedInstaller%' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.discovery",
    "attack.t1033"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 8,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "whoami",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "whoami - displays logged on user information",
      "EventID": 1,
      "EventRecordID": 244341,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=47D7864D26FC67E0D60391CBF170D33DA518C322,MD5=43C2D3293AD939241DF61B3630A9D3B6,SHA256=1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A,IMPHASH=7FF0758B766F747CE57DFAC70743FB88",
      "IMPHASH": "7FF0758B766F747CE57DFAC70743FB88",
      "Image": "C:\\Windows\\System32\\whoami.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-069C-5E76-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "43C2D3293AD939241DF61B3630A9D3B6",
      "Opcode": 0,
      "OriginalFileName": "whoami.exe",
      "OriginalLogfile": "Sysmon 7 dllhijack_cdpsshims_CDPSvc.evtx",
      "ParentCommandLine": "\"C:\\Windows\\system32\\cmd.exe\"",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "747F3D96-08DA-5E76-0000-001054382E00",
      "ParentProcessId": 2632,
      "ProcessGuid": "747F3D96-0A33-5E76-0000-0010B8813D00",
      "ProcessID": 2844,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "47D7864D26FC67E0D60391CBF170D33DA518C322",
      "SHA256": "1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A",
      "SystemTime": "2020-03-21T12:36:03.901088Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 3648,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-03-21 12:36:03.899",
      "Version": 5
    }
  ]
},
{
  "title": "PUA - Netcat Suspicious Execution",
  "id": "e31033fc-33f0-4020-9a16-faf9b31cbf08",
  "description": "Detects execution of Netcat. Adversaries may use a non-application layer protocol for communication between host and C2 server or among infected hosts within a network",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((Image LIKE '%\\\\nc.exe' ESCAPE '\\' OR Image LIKE '%\\\\ncat.exe' ESCAPE '\\' OR Image LIKE '%\\\\netcat.exe' ESCAPE '\\') OR (CommandLine LIKE '% -lvp %' ESCAPE '\\' OR CommandLine LIKE '% -lvnp%' ESCAPE '\\' OR CommandLine LIKE '% -l -v -p %' ESCAPE '\\' OR CommandLine LIKE '% -lv -p %' ESCAPE '\\' OR CommandLine LIKE '% -l --proxy-type http %' ESCAPE '\\' OR CommandLine LIKE '% -vnl --exec %' ESCAPE '\\' OR CommandLine LIKE '% -vnl -e %' ESCAPE '\\' OR CommandLine LIKE '% --lua-exec %' ESCAPE '\\' OR CommandLine LIKE '% --sh-exec %' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.command-and-control",
    "attack.t1095"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 9,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "nc.exe  127.0.0.1 1337",
      "Company": "?",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "c:\\Users\\Public\\Tools\\",
      "Description": "?",
      "EventID": 1,
      "EventRecordID": 244342,
      "FileVersion": "?",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=08664F5C3E07862AB9B531848AC92D08C8C6BA5A,MD5=E0DB1D3D47E312EF62E5B0C74DCEAFE5,SHA256=B3B207DFAB2F429CC352BA125BE32A0CAE69FE4BF8563AB7D0128BBA8C57A71C,IMPHASH=98CE7B6533CBD67993E36DAFB4E95946",
      "IMPHASH": "98CE7B6533CBD67993E36DAFB4E95946",
      "Image": "C:\\Users\\Public\\Tools\\nc.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-06A4-5E76-0000-002087DE0200",
      "LogonId": "0x2de87",
      "MD5": "E0DB1D3D47E312EF62E5B0C74DCEAFE5",
      "Opcode": 0,
      "OriginalFileName": "?",
      "OriginalLogfile": "Sysmon 7 dllhijack_cdpsshims_CDPSvc.evtx",
      "ParentCommandLine": "\"C:\\Windows\\system32\\cmd.exe\"",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "747F3D96-06EF-5E76-0000-0010DC301A00",
      "ParentProcessId": 6236,
      "ProcessGuid": "747F3D96-0A36-5E76-0000-0010C8923D00",
      "ProcessID": 2844,
      "Product": "?",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "suspicious execution path",
      "SHA1": "08664F5C3E07862AB9B531848AC92D08C8C6BA5A",
      "SHA256": "B3B207DFAB2F429CC352BA125BE32A0CAE69FE4BF8563AB7D0128BBA8C57A71C",
      "SystemTime": "2020-03-21T12:36:06.990686Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 3648,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-03-21 12:36:06.987",
      "Version": 5
    }
  ]
},
{
  "title": "Start Windows Service Via Net.EXE",
  "id": "2a072a96-a086-49fa-bcb5-15cc5a619093",
  "description": "Detects the usage of the \"net.exe\" command to start a service using the \"start\" flag",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (((Image LIKE '%\\\\net.exe' ESCAPE '\\' OR Image LIKE '%\\\\net1.exe' ESCAPE '\\') OR (OriginalFileName='net.exe' OR OriginalFileName='net1.exe')) AND CommandLine LIKE '% start %' ESCAPE '\\'))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.execution",
    "attack.t1569.002"
  ],
  "count": 2,
  "matches": [
    {
      "row_id": 4,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "net  start CDPSvc",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Net Command",
      "EventID": 1,
      "EventRecordID": 244336,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=4F4970C3545972FEA2BC1984D597FC810E6321E0,MD5=AE61D8F04BCDE8158304067913160B31,SHA256=25C8266D2BC1D5626DCDF72419838B397D28D44D00AC09F02FF4E421B43EC369,IMPHASH=57F0C47AE2A1A2C06C8B987372AB0B07",
      "IMPHASH": "57F0C47AE2A1A2C06C8B987372AB0B07",
      "Image": "C:\\Windows\\System32\\net.exe",
      "IntegrityLevel": "High",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-06A4-5E76-0000-002043DE0200",
      "LogonId": "0x2de43",
      "MD5": "AE61D8F04BCDE8158304067913160B31",
      "Opcode": 0,
      "OriginalFileName": "net.exe",
      "OriginalLogfile": "Sysmon 7 dllhijack_cdpsshims_CDPSvc.evtx",
      "ParentCommandLine": "\"C:\\Windows\\system32\\cmd.exe\"",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "747F3D96-077C-5E76-0000-0010A5BA2300",
      "ParentProcessId": 5068,
      "ProcessGuid": "747F3D96-0A2B-5E76-0000-0010C02A3D00",
      "ProcessID": 2844,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "4F4970C3545972FEA2BC1984D597FC810E6321E0",
      "SHA256": "25C8266D2BC1D5626DCDF72419838B397D28D44D00AC09F02FF4E421B43EC369",
      "SystemTime": "2020-03-21T12:35:55.876452Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 3648,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-03-21 12:35:55.872",
      "Version": 5
    },
    {
      "row_id": 5,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "C:\\Windows\\system32\\net1  start CDPSvc",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Net Command",
      "EventID": 1,
      "EventRecordID": 244337,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=085E23DF67774ED89FD0215E1F144824F79F812B,MD5=63DD4523677E62A73A8A7494DB321EA2,SHA256=C687157FD58EAA51757CDA87D06C30953A31F03F5356B9F5A9C004FA4BAD4BF5,IMPHASH=41DBA1AF77E1A2260F0CE46D59ADCB5E",
      "IMPHASH": "41DBA1AF77E1A2260F0CE46D59ADCB5E",
      "Image": "C:\\Windows\\System32\\net1.exe",
      "IntegrityLevel": "High",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-06A4-5E76-0000-002043DE0200",
      "LogonId": "0x2de43",
      "MD5": "63DD4523677E62A73A8A7494DB321EA2",
      "Opcode": 0,
      "OriginalFileName": "net1.exe",
      "OriginalLogfile": "Sysmon 7 dllhijack_cdpsshims_CDPSvc.evtx",
      "ParentCommandLine": "net  start CDPSvc",
      "ParentImage": "C:\\Windows\\System32\\net.exe",
      "ParentProcessGuid": "747F3D96-0A2B-5E76-0000-0010C02A3D00",
      "ParentProcessId": 7072,
      "ProcessGuid": "747F3D96-0A2B-5E76-0000-0010A92C3D00",
      "ProcessID": 2844,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "085E23DF67774ED89FD0215E1F144824F79F812B",
      "SHA256": "C687157FD58EAA51757CDA87D06C30953A31F03F5356B9F5A9C004FA4BAD4BF5",
      "SystemTime": "2020-03-21T12:35:55.897450Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 3648,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-03-21 12:35:55.891",
      "Version": 5
    }
  ]
},
{
  "title": "Stop Windows Service Via Sc.EXE",
  "id": "81bcb81b-5b1f-474b-b373-52c871aaa7b1",
  "description": "Detects the stopping of a Windows service via the \"sc.exe\" utility",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((OriginalFileName='sc.exe' OR Image LIKE '%\\\\sc.exe' ESCAPE '\\') AND CommandLine LIKE '% stop %' ESCAPE '\\'))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.impact",
    "attack.t1489"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "sc  stop CDPSvc",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Service Control Manager Configuration Tool",
      "EventID": 1,
      "EventRecordID": 244333,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=622FA2729408E5F467A592223219DA7C547E7CC7,MD5=ABB56882148DE65D53ABFC55544A49A8,SHA256=78097C7CD0E57902536C60B7FA17528C313DB20869E5F944223A0BA4C801D39B,IMPHASH=35A7FFDE18D444A92D32C8B2879450FF",
      "IMPHASH": "35A7FFDE18D444A92D32C8B2879450FF",
      "Image": "C:\\Windows\\System32\\sc.exe",
      "IntegrityLevel": "High",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-06A4-5E76-0000-002043DE0200",
      "LogonId": "0x2de43",
      "MD5": "ABB56882148DE65D53ABFC55544A49A8",
      "Opcode": 0,
      "OriginalFileName": "sc.exe",
      "OriginalLogfile": "Sysmon 7 dllhijack_cdpsshims_CDPSvc.evtx",
      "ParentCommandLine": "\"C:\\Windows\\system32\\cmd.exe\"",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "747F3D96-077C-5E76-0000-0010A5BA2300",
      "ParentProcessId": 5068,
      "ProcessGuid": "747F3D96-0A17-5E76-0000-001062373A00",
      "ProcessID": 2844,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "Persistence or Exec - Services Management",
      "SHA1": "622FA2729408E5F467A592223219DA7C547E7CC7",
      "SHA256": "78097C7CD0E57902536C60B7FA17528C313DB20869E5F944223A0BA4C801D39B",
      "SystemTime": "2020-03-21T12:35:35.026859Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 3648,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-03-21 12:35:35.023",
      "Version": 5
    }
  ]
},
{
  "title": "Local Accounts Discovery",
  "id": "502b42de-4306-40b4-9596-6f590c81f073",
  "description": "Local accounts, System Owner/User discovery using operating systems utilities",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (((Image LIKE '%\\\\cmd.exe' ESCAPE '\\' AND (CommandLine LIKE '% /c%' ESCAPE '\\' AND CommandLine LIKE '%dir %' ESCAPE '\\' AND CommandLine LIKE '%\\\\Users\\\\%' ESCAPE '\\')) AND (NOT CommandLine LIKE '% rmdir %' ESCAPE '\\')) OR (((Image LIKE '%\\\\net.exe' ESCAPE '\\' OR Image LIKE '%\\\\net1.exe' ESCAPE '\\') AND CommandLine LIKE '%user%' ESCAPE '\\') AND (NOT (CommandLine LIKE '%/domain%' ESCAPE '\\' OR CommandLine LIKE '%/add%' ESCAPE '\\' OR CommandLine LIKE '%/delete%' ESCAPE '\\' OR CommandLine LIKE '%/active%' ESCAPE '\\' OR CommandLine LIKE '%/expires%' ESCAPE '\\' OR CommandLine LIKE '%/passwordreq%' ESCAPE '\\' OR CommandLine LIKE '%/scriptpath%' ESCAPE '\\' OR CommandLine LIKE '%/times%' ESCAPE '\\' OR CommandLine LIKE '%/workstations%' ESCAPE '\\'))) OR (((Image LIKE '%\\\\whoami.exe' ESCAPE '\\' OR Image LIKE '%\\\\quser.exe' ESCAPE '\\' OR Image LIKE '%\\\\qwinsta.exe' ESCAPE '\\') OR (OriginalFileName='whoami.exe' OR OriginalFileName='quser.exe' OR OriginalFileName='qwinsta.exe')) OR (Image LIKE '%\\\\wmic.exe' ESCAPE '\\' AND (CommandLine LIKE '%useraccount%' ESCAPE '\\' AND CommandLine LIKE '%get%' ESCAPE '\\')) OR (Image LIKE '%\\\\cmdkey.exe' ESCAPE '\\' AND CommandLine LIKE '% /l%' ESCAPE '\\'))))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.discovery",
    "attack.t1033",
    "attack.t1087.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 8,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "whoami",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "whoami - displays logged on user information",
      "EventID": 1,
      "EventRecordID": 244341,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=47D7864D26FC67E0D60391CBF170D33DA518C322,MD5=43C2D3293AD939241DF61B3630A9D3B6,SHA256=1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A,IMPHASH=7FF0758B766F747CE57DFAC70743FB88",
      "IMPHASH": "7FF0758B766F747CE57DFAC70743FB88",
      "Image": "C:\\Windows\\System32\\whoami.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-069C-5E76-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "43C2D3293AD939241DF61B3630A9D3B6",
      "Opcode": 0,
      "OriginalFileName": "whoami.exe",
      "OriginalLogfile": "Sysmon 7 dllhijack_cdpsshims_CDPSvc.evtx",
      "ParentCommandLine": "\"C:\\Windows\\system32\\cmd.exe\"",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "747F3D96-08DA-5E76-0000-001054382E00",
      "ParentProcessId": 2632,
      "ProcessGuid": "747F3D96-0A33-5E76-0000-0010B8813D00",
      "ProcessID": 2844,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "47D7864D26FC67E0D60391CBF170D33DA518C322",
      "SHA256": "1D5491E3C468EE4B4EF6EDFF4BBC7D06EE83180F6F0B1576763EA2EFE049493A",
      "SystemTime": "2020-03-21T12:36:03.901088Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 3648,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-03-21 12:36:03.899",
      "Version": 5
    }
  ]
}]