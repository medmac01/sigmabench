[{
  "title": "Suspicious PsExec Execution",
  "id": "c462f537-a1e3-41a6-b5fc-b2c2cef9bf82",
  "description": "detects execution of psexec or paexec with renamed service name, this rule helps to filter out the noise if psexec is used for legit purposes or if attacker uses a different psexec client other than sysinternal one",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND ((EventID=5145 AND ShareName LIKE '\\\\\\\\*\\\\IPC$' ESCAPE '\\' AND (RelativeTargetName LIKE '%-stdin' ESCAPE '\\' OR RelativeTargetName LIKE '%-stdout' ESCAPE '\\' OR RelativeTargetName LIKE '%-stderr' ESCAPE '\\')) AND (NOT RelativeTargetName LIKE 'PSEXESVC%' ESCAPE '\\'))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.lateral-movement",
    "attack.t1021.002"
  ],
  "count": 3,
  "matches": [
    {
      "row_id": 20,
      "AccessList": "%%1538\r\n\t\t\t\t%%1541\r\n\t\t\t\t%%4417\r\n\t\t\t\t%%4418\r\n\t\t\t\t%%4420\r\n\t\t\t\t%%4423\r\n\t\t\t\t%%4424",
      "AccessMask": "0x120196",
      "AccessReason": "-",
      "Channel": "Security",
      "Computer": "IEWIN7",
      "EventID": 5145,
      "EventRecordID": 84050,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "IpAddress": "10.0.2.16",
      "IpPort": "54765",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectType": "File",
      "Opcode": 0,
      "OriginalLogfile": "LM_renamed_psexecsvc_5145.evtx",
      "ProcessID": 512,
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RelativeTargetName": "blabla-NLLT108334-37048-stdin",
      "ShareName": "\\\\*\\IPC$",
      "SubjectDomainName": "IEWIN7",
      "SubjectLogonId": "0x162630",
      "SubjectUserName": "IEUser",
      "SubjectUserSid": "S-1-5-21-3583694148-1414552638-2922671848-1000",
      "SystemTime": "2019-01-19T13:00:10.711207Z",
      "Task": 12811,
      "ThreadID": 528,
      "Version": 0
    },
    {
      "row_id": 21,
      "AccessList": "%%1538\r\n\t\t\t\t%%1541\r\n\t\t\t\t%%4416\r\n\t\t\t\t%%4419\r\n\t\t\t\t%%4423",
      "AccessMask": "0x120089",
      "AccessReason": "-",
      "Channel": "Security",
      "Computer": "IEWIN7",
      "EventID": 5145,
      "EventRecordID": 84051,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "IpAddress": "10.0.2.16",
      "IpPort": "54765",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectType": "File",
      "Opcode": 0,
      "OriginalLogfile": "LM_renamed_psexecsvc_5145.evtx",
      "ProcessID": 512,
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RelativeTargetName": "blabla-NLLT108334-37048-stdout",
      "ShareName": "\\\\*\\IPC$",
      "SubjectDomainName": "IEWIN7",
      "SubjectLogonId": "0x162630",
      "SubjectUserName": "IEUser",
      "SubjectUserSid": "S-1-5-21-3583694148-1414552638-2922671848-1000",
      "SystemTime": "2019-01-19T13:00:10.711207Z",
      "Task": 12811,
      "ThreadID": 528,
      "Version": 0
    },
    {
      "row_id": 22,
      "AccessList": "%%1538\r\n\t\t\t\t%%1541\r\n\t\t\t\t%%4416\r\n\t\t\t\t%%4419\r\n\t\t\t\t%%4423",
      "AccessMask": "0x120089",
      "AccessReason": "-",
      "Channel": "Security",
      "Computer": "IEWIN7",
      "EventID": 5145,
      "EventRecordID": 84052,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "IpAddress": "10.0.2.16",
      "IpPort": "54765",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectType": "File",
      "Opcode": 0,
      "OriginalLogfile": "LM_renamed_psexecsvc_5145.evtx",
      "ProcessID": 512,
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RelativeTargetName": "blabla-NLLT108334-37048-stderr",
      "ShareName": "\\\\*\\IPC$",
      "SubjectDomainName": "IEWIN7",
      "SubjectLogonId": "0x162630",
      "SubjectUserName": "IEUser",
      "SubjectUserSid": "S-1-5-21-3583694148-1414552638-2922671848-1000",
      "SystemTime": "2019-01-19T13:00:10.711207Z",
      "Task": 12811,
      "ThreadID": 528,
      "Version": 0
    }
  ]
},
{
  "title": "First Time Seen Remote Named Pipe",
  "id": "52d8b0c6-53d6-439a-9e41-52ad442ad9ad",
  "description": "This detection excludes known namped pipes accessible remotely and notify on newly observed ones, may help to detect lateral movement and remote exec using named pipes",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND ((EventID=5145 AND ShareName LIKE '\\\\\\\\*\\\\IPC$' ESCAPE '\\') AND (NOT (RelativeTargetName='atsvc' OR RelativeTargetName='samr' OR RelativeTargetName='lsarpc' OR RelativeTargetName='lsass' OR RelativeTargetName='winreg' OR RelativeTargetName='netlogon' OR RelativeTargetName='srvsvc' OR RelativeTargetName LIKE 'protected\\_storage' ESCAPE '\\' OR RelativeTargetName='wkssvc' OR RelativeTargetName='browser' OR RelativeTargetName='netdfs' OR RelativeTargetName='svcctl' OR RelativeTargetName='spoolss' OR RelativeTargetName='ntsvcs' OR RelativeTargetName LIKE 'LSM\\_API\\_service' ESCAPE '\\' OR RelativeTargetName='HydraLsPipe' OR RelativeTargetName LIKE 'TermSrv\\_API\\_service' ESCAPE '\\' OR RelativeTargetName='MsFteWds' OR RelativeTargetName LIKE 'sql\\\\query' ESCAPE '\\' OR RelativeTargetName='eventlog')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.lateral-movement",
    "attack.t1021.002"
  ],
  "count": 4,
  "matches": [
    {
      "row_id": 19,
      "AccessList": "%%1538\r\n\t\t\t\t%%1541\r\n\t\t\t\t%%4416\r\n\t\t\t\t%%4417\r\n\t\t\t\t%%4418\r\n\t\t\t\t%%4419\r\n\t\t\t\t%%4420\r\n\t\t\t\t%%4423\r\n\t\t\t\t%%4424",
      "AccessMask": "0x12019f",
      "AccessReason": "-",
      "Channel": "Security",
      "Computer": "IEWIN7",
      "EventID": 5145,
      "EventRecordID": 84047,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "IpAddress": "10.0.2.16",
      "IpPort": "54765",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectType": "File",
      "Opcode": 0,
      "OriginalLogfile": "LM_renamed_psexecsvc_5145.evtx",
      "ProcessID": 512,
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RelativeTargetName": "blabla",
      "ShareName": "\\\\*\\IPC$",
      "SubjectDomainName": "IEWIN7",
      "SubjectLogonId": "0x162630",
      "SubjectUserName": "IEUser",
      "SubjectUserSid": "S-1-5-21-3583694148-1414552638-2922671848-1000",
      "SystemTime": "2019-01-19T13:00:10.540962Z",
      "Task": 12811,
      "ThreadID": 528,
      "Version": 0
    },
    {
      "row_id": 20,
      "AccessList": "%%1538\r\n\t\t\t\t%%1541\r\n\t\t\t\t%%4417\r\n\t\t\t\t%%4418\r\n\t\t\t\t%%4420\r\n\t\t\t\t%%4423\r\n\t\t\t\t%%4424",
      "AccessMask": "0x120196",
      "AccessReason": "-",
      "Channel": "Security",
      "Computer": "IEWIN7",
      "EventID": 5145,
      "EventRecordID": 84050,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "IpAddress": "10.0.2.16",
      "IpPort": "54765",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectType": "File",
      "Opcode": 0,
      "OriginalLogfile": "LM_renamed_psexecsvc_5145.evtx",
      "ProcessID": 512,
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RelativeTargetName": "blabla-NLLT108334-37048-stdin",
      "ShareName": "\\\\*\\IPC$",
      "SubjectDomainName": "IEWIN7",
      "SubjectLogonId": "0x162630",
      "SubjectUserName": "IEUser",
      "SubjectUserSid": "S-1-5-21-3583694148-1414552638-2922671848-1000",
      "SystemTime": "2019-01-19T13:00:10.711207Z",
      "Task": 12811,
      "ThreadID": 528,
      "Version": 0
    },
    {
      "row_id": 21,
      "AccessList": "%%1538\r\n\t\t\t\t%%1541\r\n\t\t\t\t%%4416\r\n\t\t\t\t%%4419\r\n\t\t\t\t%%4423",
      "AccessMask": "0x120089",
      "AccessReason": "-",
      "Channel": "Security",
      "Computer": "IEWIN7",
      "EventID": 5145,
      "EventRecordID": 84051,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "IpAddress": "10.0.2.16",
      "IpPort": "54765",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectType": "File",
      "Opcode": 0,
      "OriginalLogfile": "LM_renamed_psexecsvc_5145.evtx",
      "ProcessID": 512,
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RelativeTargetName": "blabla-NLLT108334-37048-stdout",
      "ShareName": "\\\\*\\IPC$",
      "SubjectDomainName": "IEWIN7",
      "SubjectLogonId": "0x162630",
      "SubjectUserName": "IEUser",
      "SubjectUserSid": "S-1-5-21-3583694148-1414552638-2922671848-1000",
      "SystemTime": "2019-01-19T13:00:10.711207Z",
      "Task": 12811,
      "ThreadID": 528,
      "Version": 0
    },
    {
      "row_id": 22,
      "AccessList": "%%1538\r\n\t\t\t\t%%1541\r\n\t\t\t\t%%4416\r\n\t\t\t\t%%4419\r\n\t\t\t\t%%4423",
      "AccessMask": "0x120089",
      "AccessReason": "-",
      "Channel": "Security",
      "Computer": "IEWIN7",
      "EventID": 5145,
      "EventRecordID": 84052,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "IpAddress": "10.0.2.16",
      "IpPort": "54765",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "ObjectType": "File",
      "Opcode": 0,
      "OriginalLogfile": "LM_renamed_psexecsvc_5145.evtx",
      "ProcessID": 512,
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RelativeTargetName": "blabla-NLLT108334-37048-stderr",
      "ShareName": "\\\\*\\IPC$",
      "SubjectDomainName": "IEWIN7",
      "SubjectLogonId": "0x162630",
      "SubjectUserName": "IEUser",
      "SubjectUserSid": "S-1-5-21-3583694148-1414552638-2922671848-1000",
      "SystemTime": "2019-01-19T13:00:10.711207Z",
      "Task": 12811,
      "ThreadID": 528,
      "Version": 0
    }
  ]
}]