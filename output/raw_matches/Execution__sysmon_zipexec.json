[{
  "title": "New Generic Credentials Added Via Cmdkey.EXE",
  "id": "b1ec66c6-f4d1-4b5c-96dd-af28ccae7727",
  "description": "Detects usage of \"cmdkey.exe\" to add generic credentials.\nAs an example, this can be used before connecting to an RDP session via command line interface.\n",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((Image LIKE '%\\\\cmdkey.exe' ESCAPE '\\' OR OriginalFileName='cmdkey.exe') AND (CommandLine LIKE '% -g%' ESCAPE '\\' OR CommandLine LIKE '% /g%' ESCAPE '\\' OR CommandLine LIKE '% –g%' ESCAPE '\\' OR CommandLine LIKE '% —g%' ESCAPE '\\' OR CommandLine LIKE '% ―g%' ESCAPE '\\') AND (CommandLine LIKE '% -u%' ESCAPE '\\' OR CommandLine LIKE '% /u%' ESCAPE '\\' OR CommandLine LIKE '% –u%' ESCAPE '\\' OR CommandLine LIKE '% —u%' ESCAPE '\\' OR CommandLine LIKE '% ―u%' ESCAPE '\\') AND (CommandLine LIKE '% -p%' ESCAPE '\\' OR CommandLine LIKE '% /p%' ESCAPE '\\' OR CommandLine LIKE '% –p%' ESCAPE '\\' OR CommandLine LIKE '% —p%' ESCAPE '\\' OR CommandLine LIKE '% ―p%' ESCAPE '\\')))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.credential-access",
    "attack.t1003.005"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\Windows\\System32\\cmdkey.exe\" /generic:Microsoft_Windows_Shell_ZipFolder:filename=C:\\Users\\bouss\\AppData\\Local\\Temp\\lync.zip /pass:tWIMmIF /user:\"\"",
      "Company": "Microsoft Corporation",
      "Computer": "LAPTOP-JU4M3I0E",
      "CurrentDirectory": "C:\\Users\\bouss\\Desktop\\",
      "Description": "Credential Manager Command Line Utility",
      "EventID": 1,
      "EventRecordID": 10920367,
      "FileVersion": "10.0.19041.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=B0DE4D5F0E178002E02C66DAF064DFD3FF1DBDE6,MD5=F9C20642B4CFCE4517F4F26B6305607C,SHA256=14BCC1901C5CCA8E91A6400050308752916AC861BDD52CF3A44DC7EF46830282,IMPHASH=03AD7A1AF78BF7A500FB199CABE4C34A",
      "IMPHASH": "03AD7A1AF78BF7A500FB199CABE4C34A",
      "Image": "C:\\Windows\\System32\\cmdkey.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "00247C92-3C1A-6169-0000-0020C2790700",
      "LogonId": "0x779c2",
      "MD5": "F9C20642B4CFCE4517F4F26B6305607C",
      "Opcode": 0,
      "OriginalFileName": "cmdkey.exe",
      "OriginalLogfile": "sysmon_zipexec.evtx",
      "ParentCommandLine": "cscript.exe  //e:jscript testme.js",
      "ParentImage": "C:\\Windows\\System32\\cscript.exe",
      "ParentProcessGuid": "00247C92-94D6-6171-0000-00100514967B",
      "ParentProcessId": 28176,
      "ProcessGuid": "00247C92-94D6-6171-0000-00103F5A967B",
      "ProcessID": 5396,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "B0DE4D5F0E178002E02C66DAF064DFD3FF1DBDE6",
      "SHA256": "14BCC1901C5CCA8E91A6400050308752916AC861BDD52CF3A44DC7EF46830282",
      "SystemTime": "2021-10-21T16:27:02.999506Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 7692,
      "User": "LAPTOP-JU4M3I0E\\bouss",
      "UserID": "S-1-5-18",
      "UtcTime": "2021-10-21 16:27:02.943",
      "Version": 5
    }
  ]
},
{
  "title": "Suspicious ZipExec Execution",
  "id": "90dcf730-1b71-4ae7-9ffc-6fcf62bd0132",
  "description": "ZipExec is a Proof-of-Concept (POC) tool to wrap binary-based tools into a password-protected zip file.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((CommandLine LIKE '%/generic:Microsoft\\_Windows\\_Shell\\_ZipFolder:filename=%' ESCAPE '\\' AND CommandLine LIKE '%.zip%' ESCAPE '\\' AND CommandLine LIKE '%/pass:%' ESCAPE '\\' AND CommandLine LIKE '%/user:%' ESCAPE '\\') OR (CommandLine LIKE '%/delete%' ESCAPE '\\' AND CommandLine LIKE '%Microsoft\\_Windows\\_Shell\\_ZipFolder:filename=%' ESCAPE '\\' AND CommandLine LIKE '%.zip%' ESCAPE '\\')))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.execution",
    "attack.defense-evasion",
    "attack.t1218",
    "attack.t1202"
  ],
  "count": 2,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\Windows\\System32\\cmdkey.exe\" /generic:Microsoft_Windows_Shell_ZipFolder:filename=C:\\Users\\bouss\\AppData\\Local\\Temp\\lync.zip /pass:tWIMmIF /user:\"\"",
      "Company": "Microsoft Corporation",
      "Computer": "LAPTOP-JU4M3I0E",
      "CurrentDirectory": "C:\\Users\\bouss\\Desktop\\",
      "Description": "Credential Manager Command Line Utility",
      "EventID": 1,
      "EventRecordID": 10920367,
      "FileVersion": "10.0.19041.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=B0DE4D5F0E178002E02C66DAF064DFD3FF1DBDE6,MD5=F9C20642B4CFCE4517F4F26B6305607C,SHA256=14BCC1901C5CCA8E91A6400050308752916AC861BDD52CF3A44DC7EF46830282,IMPHASH=03AD7A1AF78BF7A500FB199CABE4C34A",
      "IMPHASH": "03AD7A1AF78BF7A500FB199CABE4C34A",
      "Image": "C:\\Windows\\System32\\cmdkey.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "00247C92-3C1A-6169-0000-0020C2790700",
      "LogonId": "0x779c2",
      "MD5": "F9C20642B4CFCE4517F4F26B6305607C",
      "Opcode": 0,
      "OriginalFileName": "cmdkey.exe",
      "OriginalLogfile": "sysmon_zipexec.evtx",
      "ParentCommandLine": "cscript.exe  //e:jscript testme.js",
      "ParentImage": "C:\\Windows\\System32\\cscript.exe",
      "ParentProcessGuid": "00247C92-94D6-6171-0000-00100514967B",
      "ParentProcessId": 28176,
      "ProcessGuid": "00247C92-94D6-6171-0000-00103F5A967B",
      "ProcessID": 5396,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "B0DE4D5F0E178002E02C66DAF064DFD3FF1DBDE6",
      "SHA256": "14BCC1901C5CCA8E91A6400050308752916AC861BDD52CF3A44DC7EF46830282",
      "SystemTime": "2021-10-21T16:27:02.999506Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 7692,
      "User": "LAPTOP-JU4M3I0E\\bouss",
      "UserID": "S-1-5-18",
      "UtcTime": "2021-10-21 16:27:02.943",
      "Version": 5
    },
    {
      "row_id": 7,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\Windows\\System32\\cmdkey.exe\" /delete Microsoft_Windows_Shell_ZipFolder:filename=C:\\Users\\bouss\\AppData\\Local\\Temp\\lync.zip",
      "Company": "Microsoft Corporation",
      "Computer": "LAPTOP-JU4M3I0E",
      "CurrentDirectory": "C:\\Users\\bouss\\Desktop\\",
      "Description": "Credential Manager Command Line Utility",
      "EventID": 1,
      "EventRecordID": 10920381,
      "FileVersion": "10.0.19041.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=B0DE4D5F0E178002E02C66DAF064DFD3FF1DBDE6,MD5=F9C20642B4CFCE4517F4F26B6305607C,SHA256=14BCC1901C5CCA8E91A6400050308752916AC861BDD52CF3A44DC7EF46830282,IMPHASH=03AD7A1AF78BF7A500FB199CABE4C34A",
      "IMPHASH": "03AD7A1AF78BF7A500FB199CABE4C34A",
      "Image": "C:\\Windows\\System32\\cmdkey.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "00247C92-3C1A-6169-0000-0020C2790700",
      "LogonId": "0x779c2",
      "MD5": "F9C20642B4CFCE4517F4F26B6305607C",
      "Opcode": 0,
      "OriginalFileName": "cmdkey.exe",
      "OriginalLogfile": "sysmon_zipexec.evtx",
      "ParentCommandLine": "cscript.exe  //e:jscript testme.js",
      "ParentImage": "C:\\Windows\\System32\\cscript.exe",
      "ParentProcessGuid": "00247C92-94D6-6171-0000-00100514967B",
      "ParentProcessId": 28176,
      "ProcessGuid": "00247C92-94E0-6171-0000-0010B84D987B",
      "ProcessID": 5396,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "B0DE4D5F0E178002E02C66DAF064DFD3FF1DBDE6",
      "SHA256": "14BCC1901C5CCA8E91A6400050308752916AC861BDD52CF3A44DC7EF46830282",
      "SystemTime": "2021-10-21T16:27:12.946958Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 7692,
      "User": "LAPTOP-JU4M3I0E\\bouss",
      "UserID": "S-1-5-18",
      "UtcTime": "2021-10-21 16:27:12.925",
      "Version": 5
    }
  ]
},
{
  "title": "Potential Defense Evasion Via Binary Rename",
  "id": "36480ae1-a1cb-4eaa-a0d6-29801d7e9142",
  "description": "Detects the execution of a renamed binary often used by attackers or malware leveraging new Sysmon OriginalFileName datapoint.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((OriginalFileName='Cmd.Exe' OR OriginalFileName='CONHOST.EXE' OR OriginalFileName='7z.exe' OR OriginalFileName='7za.exe' OR OriginalFileName='WinRAR.exe' OR OriginalFileName='wevtutil.exe' OR OriginalFileName='net.exe' OR OriginalFileName='net1.exe' OR OriginalFileName='netsh.exe' OR OriginalFileName='InstallUtil.exe') AND (NOT (Image LIKE '%\\\\cmd.exe' ESCAPE '\\' OR Image LIKE '%\\\\conhost.exe' ESCAPE '\\' OR Image LIKE '%\\\\7z.exe' ESCAPE '\\' OR Image LIKE '%\\\\7za.exe' ESCAPE '\\' OR Image LIKE '%\\\\WinRAR.exe' ESCAPE '\\' OR Image LIKE '%\\\\wevtutil.exe' ESCAPE '\\' OR Image LIKE '%\\\\net.exe' ESCAPE '\\' OR Image LIKE '%\\\\net1.exe' ESCAPE '\\' OR Image LIKE '%\\\\netsh.exe' ESCAPE '\\' OR Image LIKE '%\\\\InstallUtil.exe' ESCAPE '\\'))))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.defense-evasion",
    "attack.t1036.003"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 6,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\Users\\bouss\\AppData\\Local\\Temp\\Temp3_lync.zip\\i.exe\"",
      "Company": "Microsoft Corporation",
      "Computer": "LAPTOP-JU4M3I0E",
      "CurrentDirectory": "C:\\Users\\bouss\\Desktop\\",
      "Description": "Windows Command Processor",
      "EventID": 1,
      "EventRecordID": 10920379,
      "FileVersion": "10.0.18362.449 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=8DCA9749CD48D286950E7A9FA1088C937CBCCAD4,MD5=D7AB69FAD18D4A643D84A271DFC0DBDF,SHA256=FF79D3C4A0B7EB191783C323AB8363EBD1FD10BE58D8BCC96B07067743CA81D5,IMPHASH=272245E2988E1E430500B852C4FB5E18",
      "IMPHASH": "272245E2988E1E430500B852C4FB5E18",
      "Image": "C:\\Users\\bouss\\AppData\\Local\\Temp\\Temp3_lync.zip\\i.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "00247C92-3C1A-6169-0000-0020C2790700",
      "LogonId": "0x779c2",
      "MD5": "D7AB69FAD18D4A643D84A271DFC0DBDF",
      "Opcode": 0,
      "OriginalFileName": "Cmd.Exe",
      "OriginalLogfile": "sysmon_zipexec.evtx",
      "ParentCommandLine": "cscript.exe  //e:jscript testme.js",
      "ParentImage": "C:\\Windows\\System32\\cscript.exe",
      "ParentProcessGuid": "00247C92-94D6-6171-0000-00100514967B",
      "ParentProcessId": 28176,
      "ProcessGuid": "00247C92-94E0-6171-0000-00107424987B",
      "ProcessID": 5396,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "8DCA9749CD48D286950E7A9FA1088C937CBCCAD4",
      "SHA256": "FF79D3C4A0B7EB191783C323AB8363EBD1FD10BE58D8BCC96B07067743CA81D5",
      "SystemTime": "2021-10-21T16:27:12.858588Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 7692,
      "User": "LAPTOP-JU4M3I0E\\bouss",
      "UserID": "S-1-5-18",
      "UtcTime": "2021-10-21 16:27:12.839",
      "Version": 5
    }
  ]
}]