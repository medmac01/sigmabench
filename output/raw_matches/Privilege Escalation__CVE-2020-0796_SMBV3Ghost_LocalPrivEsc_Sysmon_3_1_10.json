[{
  "title": "HackTool - CobaltStrike BOF Injection Pattern",
  "id": "09706624-b7f6-455d-9d02-adee024cee1d",
  "description": "Detects a typical pattern of a CobaltStrike BOF which inject into other processes",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=10 AND (CallTrace REGEXP '^C:\\\\Windows\\\\SYSTEM32\\\\ntdll\\.dll\\+[a-z0-9]{4,6}\\|C:\\\\Windows\\\\System32\\\\KERNELBASE\\.dll\\+[a-z0-9]{4,6}\\|UNKNOWN\\([A-Z0-9]{16}\\)$' AND (GrantedAccess='0x1028' OR GrantedAccess='0x1fffff')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.execution",
    "attack.t1106",
    "attack.defense-evasion",
    "attack.t1562.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "CallTrace": "C:\\Windows\\SYSTEM32\\ntdll.dll+9fc24|C:\\Windows\\System32\\KERNELBASE.dll+212ee|UNKNOWN(000001A063DE13D4)",
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "MSEDGEWIN10",
      "EventID": 10,
      "EventRecordID": 339221,
      "GrantedAccess": "0x1fffff",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "CVE-2020-0796_SMBV3Ghost_LocalPrivEsc_Sysmon_3_1_10.evtx",
      "ProcessID": 3332,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SourceImage": "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
      "SourceProcessGUID": "747F3D96-FF9D-5F1D-0000-00100AC62400",
      "SourceProcessId": 7400,
      "SourceThreadId": 2812,
      "SystemTime": "2020-07-26T22:26:14.522570Z",
      "TargetImage": "C:\\Windows\\system32\\winlogon.exe",
      "TargetProcessGUID": "747F3D96-F938-5F1D-0000-00104B500000",
      "TargetProcessId": 584,
      "Task": 10,
      "ThreadID": 4376,
      "UserID": "S-1-5-18",
      "UtcTime": "2020-07-26 22:26:14.517",
      "Version": 3
    }
  ]
},
{
  "title": "Abused Debug Privilege by Arbitrary Parent Processes",
  "id": "d522eca2-2973-4391-a3e0-ef0374321dae",
  "description": "Detection of unusual child processes by different system processes",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((((ParentImage LIKE '%\\\\winlogon.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\services.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\lsass.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\csrss.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\smss.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\wininit.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\spoolsv.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\searchindexer.exe' ESCAPE '\\') AND (User LIKE '%AUTHORI%' ESCAPE '\\' OR User LIKE '%AUTORI%' ESCAPE '\\')) AND ((Image LIKE '%\\\\powershell.exe' ESCAPE '\\' OR Image LIKE '%\\\\pwsh.exe' ESCAPE '\\' OR Image LIKE '%\\\\cmd.exe' ESCAPE '\\') OR (OriginalFileName='PowerShell.EXE' OR OriginalFileName='pwsh.dll' OR OriginalFileName='Cmd.Exe'))) AND (NOT (CommandLine LIKE '% route %' ESCAPE '\\' AND CommandLine LIKE '% ADD %' ESCAPE '\\'))))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.privilege-escalation",
    "attack.t1548"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "cmd",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows Command Processor",
      "EventID": 1,
      "EventRecordID": 339222,
      "FileVersion": "10.0.17763.592 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=8C5437CD76A89EC983E3B364E219944DA3DAB464,MD5=975B45B669930B0CC773EAF2B414206F,SHA256=3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2,IMPHASH=272245E2988E1E430500B852C4FB5E18",
      "IMPHASH": "272245E2988E1E430500B852C4FB5E18",
      "Image": "C:\\Windows\\System32\\cmd.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-F938-5F1D-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "975B45B669930B0CC773EAF2B414206F",
      "Opcode": 0,
      "OriginalFileName": "Cmd.Exe",
      "OriginalLogfile": "CVE-2020-0796_SMBV3Ghost_LocalPrivEsc_Sysmon_3_1_10.evtx",
      "ParentCommandLine": "winlogon.exe",
      "ParentImage": "C:\\Windows\\System32\\winlogon.exe",
      "ParentProcessGuid": "747F3D96-F938-5F1D-0000-00104B500000",
      "ParentProcessId": 584,
      "ProcessGuid": "747F3D96-0306-5F1E-0000-0010E15F3100",
      "ProcessID": 3332,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "8C5437CD76A89EC983E3B364E219944DA3DAB464",
      "SHA256": "3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2",
      "SystemTime": "2020-07-26T22:26:14.523075Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 4376,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-07-26 22:26:14.521",
      "Version": 5
    }
  ]
}]