[{
  "title": "CMSTP UAC Bypass via COM Object Access",
  "id": "4b60e6f2-bf39-47b4-b4ea-398e33cfe253",
  "description": "Detects UAC Bypass Attempt Using Microsoft Connection Manager Profile Installer Autoelevate-capable COM Objects (e.g. UACMe ID of 41, 43, 58 or 65)",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (ParentImage LIKE '%\\\\DllHost.exe' ESCAPE '\\' AND (ParentCommandLine LIKE '% /Processid:{3E5FC7F9-9A51-4367-9063-A120244FBEC7}%' ESCAPE '\\' OR ParentCommandLine LIKE '% /Processid:{3E000D72-A845-4CD9-BD83-80C07C3B881F}%' ESCAPE '\\' OR ParentCommandLine LIKE '% /Processid:{BD54C901-076B-434E-B6C7-17C531F4AB41}%' ESCAPE '\\' OR ParentCommandLine LIKE '% /Processid:{D2E7041B-2927-42FB-8E9F-7CE93B6DC937}%' ESCAPE '\\' OR ParentCommandLine LIKE '% /Processid:{E9495B87-D950-4AB5-87A5-FF6D70BF3E90}%' ESCAPE '\\') AND (IntegrityLevel='High' OR IntegrityLevel='System' OR IntegrityLevel='S-1-16-16384' OR IntegrityLevel='S-1-16-12288')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.execution",
    "attack.defense-evasion",
    "attack.privilege-escalation",
    "attack.t1548.002",
    "attack.t1218.003",
    "attack.g0069",
    "car.2019-04-001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 5,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "C:\\Users\\IEUser\\AppData\\Local\\Temp\\DNeruK\\system32\\Clipup.exe -o -previd pe386",
      "Company": "Hazardous Environments",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "UACMe proxy DLL",
      "EventID": 1,
      "EventRecordID": 143188,
      "FileVersion": "3.1.9.1905",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=C2558B74F5273E7AC7AD1D11B0A8591EFE73E088,MD5=C960E3BB9D2A99573DB7D5576AD5F3C3,SHA256=8A20DBB729093D3BD3E5A9F6541895DC6F4B1899ABA4B66160B5F6A1D0CD33CA,IMPHASH=069E5461D2FBAD8D4C3909C4E0340847",
      "IMPHASH": "069E5461D2FBAD8D4C3909C4E0340847",
      "Image": "C:\\Users\\IEUser\\AppData\\Local\\Temp\\DNeruK\\system32\\Clipup.exe",
      "IntegrityLevel": "High",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-B086-5EBA-0000-0020BF9E0800",
      "LogonId": "0x89ebf",
      "MD5": "C960E3BB9D2A99573DB7D5576AD5F3C3",
      "Opcode": 0,
      "OriginalFileName": "Fubuki.dll",
      "OriginalLogfile": "Sysmon_uacme_58.evtx",
      "ParentCommandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{BD54C901-076B-434E-B6C7-17C531F4AB41}",
      "ParentImage": "C:\\Windows\\System32\\dllhost.exe",
      "ParentProcessGuid": "747F3D96-BB89-5EBA-0000-001082613600",
      "ParentProcessId": 3664,
      "ProcessGuid": "747F3D96-BB89-5EBA-0000-001042653600",
      "ProcessID": 2856,
      "Product": "UACMe",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "C2558B74F5273E7AC7AD1D11B0A8591EFE73E088",
      "SHA256": "8A20DBB729093D3BD3E5A9F6541895DC6F4B1899ABA4B66160B5F6A1D0CD33CA",
      "SystemTime": "2020-05-12T15:06:49.390885Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 3608,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-05-12 15:06:49.387",
      "Version": 5
    }
  ]
},
{
  "title": "HackTool - UACMe Akagi Execution",
  "id": "d38d2fa4-98e6-4a24-aff1-410b0c9ad177",
  "description": "Detects the execution of UACMe, a tool used for UAC bypasses, via default PE metadata",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((Product='UACMe' OR (Company='REvol Corp' OR Company='APT 92' OR Company='UG North' OR Company='Hazardous Environments' OR Company='CD Project Rekt') OR (Description='UACMe main module' OR Description='Pentesting utility') OR (OriginalFileName='Akagi.exe' OR OriginalFileName='Akagi64.exe')) OR (Image LIKE '%\\\\Akagi64.exe' ESCAPE '\\' OR Image LIKE '%\\\\Akagi.exe' ESCAPE '\\') OR (Hashes LIKE '%IMPHASH=767637C23BB42CD5D7397CF58B0BE688%' ESCAPE '\\' OR Hashes LIKE '%IMPHASH=14C4E4C72BA075E9069EE67F39188AD8%' ESCAPE '\\' OR Hashes LIKE '%IMPHASH=3C782813D4AFCE07BBFC5A9772ACDBDC%' ESCAPE '\\' OR Hashes LIKE '%IMPHASH=7D010C6BB6A3726F327F7E239166D127%' ESCAPE '\\' OR Hashes LIKE '%IMPHASH=89159BA4DD04E4CE5559F132A9964EB3%' ESCAPE '\\' OR Hashes LIKE '%IMPHASH=6F33F4A5FC42B8CEC7314947BD13F30F%' ESCAPE '\\' OR Hashes LIKE '%IMPHASH=5834ED4291BDEB928270428EBBAF7604%' ESCAPE '\\' OR Hashes LIKE '%IMPHASH=5A8A8A43F25485E7EE1B201EDCBC7A38%' ESCAPE '\\' OR Hashes LIKE '%IMPHASH=DC7D30B90B2D8ABF664FBED2B1B59894%' ESCAPE '\\' OR Hashes LIKE '%IMPHASH=41923EA1F824FE63EA5BEB84DB7A3E74%' ESCAPE '\\' OR Hashes LIKE '%IMPHASH=3DE09703C8E79ED2CA3F01074719906B%' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.privilege-escalation",
    "attack.t1548.002"
  ],
  "count": 2,
  "matches": [
    {
      "row_id": 1,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "Akagi.exe  58 c:\\Windows\\System32\\cmd.exe",
      "Company": "Hazardous Environments",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Users\\IEUser\\Tools\\PrivEsc\\",
      "Description": "UACMe main module",
      "EventID": 1,
      "EventRecordID": 143173,
      "FileVersion": "3.2.5.2005",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=874C9878FF9C1A9AC60658E83649370EA4E61829,MD5=FD17237A6B50C51CBEB45A28E0284063,SHA256=B4E9DCFC87014B2B70CC9E3CD4E34AE4425E40C81A2ED008C7D335E3F96ADD19,IMPHASH=FF31A97D8C8EBEBDA4D7B3DF95E756F1",
      "IMPHASH": "FF31A97D8C8EBEBDA4D7B3DF95E756F1",
      "Image": "C:\\Users\\IEUser\\Tools\\PrivEsc\\Akagi.exe",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-B086-5EBA-0000-0020EF9E0800",
      "LogonId": "0x89eef",
      "MD5": "FD17237A6B50C51CBEB45A28E0284063",
      "Opcode": 0,
      "OriginalFileName": "Akagi.exe",
      "OriginalLogfile": "Sysmon_uacme_58.evtx",
      "ParentCommandLine": "\"C:\\Windows\\system32\\cmd.exe\"",
      "ParentImage": "C:\\Windows\\System32\\cmd.exe",
      "ParentProcessGuid": "747F3D96-B093-5EBA-0000-0010E7350E00",
      "ParentProcessId": 6708,
      "ProcessGuid": "747F3D96-BB89-5EBA-0000-001057413600",
      "ProcessID": 2856,
      "Product": "UACMe",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "874C9878FF9C1A9AC60658E83649370EA4E61829",
      "SHA256": "B4E9DCFC87014B2B70CC9E3CD4E34AE4425E40C81A2ED008C7D335E3F96ADD19",
      "SystemTime": "2020-05-12T15:06:49.019031Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 3608,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-05-12 15:06:49.006",
      "Version": 5
    },
    {
      "row_id": 5,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "C:\\Users\\IEUser\\AppData\\Local\\Temp\\DNeruK\\system32\\Clipup.exe -o -previd pe386",
      "Company": "Hazardous Environments",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "UACMe proxy DLL",
      "EventID": 1,
      "EventRecordID": 143188,
      "FileVersion": "3.1.9.1905",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=C2558B74F5273E7AC7AD1D11B0A8591EFE73E088,MD5=C960E3BB9D2A99573DB7D5576AD5F3C3,SHA256=8A20DBB729093D3BD3E5A9F6541895DC6F4B1899ABA4B66160B5F6A1D0CD33CA,IMPHASH=069E5461D2FBAD8D4C3909C4E0340847",
      "IMPHASH": "069E5461D2FBAD8D4C3909C4E0340847",
      "Image": "C:\\Users\\IEUser\\AppData\\Local\\Temp\\DNeruK\\system32\\Clipup.exe",
      "IntegrityLevel": "High",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-B086-5EBA-0000-0020BF9E0800",
      "LogonId": "0x89ebf",
      "MD5": "C960E3BB9D2A99573DB7D5576AD5F3C3",
      "Opcode": 0,
      "OriginalFileName": "Fubuki.dll",
      "OriginalLogfile": "Sysmon_uacme_58.evtx",
      "ParentCommandLine": "C:\\Windows\\system32\\DllHost.exe /Processid:{BD54C901-076B-434E-B6C7-17C531F4AB41}",
      "ParentImage": "C:\\Windows\\System32\\dllhost.exe",
      "ParentProcessGuid": "747F3D96-BB89-5EBA-0000-001082613600",
      "ParentProcessId": 3664,
      "ProcessGuid": "747F3D96-BB89-5EBA-0000-001042653600",
      "ProcessID": 2856,
      "Product": "UACMe",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "C2558B74F5273E7AC7AD1D11B0A8591EFE73E088",
      "SHA256": "8A20DBB729093D3BD3E5A9F6541895DC6F4B1899ABA4B66160B5F6A1D0CD33CA",
      "SystemTime": "2020-05-12T15:06:49.390885Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 3608,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-05-12 15:06:49.387",
      "Version": 5
    }
  ]
},
{
  "title": "Bypass UAC Using SilentCleanup Task",
  "id": "724ea201-6514-4f38-9739-e5973c34f49a",
  "description": "Detects the setting of the environement variable \"windir\" to a non default value.\nAttackers often abuse this variable in order to trigger a UAC bypass via the \"SilentCleanup\" task.\nThe SilentCleanup task located in %windir%\\system32\\cleanmgr.exe is an auto-elevated task that can be abused to elevate any file with administrator privileges without prompting UAC.\n",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=13 AND (TargetObject LIKE '%\\\\Environment\\\\windir' ESCAPE '\\' AND (NOT Details LIKE '\\%SystemRoot\\%' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.defense-evasion",
    "attack.t1548.002"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "MSEDGEWIN10",
      "Details": "C:\\Users\\IEUser\\AppData\\Local\\Temp\\DNeruK",
      "EventID": 13,
      "EventRecordID": 143174,
      "EventType": "SetValue",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\explorer.exe",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "Sysmon_uacme_58.evtx",
      "ProcessGuid": "747F3D96-BB89-5EBA-0000-001057413600",
      "ProcessID": 2856,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "PrivEsc - Rogue Windir - UAC bypass prep",
      "SystemTime": "2020-05-12T15:06:49.183867Z",
      "TargetObject": "HKU\\S-1-5-21-3461203602-4096304019-2269080069-1000\\Environment\\windir",
      "Task": 13,
      "ThreadID": 3608,
      "UserID": "S-1-5-18",
      "UtcTime": "2020-05-12 15:06:49.118",
      "Version": 2
    }
  ]
},
{
  "title": "Suspicious Environment Variable Has Been Registered",
  "id": "966315ef-c5e1-4767-ba25-fce9c8de3660",
  "description": "Detects the creation of user-specific or system-wide environment variables via the registry. Which contains suspicious commands and strings",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=13 AND (TargetObject LIKE '%\\\\Environment\\\\%' ESCAPE '\\' AND ((Details='powershell' OR Details='pwsh') OR (Details LIKE '%\\\\AppData\\\\Local\\\\Temp\\\\%' ESCAPE '\\' OR Details LIKE '%C:\\\\Users\\\\Public\\\\%' ESCAPE '\\' OR Details LIKE '%TVqQAAMAAAAEAAAA%' ESCAPE '\\' OR Details LIKE '%TVpQAAIAAAAEAA8A%' ESCAPE '\\' OR Details LIKE '%TVqAAAEAAAAEABAA%' ESCAPE '\\' OR Details LIKE '%TVoAAAAAAAAAAAAA%' ESCAPE '\\' OR Details LIKE '%TVpTAQEAAAAEAAAA%' ESCAPE '\\' OR Details LIKE '%SW52b2tlL%' ESCAPE '\\' OR Details LIKE '%ludm9rZS%' ESCAPE '\\' OR Details LIKE '%JbnZva2Ut%' ESCAPE '\\' OR Details LIKE '%SQBuAHYAbwBrAGUALQ%' ESCAPE '\\' OR Details LIKE '%kAbgB2AG8AawBlAC0A%' ESCAPE '\\' OR Details LIKE '%JAG4AdgBvAGsAZQAtA%' ESCAPE '\\') OR (Details LIKE 'SUVY%' ESCAPE '\\' OR Details LIKE 'SQBFAF%' ESCAPE '\\' OR Details LIKE 'SQBuAH%' ESCAPE '\\' OR Details LIKE 'cwBhA%' ESCAPE '\\' OR Details LIKE 'aWV4%' ESCAPE '\\' OR Details LIKE 'aQBlA%' ESCAPE '\\' OR Details LIKE 'R2V0%' ESCAPE '\\' OR Details LIKE 'dmFy%' ESCAPE '\\' OR Details LIKE 'dgBhA%' ESCAPE '\\' OR Details LIKE 'dXNpbm%' ESCAPE '\\' OR Details LIKE 'H4sIA%' ESCAPE '\\' OR Details LIKE 'Y21k%' ESCAPE '\\' OR Details LIKE 'cABhAH%' ESCAPE '\\' OR Details LIKE 'Qzpc%' ESCAPE '\\' OR Details LIKE 'Yzpc%' ESCAPE '\\'))))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.persistence"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "MSEDGEWIN10",
      "Details": "C:\\Users\\IEUser\\AppData\\Local\\Temp\\DNeruK",
      "EventID": 13,
      "EventRecordID": 143174,
      "EventType": "SetValue",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\explorer.exe",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "Sysmon_uacme_58.evtx",
      "ProcessGuid": "747F3D96-BB89-5EBA-0000-001057413600",
      "ProcessID": 2856,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "PrivEsc - Rogue Windir - UAC bypass prep",
      "SystemTime": "2020-05-12T15:06:49.183867Z",
      "TargetObject": "HKU\\S-1-5-21-3461203602-4096304019-2269080069-1000\\Environment\\windir",
      "Task": 13,
      "ThreadID": 3608,
      "UserID": "S-1-5-18",
      "UtcTime": "2020-05-12 15:06:49.118",
      "Version": 2
    }
  ]
}]