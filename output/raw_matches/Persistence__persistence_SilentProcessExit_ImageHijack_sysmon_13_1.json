[{
  "title": "Potential Persistence Via GlobalFlags",
  "id": "36803969-5421-41ec-b92f-8500f79c23b0",
  "description": "Detects registry persistence technique using the GlobalFlags and SilentProcessExit keys",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=13 AND ((TargetObject LIKE '%\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\%' ESCAPE '\\' AND TargetObject LIKE '%\\\\Image File Execution Options\\\\%' ESCAPE '\\' AND TargetObject LIKE '%\\\\GlobalFlag%' ESCAPE '\\') OR ((TargetObject LIKE '%\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\%' ESCAPE '\\' AND TargetObject LIKE '%\\\\SilentProcessExit\\\\%' ESCAPE '\\') AND (TargetObject LIKE '%\\\\ReportingMode%' ESCAPE '\\' OR TargetObject LIKE '%\\\\MonitorProcess%' ESCAPE '\\'))))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.persistence",
    "attack.defense-evasion",
    "attack.t1546.012",
    "car.2013-01-002"
  ],
  "count": 3,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "IEWIN7",
      "Details": "DWORD (0x00000200)",
      "EventID": 13,
      "EventRecordID": 8034,
      "EventType": "SetValue",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\system32\\reg.exe",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "persistence_SilentProcessExit_ImageHijack_sysmon_13_1.evtx",
      "ProcessGuid": "365ABB72-6F5D-5D0A-0000-00109B331300",
      "ProcessID": 284,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SystemTime": "2019-06-19T17:22:41.709638Z",
      "TargetObject": "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\notepad.exe\\GlobalFlag",
      "Task": 13,
      "ThreadID": 2076,
      "UserID": "S-1-5-18",
      "UtcTime": "2019-06-19 17:22:41.709",
      "Version": 2
    },
    {
      "row_id": 4,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "IEWIN7",
      "Details": "DWORD (0x00000001)",
      "EventID": 13,
      "EventRecordID": 8036,
      "EventType": "SetValue",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\system32\\reg.exe",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "persistence_SilentProcessExit_ImageHijack_sysmon_13_1.evtx",
      "ProcessGuid": "365ABB72-6F61-5D0A-0000-0010DB351300",
      "ProcessID": 284,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "Persistence via SilentProcessExit hijack",
      "SystemTime": "2019-06-19T17:22:43.944013Z",
      "TargetObject": "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\notepad.exe\\ReportingMode",
      "Task": 13,
      "ThreadID": 2076,
      "UserID": "S-1-5-18",
      "UtcTime": "2019-06-19 17:22:43.912",
      "Version": 2
    },
    {
      "row_id": 6,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "IEWIN7",
      "Details": "C:\\windows\\temp\\evil.exe",
      "EventID": 13,
      "EventRecordID": 8038,
      "EventType": "SetValue",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\system32\\reg.exe",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "persistence_SilentProcessExit_ImageHijack_sysmon_13_1.evtx",
      "ProcessGuid": "365ABB72-6F63-5D0A-0000-0010F93A1300",
      "ProcessID": 284,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "Persistence via SilentProcessExit hijack",
      "SystemTime": "2019-06-19T17:22:45.694013Z",
      "TargetObject": "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\notepad.exe\\MonitorProcess",
      "Task": 13,
      "ThreadID": 2076,
      "UserID": "S-1-5-18",
      "UtcTime": "2019-06-19 17:22:45.678",
      "Version": 2
    }
  ]
},
{
  "title": "CurrentVersion NT Autorun Keys Modification",
  "id": "cbf93e5d-ca6c-4722-8bea-e9119007c248",
  "description": "Detects modification of autostart extensibility point (ASEP) in registry.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=13 AND ((TargetObject LIKE '%\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion%' ESCAPE '\\' AND (TargetObject LIKE '%\\\\Winlogon\\\\VmApplet%' ESCAPE '\\' OR TargetObject LIKE '%\\\\Winlogon\\\\Userinit%' ESCAPE '\\' OR TargetObject LIKE '%\\\\Winlogon\\\\Taskman%' ESCAPE '\\' OR TargetObject LIKE '%\\\\Winlogon\\\\Shell%' ESCAPE '\\' OR TargetObject LIKE '%\\\\Winlogon\\\\GpExtensions%' ESCAPE '\\' OR TargetObject LIKE '%\\\\Winlogon\\\\AppSetup%' ESCAPE '\\' OR TargetObject LIKE '%\\\\Winlogon\\\\AlternateShells\\\\AvailableShells%' ESCAPE '\\' OR TargetObject LIKE '%\\\\Windows\\\\IconServiceLib%' ESCAPE '\\' OR TargetObject LIKE '%\\\\Windows\\\\Appinit\\_Dlls%' ESCAPE '\\' OR TargetObject LIKE '%\\\\Image File Execution Options%' ESCAPE '\\' OR TargetObject LIKE '%\\\\Font Drivers%' ESCAPE '\\' OR TargetObject LIKE '%\\\\Drivers32%' ESCAPE '\\' OR TargetObject LIKE '%\\\\Windows\\\\Run%' ESCAPE '\\' OR TargetObject LIKE '%\\\\Windows\\\\Load%' ESCAPE '\\')) AND (NOT (Details='(Empty)' OR Details IS NULL OR Image LIKE 'C:\\\\Windows\\\\System32\\\\poqexec.exe' ESCAPE '\\' OR (TargetObject LIKE '%\\\\Image File Execution Options\\\\%' ESCAPE '\\' AND (TargetObject LIKE '%\\\\DisableExceptionChainValidation' ESCAPE '\\' OR TargetObject LIKE '%\\\\MitigationOptions' ESCAPE '\\')) OR (Image LIKE 'C:\\\\Windows\\\\system32\\\\svchost.exe' ESCAPE '\\' AND (TargetObject LIKE '%\\\\Winlogon\\\\GPExtensions\\\\{827D319E-6EAC-11D2-A4EA-00C04F79F83A}\\\\PreviousPolicyAreas%' ESCAPE '\\' OR TargetObject LIKE '%\\\\Winlogon\\\\GPExtensions\\\\{827D319E-6EAC-11D2-A4EA-00C04F79F83A}\\\\MaxNoGPOListChangesInterval%' ESCAPE '\\') AND (Details='DWORD (0x00000001)' OR Details='DWORD (0x00000009)' OR Details='DWORD (0x000003c0)')) OR (Image LIKE 'C:\\\\Windows\\\\System32\\\\RuntimeBroker.exe' ESCAPE '\\' AND TargetObject LIKE '%\\\\runtimebroker.exe\\\\Microsoft.Windows.ShellExperienceHost%' ESCAPE '\\'))) AND (NOT ((Image LIKE 'C:\\\\Program Files (x86)\\\\Microsoft\\\\Temp\\\\%' ESCAPE '\\' AND Image LIKE '%\\\\MicrosoftEdgeUpdate.exe' ESCAPE '\\') OR ((Image LIKE 'C:\\\\Program Files (x86)\\\\Avira\\\\Antivirus\\\\avguard.exe%' ESCAPE '\\' OR Image LIKE 'C:\\\\Program Files\\\\Avira\\\\Antivirus\\\\avguard.exe%' ESCAPE '\\') AND TargetObject LIKE '%SOFTWARE\\\\WOW6432Node\\\\Avira\\\\Antivirus\\\\Overwrite\\_Keys\\\\HKEY\\_LOCAL\\_MACHINE\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\%' ESCAPE '\\' AND (TargetObject LIKE '%\\\\userinit\\\\UseAsDefault' ESCAPE '\\' OR TargetObject LIKE '%\\\\shell\\\\UseAsDefault' ESCAPE '\\') AND (Details='explorer.exe' OR Details LIKE 'C:\\\\Windows\\\\system32\\\\userinit.exe,' ESCAPE '\\')) OR ((TargetObject LIKE '%\\\\ClickToRunStore\\\\HKLM\\\\SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\%' ESCAPE '\\' OR TargetObject LIKE '%\\\\ClickToRun\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\%' ESCAPE '\\') OR (Image LIKE 'C:\\\\Program Files\\\\Microsoft Office\\\\root\\\\integration\\\\integrator.exe' ESCAPE '\\' OR Image LIKE 'C:\\\\Program Files (x86)\\\\Microsoft Office\\\\root\\\\integration\\\\integrator.exe' ESCAPE '\\')) OR ((Image LIKE 'C:\\\\Program Files\\\\Common Files\\\\Microsoft Shared\\\\ClickToRun\\\\%' ESCAPE '\\' OR Image LIKE 'C:\\\\Program Files\\\\Common Files\\\\Microsoft Shared\\\\ClickToRun\\\\Updates\\\\%' ESCAPE '\\') AND Image LIKE '%\\\\OfficeClickToRun.exe' ESCAPE '\\') OR (Image LIKE 'C:\\\\Windows\\\\Microsoft.NET\\\\Framework%' ESCAPE '\\' AND Image LIKE '%\\\\ngen.exe' ESCAPE '\\') OR (Image LIKE '%\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\StandaloneUpdater\\\\OneDriveSetup.exe' ESCAPE '\\' AND TargetObject LIKE '%\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce\\\\Delete Cached Update Binary' ESCAPE '\\' AND Details LIKE 'C:\\\\Windows\\\\system32\\\\cmd.exe /q /c del /q \"C:\\\\Users\\\\%' ESCAPE '\\' AND Details LIKE '%\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\Update\\\\OneDriveSetup.exe\"' ESCAPE '\\')))))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.privilege-escalation",
    "attack.persistence",
    "attack.t1547.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "IEWIN7",
      "Details": "DWORD (0x00000200)",
      "EventID": 13,
      "EventRecordID": 8034,
      "EventType": "SetValue",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\system32\\reg.exe",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "persistence_SilentProcessExit_ImageHijack_sysmon_13_1.evtx",
      "ProcessGuid": "365ABB72-6F5D-5D0A-0000-00109B331300",
      "ProcessID": 284,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SystemTime": "2019-06-19T17:22:41.709638Z",
      "TargetObject": "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\notepad.exe\\GlobalFlag",
      "Task": 13,
      "ThreadID": 2076,
      "UserID": "S-1-5-18",
      "UtcTime": "2019-06-19 17:22:41.709",
      "Version": 2
    }
  ]
}]