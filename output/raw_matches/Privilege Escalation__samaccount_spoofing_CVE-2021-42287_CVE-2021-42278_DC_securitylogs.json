[{
  "title": "Security Eventlog Cleared",
  "id": "d99b79d2-0a6f-4f46-ad8b-260b6e17f982",
  "description": "One of the Windows Eventlogs has been cleared. e.g. caused by \"wevtutil cl\" command execution",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND ((EventID=517 AND Provider_Name='Security') OR (EventID=1102 AND Provider_Name='Microsoft-Windows-Eventlog'))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.t1070.001",
    "car.2016-04-002"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "Channel": "Security",
      "Computer": "01566s-win16-ir.threebeesco.com",
      "EventID": 1102,
      "EventRecordID": 2982081,
      "Guid": "{fc65ddd8-d6ef-4962-83d5-6e5cfe9ce148}",
      "Keywords": "0x4020000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "samaccount_spoofing_CVE-2021-42287_CVE-2021-42278_DC_securitylogs.evtx",
      "ProcessID": 472,
      "Provider_Name": "Microsoft-Windows-Eventlog",
      "SubjectDomainName": "3B",
      "SubjectLogonId": "0x364f7",
      "SubjectUserName": "a-jbrown",
      "SubjectUserSid": "S-1-5-21-308926384-506822093-3341789130-1106",
      "SystemTime": "2021-12-12T17:57:17.006377Z",
      "Task": 104,
      "ThreadID": 4956,
      "Version": 0
    }
  ]
},
{
  "title": "External Remote SMB Logon from Public IP",
  "id": "78d5cab4-557e-454f-9fb9-a222bd0d5edc",
  "description": "Detects successful logon from public IP address via SMB. This can indicate a publicly-exposed SMB port.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND ((EventID=4624 AND LogonType=3) AND (NOT ((IpAddress='::1/128' OR IpAddress LIKE '10.%' ESCAPE '\\' OR IpAddress LIKE '127.%' ESCAPE '\\' OR IpAddress LIKE '172.16.%' ESCAPE '\\' OR IpAddress LIKE '172.17.%' ESCAPE '\\' OR IpAddress LIKE '172.18.%' ESCAPE '\\' OR IpAddress LIKE '172.19.%' ESCAPE '\\' OR IpAddress LIKE '172.20.%' ESCAPE '\\' OR IpAddress LIKE '172.21.%' ESCAPE '\\' OR IpAddress LIKE '172.22.%' ESCAPE '\\' OR IpAddress LIKE '172.23.%' ESCAPE '\\' OR IpAddress LIKE '172.24.%' ESCAPE '\\' OR IpAddress LIKE '172.25.%' ESCAPE '\\' OR IpAddress LIKE '172.26.%' ESCAPE '\\' OR IpAddress LIKE '172.27.%' ESCAPE '\\' OR IpAddress LIKE '172.28.%' ESCAPE '\\' OR IpAddress LIKE '172.29.%' ESCAPE '\\' OR IpAddress LIKE '172.30.%' ESCAPE '\\' OR IpAddress LIKE '172.31.%' ESCAPE '\\' OR IpAddress LIKE '192.168.%' ESCAPE '\\' OR IpAddress LIKE '169.254.%' ESCAPE '\\' OR IpAddress LIKE 'fc%' ESCAPE '\\' OR IpAddress LIKE 'fd%' ESCAPE '\\' OR IpAddress LIKE 'fe8%' ESCAPE '\\' OR IpAddress LIKE 'fe9%' ESCAPE '\\' OR IpAddress LIKE 'fea%' ESCAPE '\\' OR IpAddress LIKE 'feb%' ESCAPE '\\') OR IpAddress='-')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.persistence",
    "attack.defense-evasion",
    "attack.initial-access",
    "attack.credential-access",
    "attack.t1133",
    "attack.t1078",
    "attack.t1110"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 16,
      "AuthenticationPackageName": "Kerberos",
      "Channel": "Security",
      "Computer": "01566s-win16-ir.threebeesco.com",
      "ElevatedToken": "%%1842",
      "EventID": 4624,
      "EventRecordID": 2982101,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "ImpersonationLevel": "%%1833",
      "IpAddress": "::1",
      "IpPort": "64849",
      "KeyLength": 0,
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "LmPackageName": "-",
      "LogonGuid": "E8C9AC4A-31FC-C37F-B4D7-B3217C608858",
      "LogonProcessName": "Kerberos",
      "LogonType": 3,
      "Opcode": 0,
      "OriginalLogfile": "samaccount_spoofing_CVE-2021-42287_CVE-2021-42278_DC_securitylogs.evtx",
      "ProcessID": 624,
      "ProcessName": "-",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "RestrictedAdminMode": "-",
      "SubjectDomainName": "-",
      "SubjectLogonId": "0x0",
      "SubjectUserName": "-",
      "SubjectUserSid": "S-1-0-0",
      "SystemTime": "2021-12-12T17:58:04.842263Z",
      "TargetDomainName": "THREEBEESCO.COM",
      "TargetLinkedLogonId": "0x0",
      "TargetLogonId": "0x73b44c",
      "TargetOutboundDomainName": "-",
      "TargetOutboundUserName": "-",
      "TargetUserName": "01566S-WIN16-IR$",
      "TargetUserSid": "S-1-5-18",
      "Task": 12544,
      "ThreadID": 3652,
      "TransmittedServices": "-",
      "Version": 2,
      "VirtualAccount": "%%1843",
      "WorkstationName": "-"
    }
  ]
},
{
  "title": "Suspicious Computer Account Name Change CVE-2021-42287",
  "id": "45eb2ae2-9aa2-4c3a-99a5-6e5077655466",
  "description": "Detects the renaming of an existing computer account to a account name that doesn't contain a $ symbol as seen in attacks against CVE-2021-42287",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND ((EventID=4781 AND OldTargetUserName LIKE '%$%' ESCAPE '\\') AND (NOT NewTargetUserName LIKE '%$%' ESCAPE '\\'))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.defense-evasion",
    "attack.persistence",
    "attack.t1036",
    "attack.t1098",
    "cve.2021-42287",
    "detection.emerging-threats"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 10,
      "Channel": "Security",
      "Computer": "01566s-win16-ir.threebeesco.com",
      "EventID": 4781,
      "EventRecordID": 2982094,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "NewTargetUserName": "01566s-win16-ir",
      "OldTargetUserName": "DC012$",
      "Opcode": 0,
      "OriginalLogfile": "samaccount_spoofing_CVE-2021-42287_CVE-2021-42278_DC_securitylogs.evtx",
      "PrivilegeList": "-",
      "ProcessID": 624,
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "SubjectDomainName": "3B",
      "SubjectLogonId": "0x738ce4",
      "SubjectUserName": "lgrove",
      "SubjectUserSid": "S-1-5-21-308926384-506822093-3341789130-101606",
      "SystemTime": "2021-12-12T17:57:52.375105Z",
      "TargetDomainName": "3B",
      "TargetSid": "S-1-5-21-308926384-506822093-3341789130-220105",
      "Task": 13824,
      "ThreadID": 3652,
      "Version": 0
    }
  ]
},
{
  "title": "Add or Remove Computer from DC",
  "id": "20d96d95-5a20-4cf1-a483-f3bda8a7c037",
  "description": "Detects the creation or removal of a computer. Can be used to detect attacks such as DCShadow via the creation of a new SPN.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Security' AND (EventID=4741 OR EventID=4743)"
  ],
  "rule_level": "low",
  "tags": [
    "attack.defense-evasion",
    "attack.t1207"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 5,
      "AccountExpires": "%%1794",
      "AllowedToDelegateTo": "-",
      "Channel": "Security",
      "Computer": "01566s-win16-ir.threebeesco.com",
      "DisplayName": "-",
      "DnsHostName": "DC012.threebeesco.com",
      "EventID": 4741,
      "EventRecordID": 2982085,
      "Guid": "54849625-5478-4994-A5BA-3E3B0328C30D",
      "HomeDirectory": "-",
      "HomePath": "-",
      "Keywords": "0x8020000000000000",
      "Level": 0,
      "LogonHours": "%%1793",
      "NewUacValue": "0x80",
      "OldUacValue": "0x0",
      "Opcode": 0,
      "OriginalLogfile": "samaccount_spoofing_CVE-2021-42287_CVE-2021-42278_DC_securitylogs.evtx",
      "PasswordLastSet": "12/12/2021 9:57:52 AM",
      "PrimaryGroupId": "515",
      "PrivilegeList": "-",
      "ProcessID": 624,
      "ProfilePath": "-",
      "Provider_Name": "Microsoft-Windows-Security-Auditing",
      "SAMAccountName": "DC012$",
      "ScriptPath": "-",
      "ServicePrincipalNames": "\r\n\t\tHOST/DC012.threebeesco.com\r\n\t\tRestrictedKrbHost/DC012.threebeesco.com\r\n\t\tHOST/DC012\r\n\t\tRestrictedKrbHost/DC012",
      "SidHistory": "-",
      "SubjectDomainName": "3B",
      "SubjectLogonId": "0x738ae4",
      "SubjectUserName": "lgrove",
      "SubjectUserSid": "S-1-5-21-308926384-506822093-3341789130-101606",
      "SystemTime": "2021-12-12T17:57:52.313673Z",
      "TargetDomainName": "3B",
      "TargetSid": "S-1-5-21-308926384-506822093-3341789130-220105",
      "TargetUserName": "DC012$",
      "Task": 13825,
      "ThreadID": 3652,
      "UserAccountControl": "\r\n\t\t%%2087",
      "UserParameters": "-",
      "UserPrincipalName": "-",
      "UserWorkstations": "-",
      "Version": 0
    }
  ]
}]