[{
  "title": "Abused Debug Privilege by Arbitrary Parent Processes",
  "id": "d522eca2-2973-4391-a3e0-ef0374321dae",
  "description": "Detection of unusual child processes by different system processes",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((((ParentImage LIKE '%\\\\winlogon.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\services.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\lsass.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\csrss.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\smss.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\wininit.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\spoolsv.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\searchindexer.exe' ESCAPE '\\') AND (User LIKE '%AUTHORI%' ESCAPE '\\' OR User LIKE '%AUTORI%' ESCAPE '\\')) AND ((Image LIKE '%\\\\powershell.exe' ESCAPE '\\' OR Image LIKE '%\\\\pwsh.exe' ESCAPE '\\' OR Image LIKE '%\\\\cmd.exe' ESCAPE '\\') OR (OriginalFileName='PowerShell.EXE' OR OriginalFileName='pwsh.dll' OR OriginalFileName='Cmd.Exe'))) AND (NOT (CommandLine LIKE '% route %' ESCAPE '\\' AND CommandLine LIKE '% ADD %' ESCAPE '\\'))))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.privilege-escalation",
    "attack.t1548"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 55,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "c:\\Program Files\\vulnsvc\\mmm.exe",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows Command Processor",
      "EventID": 1,
      "EventRecordID": 27636,
      "FileVersion": "10.0.17763.592 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=8C5437CD76A89EC983E3B364E219944DA3DAB464,MD5=975B45B669930B0CC773EAF2B414206F,SHA256=3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2,IMPHASH=272245E2988E1E430500B852C4FB5E18",
      "IMPHASH": "272245E2988E1E430500B852C4FB5E18",
      "Image": "C:\\program.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-B764-5EA4-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "975B45B669930B0CC773EAF2B414206F",
      "Opcode": 0,
      "OriginalFileName": "Cmd.Exe",
      "OriginalLogfile": "privesc_unquoted_svc_sysmon_1_11.evtx",
      "ParentCommandLine": "C:\\Windows\\system32\\services.exe",
      "ParentImage": "C:\\Windows\\System32\\services.exe",
      "ParentProcessGuid": "747F3D96-B764-5EA4-0000-00106F550000",
      "ParentProcessId": 584,
      "ProcessGuid": "747F3D96-B766-5EA4-0000-0010E7880100",
      "ProcessID": 2796,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "PrivEsc - Potential Unquoted Service Exploit",
      "SHA1": "8C5437CD76A89EC983E3B364E219944DA3DAB464",
      "SHA256": "3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2",
      "SystemTime": "2020-04-25T22:19:28.080717Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 3572,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-04-25 22:19:18.317",
      "Version": 5
    }
  ]
},
{
  "title": "Creation Exe for Service with Unquoted Path",
  "id": "8c3c76ca-8f8b-4b1d-aaf3-81aebcd367c9",
  "description": "Adversaries may execute their own malicious payloads by hijacking vulnerable file path references.\nAdversaries can take advantage of paths that lack surrounding quotations by placing an executable in a higher level directory within the path, so that Windows will choose the adversary's executable to launch.\n",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=11 AND TargetFilename LIKE 'C:\\\\program.exe' ESCAPE '\\')"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.persistence",
    "attack.t1547.009"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 1,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "MSEDGEWIN10",
      "CreationUtcTime": "2020-04-25 22:18:47.120",
      "EventID": 11,
      "EventRecordID": 27292,
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "C:\\Windows\\system32\\cmd.exe",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "privesc_unquoted_svc_sysmon_1_11.evtx",
      "ProcessGuid": "747F3D96-B521-5EA4-0000-00108C171300",
      "ProcessID": 2752,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "PrivEsc - Potential PrivEsc via unquoted Service",
      "SystemTime": "2020-04-25T22:18:47.143475Z",
      "TargetFileName": "C:\\program.exe",
      "Task": 11,
      "ThreadID": 3576,
      "UserID": "S-1-5-18",
      "UtcTime": "2020-04-25 22:18:47.120",
      "Version": 2
    }
  ]
},
{
  "title": "Uncommon Svchost Parent Process",
  "id": "01d2e2a1-5f09-44f7-9fc1-24faa7479b6d",
  "description": "Detects an uncommon svchost parent process",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (Image LIKE '%\\\\svchost.exe' ESCAPE '\\' AND (NOT ((ParentImage LIKE '%\\\\Mrt.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\MsMpEng.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\ngen.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\rpcnet.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\services.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\TiWorker.exe' ESCAPE '\\') OR ParentImage IS NULL OR (ParentImage='-' OR ParentImage='')))))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.defense-evasion",
    "attack.t1036.005"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 3,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "C:\\Windows\\system32\\svchost.exe -k netsvcs -p -s gpsvc",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Host Process for Windows Services",
      "EventID": 1,
      "EventRecordID": 27334,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=A1385CE20AD79F55DF235EFFD9780C31442AA234,MD5=8A0A29438052FAED8A2532DA50455756,SHA256=7FD065BAC18C5278777AE44908101CDFED72D26FA741367F0AD4D02020787AB6,IMPHASH=247B9220E5D9B720A82B2C8B5069AD69",
      "IMPHASH": "247B9220E5D9B720A82B2C8B5069AD69",
      "Image": "C:\\Windows\\System32\\svchost.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-3384-5EA5-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "8A0A29438052FAED8A2532DA50455756",
      "Opcode": 0,
      "OriginalFileName": "svchost.exe",
      "OriginalLogfile": "privesc_unquoted_svc_sysmon_1_11.evtx",
      "ParentCommandLine": "?",
      "ParentImage": "?",
      "ParentProcessGuid": "00000000-0000-0000-0000-000000000000",
      "ParentProcessId": 596,
      "ProcessGuid": "747F3D96-B755-5EA4-0000-0010D06E2500",
      "ProcessID": 2752,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "A1385CE20AD79F55DF235EFFD9780C31442AA234",
      "SHA256": "7FD065BAC18C5278777AE44908101CDFED72D26FA741367F0AD4D02020787AB6",
      "SystemTime": "2020-04-25T22:19:02.057201Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 3576,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-04-25 22:19:01.724",
      "Version": 5
    }
  ]
},
{
  "title": "Potential Defense Evasion Via Binary Rename",
  "id": "36480ae1-a1cb-4eaa-a0d6-29801d7e9142",
  "description": "Detects the execution of a renamed binary often used by attackers or malware leveraging new Sysmon OriginalFileName datapoint.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((OriginalFileName='Cmd.Exe' OR OriginalFileName='CONHOST.EXE' OR OriginalFileName='7z.exe' OR OriginalFileName='7za.exe' OR OriginalFileName='WinRAR.exe' OR OriginalFileName='wevtutil.exe' OR OriginalFileName='net.exe' OR OriginalFileName='net1.exe' OR OriginalFileName='netsh.exe' OR OriginalFileName='InstallUtil.exe') AND (NOT (Image LIKE '%\\\\cmd.exe' ESCAPE '\\' OR Image LIKE '%\\\\conhost.exe' ESCAPE '\\' OR Image LIKE '%\\\\7z.exe' ESCAPE '\\' OR Image LIKE '%\\\\7za.exe' ESCAPE '\\' OR Image LIKE '%\\\\WinRAR.exe' ESCAPE '\\' OR Image LIKE '%\\\\wevtutil.exe' ESCAPE '\\' OR Image LIKE '%\\\\net.exe' ESCAPE '\\' OR Image LIKE '%\\\\net1.exe' ESCAPE '\\' OR Image LIKE '%\\\\netsh.exe' ESCAPE '\\' OR Image LIKE '%\\\\InstallUtil.exe' ESCAPE '\\'))))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.defense-evasion",
    "attack.t1036.003"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 55,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "c:\\Program Files\\vulnsvc\\mmm.exe",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Windows Command Processor",
      "EventID": 1,
      "EventRecordID": 27636,
      "FileVersion": "10.0.17763.592 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=8C5437CD76A89EC983E3B364E219944DA3DAB464,MD5=975B45B669930B0CC773EAF2B414206F,SHA256=3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2,IMPHASH=272245E2988E1E430500B852C4FB5E18",
      "IMPHASH": "272245E2988E1E430500B852C4FB5E18",
      "Image": "C:\\program.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-B764-5EA4-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "975B45B669930B0CC773EAF2B414206F",
      "Opcode": 0,
      "OriginalFileName": "Cmd.Exe",
      "OriginalLogfile": "privesc_unquoted_svc_sysmon_1_11.evtx",
      "ParentCommandLine": "C:\\Windows\\system32\\services.exe",
      "ParentImage": "C:\\Windows\\System32\\services.exe",
      "ParentProcessGuid": "747F3D96-B764-5EA4-0000-00106F550000",
      "ParentProcessId": 584,
      "ProcessGuid": "747F3D96-B766-5EA4-0000-0010E7880100",
      "ProcessID": 2796,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "PrivEsc - Potential Unquoted Service Exploit",
      "SHA1": "8C5437CD76A89EC983E3B364E219944DA3DAB464",
      "SHA256": "3656F37A1C6951EC4496FABB8EE957D3A6E3C276D5A3785476B482C9C0D32EA2",
      "SystemTime": "2020-04-25T22:19:28.080717Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 3572,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-04-25 22:19:18.317",
      "Version": 5
    }
  ]
},
{
  "title": "Windows Processes Suspicious Parent Directory",
  "id": "96036718-71cc-4027-a538-d1587e0006a7",
  "description": "Detect suspicious parent processes of well-known Windows processes",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((Image LIKE '%\\\\svchost.exe' ESCAPE '\\' OR Image LIKE '%\\\\taskhost.exe' ESCAPE '\\' OR Image LIKE '%\\\\lsm.exe' ESCAPE '\\' OR Image LIKE '%\\\\lsass.exe' ESCAPE '\\' OR Image LIKE '%\\\\services.exe' ESCAPE '\\' OR Image LIKE '%\\\\lsaiso.exe' ESCAPE '\\' OR Image LIKE '%\\\\csrss.exe' ESCAPE '\\' OR Image LIKE '%\\\\wininit.exe' ESCAPE '\\' OR Image LIKE '%\\\\winlogon.exe' ESCAPE '\\') AND (NOT (((ParentImage LIKE '%\\\\SavService.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\ngen.exe' ESCAPE '\\') OR (ParentImage LIKE '%\\\\System32\\\\%' ESCAPE '\\' OR ParentImage LIKE '%\\\\SysWOW64\\\\%' ESCAPE '\\')) OR ((ParentImage LIKE '%\\\\Windows Defender\\\\%' ESCAPE '\\' OR ParentImage LIKE '%\\\\Microsoft Security Client\\\\%' ESCAPE '\\') AND ParentImage LIKE '%\\\\MsMpEng.exe' ESCAPE '\\') OR (ParentImage IS NULL OR (ParentImage='' OR ParentImage='-'))))))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.defense-evasion",
    "attack.t1036.003",
    "attack.t1036.005"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 3,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "C:\\Windows\\system32\\svchost.exe -k netsvcs -p -s gpsvc",
      "Company": "Microsoft Corporation",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "Host Process for Windows Services",
      "EventID": 1,
      "EventRecordID": 27334,
      "FileVersion": "10.0.17763.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=A1385CE20AD79F55DF235EFFD9780C31442AA234,MD5=8A0A29438052FAED8A2532DA50455756,SHA256=7FD065BAC18C5278777AE44908101CDFED72D26FA741367F0AD4D02020787AB6,IMPHASH=247B9220E5D9B720A82B2C8B5069AD69",
      "IMPHASH": "247B9220E5D9B720A82B2C8B5069AD69",
      "Image": "C:\\Windows\\System32\\svchost.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-3384-5EA5-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "8A0A29438052FAED8A2532DA50455756",
      "Opcode": 0,
      "OriginalFileName": "svchost.exe",
      "OriginalLogfile": "privesc_unquoted_svc_sysmon_1_11.evtx",
      "ParentCommandLine": "?",
      "ParentImage": "?",
      "ParentProcessGuid": "00000000-0000-0000-0000-000000000000",
      "ParentProcessId": 596,
      "ProcessGuid": "747F3D96-B755-5EA4-0000-0010D06E2500",
      "ProcessID": 2752,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "A1385CE20AD79F55DF235EFFD9780C31442AA234",
      "SHA256": "7FD065BAC18C5278777AE44908101CDFED72D26FA741367F0AD4D02020787AB6",
      "SystemTime": "2020-04-25T22:19:02.057201Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 3576,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-04-25 22:19:01.724",
      "Version": 5
    }
  ]
},
{
  "title": "Potential Execution of Sysinternals Tools",
  "id": "7cccd811-7ae9-4ebe-9afd-cb5c406b824b",
  "description": "Detects command lines that contain the 'accepteula' flag which could be a sign of execution of one of the Sysinternals tools",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (CommandLine LIKE '% -accepteula%' ESCAPE '\\' OR CommandLine LIKE '% /accepteula%' ESCAPE '\\' OR CommandLine LIKE '% –accepteula%' ESCAPE '\\' OR CommandLine LIKE '% —accepteula%' ESCAPE '\\' OR CommandLine LIKE '% ―accepteula%' ESCAPE '\\'))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.resource-development",
    "attack.t1588.002"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 77,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "\"C:\\BGinfo\\BGINFO.EXE\" /accepteula /ic:\\bginfo\\bgconfig.bgi /timer:0",
      "Company": "Sysinternals",
      "Computer": "MSEDGEWIN10",
      "CurrentDirectory": "C:\\Windows\\system32\\",
      "Description": "BGInfo - Wallpaper text configurator",
      "EventID": 1,
      "EventRecordID": 27983,
      "FileVersion": "4.20",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=1CEE3FA8419BDF4CBC266461277E3FDD9B93DE25,MD5=3652BA8B882BF6C69AF70CE73CF0D616,SHA256=0362CD6E7B318AB9A4C74DAF229F11BB795A2CE553EA024CB49143456C27C41D,IMPHASH=6EC19FF15BC88DDEDB96115003A96430",
      "IMPHASH": "6EC19FF15BC88DDEDB96115003A96430",
      "Image": "C:\\BGinfo\\BGINFO.EXE",
      "IntegrityLevel": "Medium",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "747F3D96-B767-5EA4-0000-00209BD30100",
      "LogonId": "0x1d39b",
      "MD5": "3652BA8B882BF6C69AF70CE73CF0D616",
      "Opcode": 0,
      "OriginalFileName": "Bginfo.exe",
      "OriginalLogfile": "privesc_unquoted_svc_sysmon_1_11.evtx",
      "ParentCommandLine": "C:\\Windows\\Explorer.EXE",
      "ParentImage": "C:\\Windows\\explorer.exe",
      "ParentProcessGuid": "747F3D96-B76A-5EA4-0000-0010EEB50300",
      "ParentProcessId": 4600,
      "ProcessGuid": "747F3D96-B7A0-5EA4-0000-001026D11000",
      "ProcessID": 2796,
      "Product": "BGInfo",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "RuleName": "Discovery - domain time",
      "SHA1": "1CEE3FA8419BDF4CBC266461277E3FDD9B93DE25",
      "SHA256": "0362CD6E7B318AB9A4C74DAF229F11BB795A2CE553EA024CB49143456C27C41D",
      "SystemTime": "2020-04-25T22:20:16.073653Z",
      "Task": 1,
      "TerminalSessionId": 1,
      "ThreadID": 3572,
      "User": "MSEDGEWIN10\\IEUser",
      "UserID": "S-1-5-18",
      "UtcTime": "2020-04-25 22:20:16.041",
      "Version": 5
    }
  ]
}]