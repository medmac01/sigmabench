[{
  "title": "Whoami.EXE Execution From Privileged Process",
  "id": "79ce34ca-af29-4d0e-b832-fc1b377020db",
  "description": "Detects the execution of \"whoami.exe\" by privileged accounts that are often abused by threat actors",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((OriginalFileName='whoami.exe' OR Image LIKE '%\\\\whoami.exe' ESCAPE '\\') AND (User LIKE '%AUTHORI%' ESCAPE '\\' OR User LIKE '%AUTORI%' ESCAPE '\\' OR User LIKE '%TrustedInstaller%' ESCAPE '\\')))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.privilege-escalation",
    "attack.discovery",
    "attack.t1033"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 5,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "whoami",
      "Company": "Microsoft Corporation",
      "Computer": "LAPTOP-JU4M3I0E",
      "CurrentDirectory": "C:\\WINDOWS\\system32\\",
      "Description": "whoami - displays logged on user information",
      "EventID": 1,
      "EventRecordID": 1912935,
      "FileVersion": "10.0.19041.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=1915FBFDB73FDD200C47880247ACDDE5442431A9,MD5=A4A6924F3EAF97981323703D38FD99C4,SHA256=1D4902A04D99E8CCBFE7085E63155955FEE397449D386453F6C452AE407B8743,IMPHASH=7FF0758B766F747CE57DFAC70743FB88",
      "IMPHASH": "7FF0758B766F747CE57DFAC70743FB88",
      "Image": "C:\\Windows\\System32\\whoami.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "00247C92-7087-6122-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "A4A6924F3EAF97981323703D38FD99C4",
      "Opcode": 0,
      "OriginalFileName": "whoami.exe",
      "OriginalLogfile": "EfsPotato_sysmon_17_18_privesc_seimpersonate_to_system.evtx",
      "ParentCommandLine": "c:\\temp\\EfsPotato.exe  whoami",
      "ParentImage": "C:\\temp\\EfsPotato.exe",
      "ParentProcessGuid": "00247C92-A691-6122-0000-001021C31F02",
      "ParentProcessId": 14048,
      "ProcessGuid": "00247C92-A692-6122-0000-0010A5CD1F02",
      "ProcessID": 4760,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "1915FBFDB73FDD200C47880247ACDDE5442431A9",
      "SHA256": "1D4902A04D99E8CCBFE7085E63155955FEE397449D386453F6C452AE407B8743",
      "SystemTime": "2021-08-22T19:33:38.905645Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 6844,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2021-08-22 19:33:38.890",
      "Version": 5
    }
  ]
},
{
  "title": "HackTool - EfsPotato Named Pipe Creation",
  "id": "637f689e-b4a5-4a86-be0e-0100a0a33ba2",
  "description": "Detects the pattern of a pipe name as used by the hack tool EfsPotato",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND ((EventID=17 OR EventID=18) AND ((PipeName LIKE '%\\\\pipe\\\\%' ESCAPE '\\' OR PipeName LIKE '%\\\\pipe\\\\srvsvc%' ESCAPE '\\') AND (NOT (PipeName LIKE '%\\\\CtxShare%' ESCAPE '\\' OR PipeName LIKE '\\\\pipe\\\\%' ESCAPE '\\'))))"
  ],
  "rule_level": "high",
  "tags": [
    "attack.defense-evasion",
    "attack.privilege-escalation",
    "attack.t1055"
  ],
  "count": 2,
  "matches": [
    {
      "row_id": 2,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "LAPTOP-JU4M3I0E",
      "EventID": 17,
      "EventRecordID": 1912932,
      "EventType": "CreatePipe",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "c:\\temp\\EfsPotato.exe",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "EfsPotato_sysmon_17_18_privesc_seimpersonate_to_system.evtx",
      "PipeName": "\\dd4c18dc-bff6-42ce-b707-62c114b84291\\pipe\\srvsvc",
      "ProcessGuid": "00247C92-A691-6122-0000-001021C31F02",
      "ProcessID": 4760,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SystemTime": "2021-08-22T19:33:38.844084Z",
      "Task": 17,
      "ThreadID": 6844,
      "UserID": "S-1-5-18",
      "UtcTime": "2021-08-22 19:33:38.843",
      "Version": 1
    },
    {
      "row_id": 4,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "Computer": "LAPTOP-JU4M3I0E",
      "EventID": 18,
      "EventRecordID": 1912934,
      "EventType": "ConnectPipe",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Image": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "Opcode": 0,
      "OriginalLogfile": "EfsPotato_sysmon_17_18_privesc_seimpersonate_to_system.evtx",
      "PipeName": "\\dd4c18dc-bff6-42ce-b707-62c114b84291\\pipe\\srvsvc",
      "ProcessGuid": "00247C92-707C-6122-0000-0010EB030000",
      "ProcessID": 4760,
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SystemTime": "2021-08-22T19:33:38.884861Z",
      "Task": 18,
      "ThreadID": 6844,
      "UserID": "S-1-5-18",
      "UtcTime": "2021-08-22 19:33:38.884",
      "Version": 1
    }
  ]
},
{
  "title": "Whoami.EXE Execution Anomaly",
  "id": "8de1cbe8-d6f5-496d-8237-5f44a721c7a0",
  "description": "Detects the execution of whoami.exe with suspicious parent processes.",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND ((Image LIKE '%\\\\whoami.exe' ESCAPE '\\' OR OriginalFileName='whoami.exe') AND (NOT ((ParentImage LIKE '%\\\\cmd.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\powershell\\_ise.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\powershell.exe' ESCAPE '\\' OR ParentImage LIKE '%\\\\pwsh.exe' ESCAPE '\\') OR ParentImage IS NULL OR (ParentImage='' OR ParentImage='-'))) AND (NOT ParentImage LIKE '%:\\\\Program Files\\\\Microsoft Monitoring Agent\\\\Agent\\\\MonitoringHost.exe' ESCAPE '\\')))"
  ],
  "rule_level": "medium",
  "tags": [
    "attack.discovery",
    "attack.t1033",
    "car.2016-03-001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 5,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "whoami",
      "Company": "Microsoft Corporation",
      "Computer": "LAPTOP-JU4M3I0E",
      "CurrentDirectory": "C:\\WINDOWS\\system32\\",
      "Description": "whoami - displays logged on user information",
      "EventID": 1,
      "EventRecordID": 1912935,
      "FileVersion": "10.0.19041.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=1915FBFDB73FDD200C47880247ACDDE5442431A9,MD5=A4A6924F3EAF97981323703D38FD99C4,SHA256=1D4902A04D99E8CCBFE7085E63155955FEE397449D386453F6C452AE407B8743,IMPHASH=7FF0758B766F747CE57DFAC70743FB88",
      "IMPHASH": "7FF0758B766F747CE57DFAC70743FB88",
      "Image": "C:\\Windows\\System32\\whoami.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "00247C92-7087-6122-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "A4A6924F3EAF97981323703D38FD99C4",
      "Opcode": 0,
      "OriginalFileName": "whoami.exe",
      "OriginalLogfile": "EfsPotato_sysmon_17_18_privesc_seimpersonate_to_system.evtx",
      "ParentCommandLine": "c:\\temp\\EfsPotato.exe  whoami",
      "ParentImage": "C:\\temp\\EfsPotato.exe",
      "ParentProcessGuid": "00247C92-A691-6122-0000-001021C31F02",
      "ParentProcessId": 14048,
      "ProcessGuid": "00247C92-A692-6122-0000-0010A5CD1F02",
      "ProcessID": 4760,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "1915FBFDB73FDD200C47880247ACDDE5442431A9",
      "SHA256": "1D4902A04D99E8CCBFE7085E63155955FEE397449D386453F6C452AE407B8743",
      "SystemTime": "2021-08-22T19:33:38.905645Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 6844,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2021-08-22 19:33:38.890",
      "Version": 5
    }
  ]
},
{
  "title": "Local Accounts Discovery",
  "id": "502b42de-4306-40b4-9596-6f590c81f073",
  "description": "Local accounts, System Owner/User discovery using operating systems utilities",
  "sigmafile": "",
  "sigma": [
    "SELECT * FROM logs WHERE Channel='Microsoft-Windows-Sysmon/Operational' AND (EventID=1 AND (((Image LIKE '%\\\\cmd.exe' ESCAPE '\\' AND (CommandLine LIKE '% /c%' ESCAPE '\\' AND CommandLine LIKE '%dir %' ESCAPE '\\' AND CommandLine LIKE '%\\\\Users\\\\%' ESCAPE '\\')) AND (NOT CommandLine LIKE '% rmdir %' ESCAPE '\\')) OR (((Image LIKE '%\\\\net.exe' ESCAPE '\\' OR Image LIKE '%\\\\net1.exe' ESCAPE '\\') AND CommandLine LIKE '%user%' ESCAPE '\\') AND (NOT (CommandLine LIKE '%/domain%' ESCAPE '\\' OR CommandLine LIKE '%/add%' ESCAPE '\\' OR CommandLine LIKE '%/delete%' ESCAPE '\\' OR CommandLine LIKE '%/active%' ESCAPE '\\' OR CommandLine LIKE '%/expires%' ESCAPE '\\' OR CommandLine LIKE '%/passwordreq%' ESCAPE '\\' OR CommandLine LIKE '%/scriptpath%' ESCAPE '\\' OR CommandLine LIKE '%/times%' ESCAPE '\\' OR CommandLine LIKE '%/workstations%' ESCAPE '\\'))) OR (((Image LIKE '%\\\\whoami.exe' ESCAPE '\\' OR Image LIKE '%\\\\quser.exe' ESCAPE '\\' OR Image LIKE '%\\\\qwinsta.exe' ESCAPE '\\') OR (OriginalFileName='whoami.exe' OR OriginalFileName='quser.exe' OR OriginalFileName='qwinsta.exe')) OR (Image LIKE '%\\\\wmic.exe' ESCAPE '\\' AND (CommandLine LIKE '%useraccount%' ESCAPE '\\' AND CommandLine LIKE '%get%' ESCAPE '\\')) OR (Image LIKE '%\\\\cmdkey.exe' ESCAPE '\\' AND CommandLine LIKE '% /l%' ESCAPE '\\'))))"
  ],
  "rule_level": "low",
  "tags": [
    "attack.discovery",
    "attack.t1033",
    "attack.t1087.001"
  ],
  "count": 1,
  "matches": [
    {
      "row_id": 5,
      "Channel": "Microsoft-Windows-Sysmon/Operational",
      "CommandLine": "whoami",
      "Company": "Microsoft Corporation",
      "Computer": "LAPTOP-JU4M3I0E",
      "CurrentDirectory": "C:\\WINDOWS\\system32\\",
      "Description": "whoami - displays logged on user information",
      "EventID": 1,
      "EventRecordID": 1912935,
      "FileVersion": "10.0.19041.1 (WinBuild.160101.0800)",
      "Guid": "5770385F-C22A-43E0-BF4C-06F5698FFBD9",
      "Hashes": "SHA1=1915FBFDB73FDD200C47880247ACDDE5442431A9,MD5=A4A6924F3EAF97981323703D38FD99C4,SHA256=1D4902A04D99E8CCBFE7085E63155955FEE397449D386453F6C452AE407B8743,IMPHASH=7FF0758B766F747CE57DFAC70743FB88",
      "IMPHASH": "7FF0758B766F747CE57DFAC70743FB88",
      "Image": "C:\\Windows\\System32\\whoami.exe",
      "IntegrityLevel": "System",
      "Keywords": "0x8000000000000000",
      "Level": 4,
      "LogonGuid": "00247C92-7087-6122-0000-0020E7030000",
      "LogonId": "0x3e7",
      "MD5": "A4A6924F3EAF97981323703D38FD99C4",
      "Opcode": 0,
      "OriginalFileName": "whoami.exe",
      "OriginalLogfile": "EfsPotato_sysmon_17_18_privesc_seimpersonate_to_system.evtx",
      "ParentCommandLine": "c:\\temp\\EfsPotato.exe  whoami",
      "ParentImage": "C:\\temp\\EfsPotato.exe",
      "ParentProcessGuid": "00247C92-A691-6122-0000-001021C31F02",
      "ParentProcessId": 14048,
      "ProcessGuid": "00247C92-A692-6122-0000-0010A5CD1F02",
      "ProcessID": 4760,
      "Product": "Microsoft® Windows® Operating System",
      "Provider_Name": "Microsoft-Windows-Sysmon",
      "SHA1": "1915FBFDB73FDD200C47880247ACDDE5442431A9",
      "SHA256": "1D4902A04D99E8CCBFE7085E63155955FEE397449D386453F6C452AE407B8743",
      "SystemTime": "2021-08-22T19:33:38.905645Z",
      "Task": 1,
      "TerminalSessionId": 0,
      "ThreadID": 6844,
      "User": "NT AUTHORITY\\SYSTEM",
      "UserID": "S-1-5-18",
      "UtcTime": "2021-08-22 19:33:38.890",
      "Version": 5
    }
  ]
}]